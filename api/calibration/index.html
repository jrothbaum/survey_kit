
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../user-guide/statistics/">
      
      
        <link rel="next" href="../srmi/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Calibration - Survey-Kit</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#calibration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Survey-Kit" class="md-header__button md-logo" aria-label="Survey-Kit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Survey-Kit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Calibration
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jrothbaum/survey_kit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Survey-Kit" class="md-nav__button md-logo" aria-label="Survey-Kit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Survey-Kit
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jrothbaum/survey_kit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/calibration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Calibration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/srmi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Imputation/SRMI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/statistics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Statistics/Standard Errors
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Calibration
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Calibration
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#survey_kit.calibration.moment.Moment" class="md-nav__link">
    <span class="md-ellipsis">
      Moment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#survey_kit.calibration.calibration.Calibration" class="md-nav__link">
    <span class="md-ellipsis">
      Calibration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Calibration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#survey_kit.calibration.calibration.Calibration.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#survey_kit.calibration.calibration.Calibration.print_diagnostics" class="md-nav__link">
    <span class="md-ellipsis">
      print_diagnostics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#survey_kit.calibration.calibration.Calibration.get_final_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_final_weights
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#survey_kit.calibration.trim.Trim" class="md-nav__link">
    <span class="md-ellipsis">
      Trim
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../srmi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Imputation/SRMI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic_standard_errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Statistics/Standard Errors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiple_imputation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multiple Imputation Standard Errors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../miscellaneous/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Miscellaneous
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#survey_kit.calibration.moment.Moment" class="md-nav__link">
    <span class="md-ellipsis">
      Moment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#survey_kit.calibration.calibration.Calibration" class="md-nav__link">
    <span class="md-ellipsis">
      Calibration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Calibration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#survey_kit.calibration.calibration.Calibration.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#survey_kit.calibration.calibration.Calibration.print_diagnostics" class="md-nav__link">
    <span class="md-ellipsis">
      print_diagnostics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#survey_kit.calibration.calibration.Calibration.get_final_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_final_weights
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#survey_kit.calibration.trim.Trim" class="md-nav__link">
    <span class="md-ellipsis">
      Trim
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="calibration">Calibration<a class="headerlink" href="#calibration" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-class">



<h2 id="survey_kit.calibration.moment.Moment" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Moment</span>


<a href="#survey_kit.calibration.moment.Moment" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Serializable (survey_kit.serializable.Serializable)" href="../miscellaneous/#survey_kit.serializable.Serializable">Serializable</a></code></p>


        <p>Statistical moments for survey calibration.</p>
<p>A Moment represents target statistics (means, proportions) that survey
weights should be calibrated to match. Moments can be simple (e.g., overall mean)
interactions (i.e. share in a and b).  They can also be
stratified by groups, and can include submoments for more complex constraints.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="narwhals.typing.IntoFrameT">IntoFrameT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataframe containing the data.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>formula</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Formulaic formula specifying variables for the moment (e.g., "C(gender) + age").
Default is "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>weight</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for weights. If empty, uniform weights are created. Default is "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>index</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name(s) for unique observation identifiers. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sort_by</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name(s) to sort by when creating row index. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rescale</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to rescale model matrix by dividing by target values. This implies a
tradeoff between the tolerated miss (i.e. how close do we need to get
in the calibration) and the target of this moment. Default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>by</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | <span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Variables or formula to stratify moment by, creating submoments for each
i.e. if the formula is race and gender and by is state,
the moments would race x gender x state
group. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>missing_to_zero</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fill missing values with zero. Default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keep_full_group</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When using 'by', whether to keep the overall moment in addition to
submoments. Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>equalize_by</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weight submoments equally rather than by their sample proportions.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>equalize_by_obs_share</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weight submoments (within by) by their observation counts. Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>equalize_by_weight_share</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weight submoments (within by) by their weight sums. Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="survey_kit.calibration.moment.Moment.model_matrix">model_matrix</span></code></td>
            <td>
                  <code><span title="narwhals.typing.IntoFrameT">IntoFrameT</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Design matrix for calibration (X in the moment equations).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="survey_kit.calibration.moment.Moment.targets">targets</span></code></td>
            <td>
                  <code><span title="narwhals.typing.IntoFrameT">IntoFrameT</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target values to calibrate to.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="survey_kit.calibration.moment.Moment.non_zero">non_zero</span></code></td>
            <td>
                  <code><span title="narwhals.typing.IntoFrameT">IntoFrameT</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Count of non-zero observations for each moment variable.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="survey_kit.calibration.moment.Moment.sub_moments">sub_moments</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Moment (survey_kit.calibration.moment.Moment)" href="#survey_kit.calibration.moment.Moment">Moment</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of submoments when stratifying by groups.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="survey_kit.calibration.moment.Moment.columns">columns</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column names used in calibration after any restrictions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="survey_kit.calibration.moment.Moment.n_observations">n_observations</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of observations in this moment.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Simple moment for categorical variable:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.calibration.moment</span><span class="w"> </span><span class="kn">import</span> <span class="n">Moment</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="gp">&gt;&gt;&gt; </span><span class="p">})</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;C(gender)&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
</code></pre></div>
    <p>Moment with continuous and categorical variables:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;education&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;HS&quot;</span><span class="p">,</span> <span class="s2">&quot;College&quot;</span><span class="p">,</span> <span class="s2">&quot;Grad&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">33</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;HS&quot;</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt; </span><span class="p">})</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">(</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;age + C(education)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="gp">&gt;&gt;&gt; </span><span class="p">)</span>
</code></pre></div>
    <p>Stratified moment with subgroups:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">by</span><span class="o">=</span><span class="s2">&quot;C(education)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">equalize_by</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="gp">&gt;&gt;&gt; </span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># This creates separate age moments for each education level</span>
</code></pre></div>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>Formulas use the formulaic library syntax, with C() for categorical variables.</li>
<li>When using 'by' parameter, submoments are automatically created for each group.</li>
<li>The rescale option divides model matrix values by targets, which can improve
convergence but changes the interpretation of calibration parameters.</li>
<li>Submoments allow for complex calibration schemes like raking or post-stratification.</li>
</ul>
</details>







              <details class="quote">
                <summary>Source code in <code>src\survey_kit\calibration\moment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">Moment</span><span class="p">(</span><span class="n">Serializable</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    Statistical moments for survey calibration.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    A Moment represents target statistics (means, proportions) that survey</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    weights should be calibrated to match. Moments can be simple (e.g., overall mean)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    interactions (i.e. share in a and b).  They can also be</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    stratified by groups, and can include submoments for more complex constraints.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    df : IntoFrameT</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Dataframe containing the data.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    formula : str, optional</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        Formulaic formula specifying variables for the moment (e.g., &quot;C(gender) + age&quot;).</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        Default is &quot;&quot;.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    weight : str, optional</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        Column name for weights. If empty, uniform weights are created. Default is &quot;&quot;.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    index : str | list[str] | None, optional</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        Column name(s) for unique observation identifiers. Default is None.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    sort_by : str | list[str] | None, optional</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        Column name(s) to sort by when creating row index. Default is None.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    rescale : bool, optional</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        Whether to rescale model matrix by dividing by target values. This implies a</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        tradeoff between the tolerated miss (i.e. how close do we need to get</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        in the calibration) and the target of this moment. Default is True.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    by : list[str] | str | None, optional</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        Variables or formula to stratify moment by, creating submoments for each</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        i.e. if the formula is race and gender and by is state,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        the moments would race x gender x state</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        group. Default is None.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    missing_to_zero : bool, optional</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        Fill missing values with zero. Default is True.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    keep_full_group : bool, optional</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        When using &#39;by&#39;, whether to keep the overall moment in addition to</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        submoments. Default is False.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    equalize_by : bool, optional</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        Weight submoments equally rather than by their sample proportions.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        Default is False.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    equalize_by_obs_share : bool, optional</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        Weight submoments (within by) by their observation counts. Default is False.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    equalize_by_weight_share : bool, optional</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        Weight submoments (within by) by their weight sums. Default is False.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    Attributes</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    model_matrix : IntoFrameT | None</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        Design matrix for calibration (X in the moment equations).</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    targets : IntoFrameT | None</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        Target values to calibrate to.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    non_zero : IntoFrameT | None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        Count of non-zero observations for each moment variable.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    sub_moments : list[Moment]</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        List of submoments when stratifying by groups.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    columns : list[str]</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        Column names used in calibration after any restrictions.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    n_observations : int</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        Number of observations in this moment.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    Examples</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">    --------</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">    Simple moment for categorical variable:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    &gt;&gt;&gt; import polars as pl</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">    &gt;&gt;&gt; from survey_kit.calibration.moment import Moment</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    &gt;&gt;&gt;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    &gt;&gt;&gt; df = pl.DataFrame({</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">    &gt;&gt;&gt;     &quot;id&quot;: range(100),</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    &gt;&gt;&gt;     &quot;gender&quot;: [&quot;M&quot;, &quot;F&quot;] * 50,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    &gt;&gt;&gt;     &quot;weight&quot;: [1.0] * 100</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    &gt;&gt;&gt; })</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    &gt;&gt;&gt;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    &gt;&gt;&gt; moment = Moment(df=df, formula=&quot;C(gender)&quot;, weight=&quot;weight&quot;)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    Moment with continuous and categorical variables:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    &gt;&gt;&gt; df = pl.DataFrame({</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    &gt;&gt;&gt;     &quot;id&quot;: range(100),</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">    &gt;&gt;&gt;     &quot;age&quot;: range(20, 120),</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    &gt;&gt;&gt;     &quot;education&quot;: [&quot;HS&quot;, &quot;College&quot;, &quot;Grad&quot;] * 33 + [&quot;HS&quot;],</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">    &gt;&gt;&gt;     &quot;weight&quot;: [1.0] * 100</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    &gt;&gt;&gt; })</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">    &gt;&gt;&gt;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    &gt;&gt;&gt; moment = Moment(</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    &gt;&gt;&gt;     df=df,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">    &gt;&gt;&gt;     formula=&quot;age + C(education)&quot;,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    &gt;&gt;&gt;     weight=&quot;weight&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    &gt;&gt;&gt; )</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    Stratified moment with subgroups:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">    &gt;&gt;&gt; moment = Moment(</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    &gt;&gt;&gt;     df=df,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">    &gt;&gt;&gt;     formula=&quot;age&quot;,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">    &gt;&gt;&gt;     by=&quot;C(education)&quot;,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    &gt;&gt;&gt;     weight=&quot;weight&quot;,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    &gt;&gt;&gt;     equalize_by=True</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    &gt;&gt;&gt; )</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    &gt;&gt;&gt; # This creates separate age moments for each education level</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    -----</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    - Formulas use the formulaic library syntax, with C() for categorical variables.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    - When using &#39;by&#39; parameter, submoments are automatically created for each group.</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    - The rescale option divides model matrix values by targets, which can improve</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    convergence but changes the interpretation of calibration parameters.</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    - Submoments allow for complex calibration schemes like raking or post-stratification.</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="n">_save_suffix</span> <span class="o">=</span> <span class="s2">&quot;moment&quot;</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">_save_exclude_items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nw_type&quot;</span><span class="p">]</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="n">df</span><span class="p">:</span> <span class="n">IntoFrameT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">nw_type</span><span class="p">:</span> <span class="n">NarwhalsType</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">weight</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">index</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">sort_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">rescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">missing_to_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">keep_full_group</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">equalize_by</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">equalize_by_obs_share</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">equalize_by_weight_share</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">by_share</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">target_moment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">is_sub_moment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">initial_processing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="p">):</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">if</span> <span class="n">missing_to_zero</span> <span class="ow">and</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">fill_missing</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">list_input</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span> <span class="o">=</span> <span class="n">rescale</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="k">if</span> <span class="n">by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="n">by</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">by</span> <span class="o">=</span> <span class="n">by</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">equalize_by</span> <span class="o">=</span> <span class="n">equalize_by</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">equalize_by_obs_share</span> <span class="o">=</span> <span class="n">equalize_by_obs_share</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">equalize_by_weight_share</span> <span class="o">=</span> <span class="n">equalize_by_weight_share</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keep_full_group</span> <span class="o">=</span> <span class="n">keep_full_group</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="c1"># Derived variables</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="c1">#   Any sub_moments of this?</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sub_moments</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="c1">#   Processed By into a list of where statements</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">by_where_expressions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">by_where_strings</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="c1"># By group adjustment to weights (i.e. this group&#39;s share of the total weight)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">by_share</span> <span class="o">=</span> <span class="n">by_share</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="c1"># List of variables used in by</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">byvars</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="c1"># Columns to use in calibration</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="c1">#   All, until restricted for full rank or minimum observation restrictions</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="c1"># Final model matrix for weighting</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="c1"># Vector of derived moment scale factors</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="c1"># Vector of target values</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="c1"># Vector of non-zero counts</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">non_zero</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="c1"># When weighting, carry the zero count of the target, too</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_target</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="c1"># Has the rank already been checked on this?</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rank_checked</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="c1"># Number of observations</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_observations</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="c1"># When weighting, placeholder for target nObs</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_observations_target</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">nw_type</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="c1">#   Only do the processing, if data is passed in</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="c1"># Add an index, if there isn&#39;t one</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="c1">#   We need one to be able to put the file back together again</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="n">sort_by</span> <span class="o">=</span> <span class="n">list_input</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                    <span class="n">sort_by</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                        <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                        <span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                        <span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                    <span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;___rownumber&quot;</span><span class="p">]</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                    <span class="o">.</span><span class="n">with_row_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">order_by</span><span class="o">=</span><span class="n">sort_by</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                <span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="c1">#   Weights</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="s2">&quot;___ones&quot;</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">))</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                <span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="c1">#   Are there by groups that generate subgroup moments?</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">by</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">byvars</span> <span class="o">=</span> <span class="n">FormulaBuilder</span><span class="o">.</span><span class="n">columns_from_formula</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">byvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sub_moment</span> <span class="ow">and</span> <span class="n">initial_processing</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">initialize_moment</span><span class="p">(</span><span class="n">target_moment</span><span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_moment</span><span class="p">(</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="c1"># Is this a target moment (i.e. a list of moment constraints)?</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="n">target_moment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="p">):</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="c1"># Start the list of vars to keep with the vars in the formula</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="n">keepvars</span> <span class="o">=</span> <span class="n">FormulaBuilder</span><span class="o">.</span><span class="n">columns_from_formula</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="n">keepvars</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="n">keepvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">keepvars</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">byvars</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="c1">#   Restrict to the relevant observations and variables, as needed</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">keepvars</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="c1">#   Do we need to calculate targets?</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="k">if</span> <span class="n">target_moment</span><span class="p">:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_by_wheres</span><span class="p">()</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_matrix</span><span class="p">()</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_targets</span><span class="p">()</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_create_sub_moments</span><span class="p">()</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_by_wheres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="n">f_by</span> <span class="o">=</span> <span class="n">FormulaBuilder</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">f_by</span><span class="o">.</span><span class="n">remove_constant</span><span class="p">()</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">by</span> <span class="o">=</span> <span class="n">f_by</span><span class="o">.</span><span class="n">formula</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="n">df_by</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="n">formulaic</span><span class="o">.</span><span class="n">Formula</span><span class="p">(</span><span class="n">f_by</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span><span class="o">.</span><span class="n">get_model_matrix</span><span class="p">(</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                <span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">):</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                <span class="n">df_by</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                <span class="c1">#   No by</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                <span class="k">return</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="c1">#   For interactions, get the unique values of the variables</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="n">interactioncols</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="n">coli</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="k">for</span> <span class="n">coli</span> <span class="ow">in</span> <span class="n">df_by</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="k">if</span> <span class="n">coli</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="p">]</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interactioncols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="k">for</span> <span class="n">interi</span> <span class="ow">in</span> <span class="n">interactioncols</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                <span class="n">subcols</span> <span class="o">=</span> <span class="n">interi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                <span class="n">df_inter</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                    <span class="n">df_by</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">subcols</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                    <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">subcols</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                    <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                <span class="p">)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rowi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_inter</span><span class="o">.</span><span class="n">rows</span><span class="p">()):</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_full_group</span><span class="p">:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                        <span class="n">wherei</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">coli</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subcols</span><span class="p">):</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                            <span class="n">condi</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span> <span class="o">==</span> <span class="n">rowi</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                            <span class="n">stringi</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coli</span><span class="si">}</span><span class="s2">==</span><span class="si">{</span><span class="n">rowi</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                            <span class="k">if</span> <span class="n">wherei</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                                <span class="n">wherei</span> <span class="o">=</span> <span class="n">condi</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                                <span class="n">wherei_string</span> <span class="o">=</span> <span class="n">stringi</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                                <span class="n">wherei</span> <span class="o">=</span> <span class="n">wherei</span> <span class="o">&amp;</span> <span class="n">condi</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                                <span class="n">wherei_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">stringi</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">by_where_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wherei</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">by_where_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wherei_string</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="c1">#   Now drop the interactions and the sub-items</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>            <span class="n">droplist</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="k">for</span> <span class="n">interi</span> <span class="ow">in</span> <span class="n">interactioncols</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                <span class="n">subcols</span> <span class="o">=</span> <span class="n">interi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                <span class="n">droplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interi</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                <span class="n">droplist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subcols</span><span class="p">)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="n">df_by</span> <span class="o">=</span> <span class="n">df_by</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">droplist</span><span class="p">)))</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="c1">#   Any non-interacted columns (remaining?)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="k">for</span> <span class="n">coli</span> <span class="ow">in</span> <span class="n">df_by</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="n">df_inter</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                <span class="n">df_by</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="k">for</span> <span class="n">rowi</span> <span class="ow">in</span> <span class="n">df_inter</span><span class="o">.</span><span class="n">rows</span><span class="p">():</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                <span class="n">condi</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span> <span class="o">==</span> <span class="n">rowi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                <span class="n">stringi</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coli</span><span class="si">}</span><span class="s2">==</span><span class="si">{</span><span class="n">rowi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">by_where_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condi</span><span class="p">)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">by_where_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stringi</span><span class="p">)</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_model_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">fb</span> <span class="o">=</span> <span class="n">FormulaBuilder</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="n">fb</span><span class="o">.</span><span class="n">remove_constant</span><span class="p">()</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="n">model_matrix</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="n">formulaic</span><span class="o">.</span><span class="n">Formula</span><span class="p">(</span><span class="n">fb</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span><span class="o">.</span><span class="n">get_model_matrix</span><span class="p">(</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="c1">#   The dataframe only needs the weights and the index, now</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="n">keep_df</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">]</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">keep_df</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="n">keep_df</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">byvars</span><span class="p">)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">keep_df</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="c1">#   Append the index to the model matrix, so we can link to it</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="n">concat_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>                <span class="p">[</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>                    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                    <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>                    <span class="o">.</span><span class="n">collect</span><span class="p">(),</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">model_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(),</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                <span class="p">],</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="p">)</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">non_zero_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="n">col_df</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">]</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="n">col_df</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="n">df_targets</span> <span class="o">=</span> <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">,</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col_df</span><span class="p">),</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">non_zero_only</span><span class="p">:</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="c1">#   Get the targets themselves</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="n">summary_mean</span> <span class="o">=</span> <span class="n">column_stats_builder</span><span class="p">(</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">,</span> <span class="n">cols_exclude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>            <span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                    <span class="n">calculate_by</span><span class="p">(</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                        <span class="n">df</span><span class="o">=</span><span class="n">df_targets</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                        <span class="n">column_stats</span><span class="o">=</span><span class="n">summary_mean</span><span class="p">,</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                        <span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                        <span class="n">no_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                    <span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                <span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_share</span><span class="p">)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="p">)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="c1">#   How many values are non-zero?</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>        <span class="n">summary_nonzero</span> <span class="o">=</span> <span class="n">column_stats_builder</span><span class="p">(</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">,</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="n">cols_include</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="n">cols_exclude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;rawcount_not0&quot;</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">non_zero</span> <span class="o">=</span> <span class="n">calculate_by</span><span class="p">(</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>            <span class="n">df</span><span class="o">=</span><span class="n">df_targets</span><span class="p">,</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>            <span class="n">column_stats</span><span class="o">=</span><span class="n">summary_nonzero</span><span class="p">,</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>            <span class="n">no_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>        <span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rescale_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>            <span class="n">cols_scale</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="n">cols_targets</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="n">targets</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="k">for</span> <span class="n">coli</span> <span class="ow">in</span> <span class="n">targets</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>                <span class="n">cols_scale</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">coli</span><span class="p">))</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>                <span class="n">cols_targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">coli</span><span class="p">))</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">cols_scale</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">cols_targets</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_sub_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by_where_expressions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>            <span class="c1"># Need the ratio of by group weights to overall weights</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equalize_by</span><span class="p">:</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equalize_by_obs_share</span><span class="p">:</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>                    <span class="n">total_obs</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                <span class="c1">#   We need to get or load the full group targets for the subgroup, if we want to equalize them</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>                    <span class="c1"># Get the targets of the parent moment without affecting the actual object (self)</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>                    <span class="n">m_targets_only</span> <span class="o">=</span> <span class="n">deepcopy_with_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>                    <span class="n">m_targets_only</span><span class="o">.</span><span class="n">_get_model_matrix</span><span class="p">()</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                    <span class="n">m_targets_only</span><span class="o">.</span><span class="n">_get_targets</span><span class="p">()</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                    <span class="n">targets_equalize</span> <span class="o">=</span> <span class="n">m_targets_only</span><span class="o">.</span><span class="n">targets</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>                    <span class="k">del</span> <span class="n">m_targets_only</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>                    <span class="n">targets_equalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="c1">#   Make sure the weight sums do not overflow</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">safe_sum_cast</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">])</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>        <span class="n">total_weight</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>            <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>            <span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="p">)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>        <span class="c1">#   Don&#39;t recreate the model matrix/df, if we don&#39;t have to</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>            <span class="n">bykeep</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>            <span class="n">bykeep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>            <span class="n">bykeep</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>            <span class="n">bykeep</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">byvars</span><span class="p">)</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="n">df_by</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">bykeep</span><span class="p">)</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>            <span class="n">df_by</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="k">for</span> <span class="n">i_by</span><span class="p">,</span> <span class="n">byi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by_where_expressions</span><span class="p">):</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>            <span class="n">df_byi</span> <span class="o">=</span> <span class="n">df_by</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">byi</span><span class="p">)</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>            <span class="n">group_weight</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>                <span class="n">df_byi</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>                <span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>            <span class="p">)</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>            <span class="c1">#  What is the share of the weight that should go to the</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>            <span class="c1">#      group identified by this byi</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equalize_by</span><span class="p">:</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equalize_by_obs_share</span><span class="p">:</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                    <span class="n">group_obs</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span><span class="n">df_byi</span><span class="p">)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>                    <span class="n">by_share</span> <span class="o">=</span> <span class="n">group_obs</span> <span class="o">/</span> <span class="n">total_obs</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">equalize_by_weight_share</span><span class="p">:</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                    <span class="n">by_share</span> <span class="o">=</span> <span class="n">group_weight</span> <span class="o">/</span> <span class="n">total_weight</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>                    <span class="n">by_share</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by_where_expressions</span><span class="p">)</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>                <span class="n">by_share</span> <span class="o">=</span> <span class="n">group_weight</span> <span class="o">/</span> <span class="n">total_weight</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>            <span class="n">sub_moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">(</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                <span class="n">df</span><span class="o">=</span><span class="n">df_byi</span><span class="p">,</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                <span class="n">nw_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">,</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                <span class="n">formula</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                <span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>                <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>                <span class="n">rescale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rescale</span><span class="p">,</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>                <span class="n">by_share</span><span class="o">=</span><span class="n">by_share</span><span class="p">,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>                <span class="n">is_sub_moment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>            <span class="p">)</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="c1">#  Get the model matrix by subsetting the parent model matrix</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>            <span class="n">sub_moment</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">sub_moment</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sub_moment</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">,</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>            <span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>            <span class="n">sub_moment</span><span class="o">.</span><span class="n">_get_targets</span><span class="p">(</span><span class="n">non_zero_only</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">equalize_by</span><span class="p">)</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equalize_by</span><span class="p">:</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>                <span class="n">sub_moment</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">targets_equalize</span><span class="p">)</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>                    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">*</span> <span class="n">by_share</span><span class="p">)</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>                <span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>            <span class="n">sub_moment</span><span class="o">.</span><span class="n">by_where_expressions</span> <span class="o">=</span> <span class="p">[</span><span class="n">byi</span><span class="p">]</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>            <span class="n">sub_moment</span><span class="o">.</span><span class="n">by_where_strings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">by_where_strings</span><span class="p">[</span><span class="n">i_by</span><span class="p">]]</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sub_moments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_moment</span><span class="p">)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by_where_expressions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>            <span class="c1">#   No sub_moments</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n_observations</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="c1">#   Rescale the Target moments, if necessary</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_rescale_targets</span><span class="p">()</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="k">for</span> <span class="n">subi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">:</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>            <span class="n">subi</span><span class="o">.</span><span class="n">_rescale_targets</span><span class="p">()</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>        <span class="c1">#   Don&#39;t need df or model_matrix anymore</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>        <span class="k">for</span> <span class="n">subi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">:</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>            <span class="n">subi</span><span class="o">.</span><span class="n">n_observations</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span><span class="n">subi</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>            <span class="n">subi</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>            <span class="n">subi</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>        <span class="c1">#   Get rid of the other dataframes if this isn&#39;t going to be</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>        <span class="c1">#       used as a moment to match to</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">by_where_expressions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_full_group</span><span class="p">:</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">non_zero</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rescaled_model_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">narrow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="k">if</span> <span class="n">narrow</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>            <span class="c1">#   Only pass the subset of columns</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>            <span class="n">df_out</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>            <span class="n">df_out</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>            <span class="n">with_columns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>            <span class="n">cols_main</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_out</span><span class="p">)</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                <span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                <span class="o">.</span><span class="n">names</span><span class="p">()</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>            <span class="p">)</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>            <span class="n">cols_scale</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                <span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>                <span class="o">.</span><span class="n">names</span><span class="p">()</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>            <span class="p">)</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>            <span class="k">for</span> <span class="n">coli</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols_main</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">cols_scale</span><span class="p">):</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>                <span class="k">if</span> <span class="n">coli</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                    <span class="c1">#   Get the scale adjustment from self.scale</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>                    <span class="n">valuei</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>                        <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>                        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>                        <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>                        <span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>                    <span class="p">)</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>                    <span class="n">with_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span> <span class="o">*</span> <span class="n">valuei</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">coli</span><span class="p">))</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>            <span class="n">df_out</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_out</span><span class="p">)</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>                <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">with_columns</span><span class="p">)</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>            <span class="p">)</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="k">return</span> <span class="n">df_out</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>    <span class="c1">#####################################################</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>    <span class="c1">#   Serializable - BEGIN</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>    <span class="c1">#####################################################</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_init_from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_init_from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">initial_processing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>        <span class="bp">cls</span><span class="p">,</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>        <span class="n">delete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>        <span class="n">delete_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="o">**</span><span class="n">df_kwargs</span><span class="p">,</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Moment</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="n">delete</span><span class="p">,</span> <span class="n">delete_only</span><span class="o">=</span><span class="n">delete_only</span><span class="p">,</span> <span class="o">**</span><span class="n">df_kwargs</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="survey_kit.calibration.calibration.Calibration" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Calibration</span>


<a href="#survey_kit.calibration.calibration.Calibration" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Serializable (survey_kit.serializable.Serializable)" href="../miscellaneous/#survey_kit.serializable.Serializable">Serializable</a></code></p>


        <p>Survey calibration using entropy balancing methods.</p>
<p>Calibration adjusts survey weights to match known population moments (targets) while
minimizing the distance from base weights.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="narwhals.typing.IntoFrameT">IntoFrameT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dataframe containing the survey data to be calibrated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>moments</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Moment (survey_kit.calibration.moment.Moment)" href="#survey_kit.calibration.moment.Moment">Moment</a> | <span title="str">str</span>] | <a class="autorefs autorefs-internal" title="Moment (survey_kit.calibration.moment.Moment)" href="#survey_kit.calibration.moment.Moment">Moment</a> | <span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Moment objects or paths to saved moments defining calibration targets.
Can be a single Moment, list of Moments, or paths to saved Moment files.
Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>missing_to_zero</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to fill missing values with zero before calibration. Default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>index</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column names to use as unique identifiers for observations. If None,
a row number index will be created. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>weight</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name containing base weights. If empty string, uniform weights
of 1 will be created. Default is "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>initial_guess</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for initial weight guesses to improve convergence. Default is "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>final_weight</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column name for output calibrated weights. If empty, defaults to
"___final_weight". Default is "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>aggregation</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to combine multiple moments: "Combined" (all at once), "Sequential"
(one at a time), or "Both" (sequential first, then combined if needed).
Default is "Combined".</p>
              </div>
            </td>
            <td>
                  <code>&#39;Combined&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>iterations</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of iterations for calibration algorithm. If -1, uses
method-specific defaults (50 for aebw, 250 for legacy_ebw). Default is -1.</p>
              </div>
            </td>
            <td>
                  <code>-1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>iterations_loop</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of loops for sequential/trimmed calibration. Default is 20.</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Convergence tolerance for maximum difference between targets and estimates.
Default is 0.00001.</p>
              </div>
            </td>
            <td>
                  <code>1e-05</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="survey_kit.calibration.calibration.Calibration.df">df</span></code></td>
            <td>
                  <code><span title="narwhals.typing.IntoFrameT">IntoFrameT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataframe with calibrated weights in the final_weight column.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="survey_kit.calibration.calibration.Calibration.moments">moments</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Moment (survey_kit.calibration.moment.Moment)" href="#survey_kit.calibration.moment.Moment">Moment</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Moment objects used for calibration.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="survey_kit.calibration.calibration.Calibration.diagnostics_out">diagnostics_out</span></code></td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing convergence status and diagnostic dataframe after
running calibration.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic calibration to match population totals:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">Calibration</span><span class="p">,</span> <span class="n">Moment</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create sample data</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;age_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;18-34&quot;</span><span class="p">,</span> <span class="s2">&quot;35-54&quot;</span><span class="p">,</span> <span class="s2">&quot;55+&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">33</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;18-34&quot;</span><span class="p">],</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">,</span> <span class="s2">&quot;South&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;base_weight&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="gp">&gt;&gt;&gt; </span><span class="p">})</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Define target moments</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">age_moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;C(age_group)&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;base_weight&quot;</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Run calibration</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Calibration</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="n">age_moment</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;base_weight&quot;</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="gp">&gt;&gt;&gt;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Get the calibrated weights (appended to the original data)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">calibrated_df</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_final_weights</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>
    <p>Multiple moments with sequential calibration:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">region_moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;C(region)&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;base_weight&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Calibration</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="n">age_moment</span><span class="p">,</span> <span class="n">region_moment</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">aggregation</span><span class="o">=</span><span class="s2">&quot;Sequential&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;base_weight&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="gp">&gt;&gt;&gt; </span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">min_obs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>
    <p>With weight trimming:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.calibration.trim</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trim</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">trim_params</span> <span class="o">=</span> <span class="n">Trim</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="n">trim_params</span><span class="p">,</span> <span class="n">min_obs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
</code></pre></div>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>The calibration preserves the total sum of weights while adjusting individual
weight values to match target moments.</li>
<li>Sequential aggregation calibrates to each moment one at a time, while combined
aggregation solves for all moments simultaneously.</li>
<li>The "Both" aggregation tries sequential first and falls back to combined if
convergence criteria aren't met.</li>
<li>Use min_obs parameter to exclude moments with too few non-zero observations,
which can cause convergence issues.</li>
</ul>
</details>







              <details class="quote">
                <summary>Source code in <code>src\survey_kit\calibration\calibration.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-46">  46</a></span>
<span class="normal"><a href="#__codelineno-0-47">  47</a></span>
<span class="normal"><a href="#__codelineno-0-48">  48</a></span>
<span class="normal"><a href="#__codelineno-0-49">  49</a></span>
<span class="normal"><a href="#__codelineno-0-50">  50</a></span>
<span class="normal"><a href="#__codelineno-0-51">  51</a></span>
<span class="normal"><a href="#__codelineno-0-52">  52</a></span>
<span class="normal"><a href="#__codelineno-0-53">  53</a></span>
<span class="normal"><a href="#__codelineno-0-54">  54</a></span>
<span class="normal"><a href="#__codelineno-0-55">  55</a></span>
<span class="normal"><a href="#__codelineno-0-56">  56</a></span>
<span class="normal"><a href="#__codelineno-0-57">  57</a></span>
<span class="normal"><a href="#__codelineno-0-58">  58</a></span>
<span class="normal"><a href="#__codelineno-0-59">  59</a></span>
<span class="normal"><a href="#__codelineno-0-60">  60</a></span>
<span class="normal"><a href="#__codelineno-0-61">  61</a></span>
<span class="normal"><a href="#__codelineno-0-62">  62</a></span>
<span class="normal"><a href="#__codelineno-0-63">  63</a></span>
<span class="normal"><a href="#__codelineno-0-64">  64</a></span>
<span class="normal"><a href="#__codelineno-0-65">  65</a></span>
<span class="normal"><a href="#__codelineno-0-66">  66</a></span>
<span class="normal"><a href="#__codelineno-0-67">  67</a></span>
<span class="normal"><a href="#__codelineno-0-68">  68</a></span>
<span class="normal"><a href="#__codelineno-0-69">  69</a></span>
<span class="normal"><a href="#__codelineno-0-70">  70</a></span>
<span class="normal"><a href="#__codelineno-0-71">  71</a></span>
<span class="normal"><a href="#__codelineno-0-72">  72</a></span>
<span class="normal"><a href="#__codelineno-0-73">  73</a></span>
<span class="normal"><a href="#__codelineno-0-74">  74</a></span>
<span class="normal"><a href="#__codelineno-0-75">  75</a></span>
<span class="normal"><a href="#__codelineno-0-76">  76</a></span>
<span class="normal"><a href="#__codelineno-0-77">  77</a></span>
<span class="normal"><a href="#__codelineno-0-78">  78</a></span>
<span class="normal"><a href="#__codelineno-0-79">  79</a></span>
<span class="normal"><a href="#__codelineno-0-80">  80</a></span>
<span class="normal"><a href="#__codelineno-0-81">  81</a></span>
<span class="normal"><a href="#__codelineno-0-82">  82</a></span>
<span class="normal"><a href="#__codelineno-0-83">  83</a></span>
<span class="normal"><a href="#__codelineno-0-84">  84</a></span>
<span class="normal"><a href="#__codelineno-0-85">  85</a></span>
<span class="normal"><a href="#__codelineno-0-86">  86</a></span>
<span class="normal"><a href="#__codelineno-0-87">  87</a></span>
<span class="normal"><a href="#__codelineno-0-88">  88</a></span>
<span class="normal"><a href="#__codelineno-0-89">  89</a></span>
<span class="normal"><a href="#__codelineno-0-90">  90</a></span>
<span class="normal"><a href="#__codelineno-0-91">  91</a></span>
<span class="normal"><a href="#__codelineno-0-92">  92</a></span>
<span class="normal"><a href="#__codelineno-0-93">  93</a></span>
<span class="normal"><a href="#__codelineno-0-94">  94</a></span>
<span class="normal"><a href="#__codelineno-0-95">  95</a></span>
<span class="normal"><a href="#__codelineno-0-96">  96</a></span>
<span class="normal"><a href="#__codelineno-0-97">  97</a></span>
<span class="normal"><a href="#__codelineno-0-98">  98</a></span>
<span class="normal"><a href="#__codelineno-0-99">  99</a></span>
<span class="normal"><a href="#__codelineno-0-100"> 100</a></span>
<span class="normal"><a href="#__codelineno-0-101"> 101</a></span>
<span class="normal"><a href="#__codelineno-0-102"> 102</a></span>
<span class="normal"><a href="#__codelineno-0-103"> 103</a></span>
<span class="normal"><a href="#__codelineno-0-104"> 104</a></span>
<span class="normal"><a href="#__codelineno-0-105"> 105</a></span>
<span class="normal"><a href="#__codelineno-0-106"> 106</a></span>
<span class="normal"><a href="#__codelineno-0-107"> 107</a></span>
<span class="normal"><a href="#__codelineno-0-108"> 108</a></span>
<span class="normal"><a href="#__codelineno-0-109"> 109</a></span>
<span class="normal"><a href="#__codelineno-0-110"> 110</a></span>
<span class="normal"><a href="#__codelineno-0-111"> 111</a></span>
<span class="normal"><a href="#__codelineno-0-112"> 112</a></span>
<span class="normal"><a href="#__codelineno-0-113"> 113</a></span>
<span class="normal"><a href="#__codelineno-0-114"> 114</a></span>
<span class="normal"><a href="#__codelineno-0-115"> 115</a></span>
<span class="normal"><a href="#__codelineno-0-116"> 116</a></span>
<span class="normal"><a href="#__codelineno-0-117"> 117</a></span>
<span class="normal"><a href="#__codelineno-0-118"> 118</a></span>
<span class="normal"><a href="#__codelineno-0-119"> 119</a></span>
<span class="normal"><a href="#__codelineno-0-120"> 120</a></span>
<span class="normal"><a href="#__codelineno-0-121"> 121</a></span>
<span class="normal"><a href="#__codelineno-0-122"> 122</a></span>
<span class="normal"><a href="#__codelineno-0-123"> 123</a></span>
<span class="normal"><a href="#__codelineno-0-124"> 124</a></span>
<span class="normal"><a href="#__codelineno-0-125"> 125</a></span>
<span class="normal"><a href="#__codelineno-0-126"> 126</a></span>
<span class="normal"><a href="#__codelineno-0-127"> 127</a></span>
<span class="normal"><a href="#__codelineno-0-128"> 128</a></span>
<span class="normal"><a href="#__codelineno-0-129"> 129</a></span>
<span class="normal"><a href="#__codelineno-0-130"> 130</a></span>
<span class="normal"><a href="#__codelineno-0-131"> 131</a></span>
<span class="normal"><a href="#__codelineno-0-132"> 132</a></span>
<span class="normal"><a href="#__codelineno-0-133"> 133</a></span>
<span class="normal"><a href="#__codelineno-0-134"> 134</a></span>
<span class="normal"><a href="#__codelineno-0-135"> 135</a></span>
<span class="normal"><a href="#__codelineno-0-136"> 136</a></span>
<span class="normal"><a href="#__codelineno-0-137"> 137</a></span>
<span class="normal"><a href="#__codelineno-0-138"> 138</a></span>
<span class="normal"><a href="#__codelineno-0-139"> 139</a></span>
<span class="normal"><a href="#__codelineno-0-140"> 140</a></span>
<span class="normal"><a href="#__codelineno-0-141"> 141</a></span>
<span class="normal"><a href="#__codelineno-0-142"> 142</a></span>
<span class="normal"><a href="#__codelineno-0-143"> 143</a></span>
<span class="normal"><a href="#__codelineno-0-144"> 144</a></span>
<span class="normal"><a href="#__codelineno-0-145"> 145</a></span>
<span class="normal"><a href="#__codelineno-0-146"> 146</a></span>
<span class="normal"><a href="#__codelineno-0-147"> 147</a></span>
<span class="normal"><a href="#__codelineno-0-148"> 148</a></span>
<span class="normal"><a href="#__codelineno-0-149"> 149</a></span>
<span class="normal"><a href="#__codelineno-0-150"> 150</a></span>
<span class="normal"><a href="#__codelineno-0-151"> 151</a></span>
<span class="normal"><a href="#__codelineno-0-152"> 152</a></span>
<span class="normal"><a href="#__codelineno-0-153"> 153</a></span>
<span class="normal"><a href="#__codelineno-0-154"> 154</a></span>
<span class="normal"><a href="#__codelineno-0-155"> 155</a></span>
<span class="normal"><a href="#__codelineno-0-156"> 156</a></span>
<span class="normal"><a href="#__codelineno-0-157"> 157</a></span>
<span class="normal"><a href="#__codelineno-0-158"> 158</a></span>
<span class="normal"><a href="#__codelineno-0-159"> 159</a></span>
<span class="normal"><a href="#__codelineno-0-160"> 160</a></span>
<span class="normal"><a href="#__codelineno-0-161"> 161</a></span>
<span class="normal"><a href="#__codelineno-0-162"> 162</a></span>
<span class="normal"><a href="#__codelineno-0-163"> 163</a></span>
<span class="normal"><a href="#__codelineno-0-164"> 164</a></span>
<span class="normal"><a href="#__codelineno-0-165"> 165</a></span>
<span class="normal"><a href="#__codelineno-0-166"> 166</a></span>
<span class="normal"><a href="#__codelineno-0-167"> 167</a></span>
<span class="normal"><a href="#__codelineno-0-168"> 168</a></span>
<span class="normal"><a href="#__codelineno-0-169"> 169</a></span>
<span class="normal"><a href="#__codelineno-0-170"> 170</a></span>
<span class="normal"><a href="#__codelineno-0-171"> 171</a></span>
<span class="normal"><a href="#__codelineno-0-172"> 172</a></span>
<span class="normal"><a href="#__codelineno-0-173"> 173</a></span>
<span class="normal"><a href="#__codelineno-0-174"> 174</a></span>
<span class="normal"><a href="#__codelineno-0-175"> 175</a></span>
<span class="normal"><a href="#__codelineno-0-176"> 176</a></span>
<span class="normal"><a href="#__codelineno-0-177"> 177</a></span>
<span class="normal"><a href="#__codelineno-0-178"> 178</a></span>
<span class="normal"><a href="#__codelineno-0-179"> 179</a></span>
<span class="normal"><a href="#__codelineno-0-180"> 180</a></span>
<span class="normal"><a href="#__codelineno-0-181"> 181</a></span>
<span class="normal"><a href="#__codelineno-0-182"> 182</a></span>
<span class="normal"><a href="#__codelineno-0-183"> 183</a></span>
<span class="normal"><a href="#__codelineno-0-184"> 184</a></span>
<span class="normal"><a href="#__codelineno-0-185"> 185</a></span>
<span class="normal"><a href="#__codelineno-0-186"> 186</a></span>
<span class="normal"><a href="#__codelineno-0-187"> 187</a></span>
<span class="normal"><a href="#__codelineno-0-188"> 188</a></span>
<span class="normal"><a href="#__codelineno-0-189"> 189</a></span>
<span class="normal"><a href="#__codelineno-0-190"> 190</a></span>
<span class="normal"><a href="#__codelineno-0-191"> 191</a></span>
<span class="normal"><a href="#__codelineno-0-192"> 192</a></span>
<span class="normal"><a href="#__codelineno-0-193"> 193</a></span>
<span class="normal"><a href="#__codelineno-0-194"> 194</a></span>
<span class="normal"><a href="#__codelineno-0-195"> 195</a></span>
<span class="normal"><a href="#__codelineno-0-196"> 196</a></span>
<span class="normal"><a href="#__codelineno-0-197"> 197</a></span>
<span class="normal"><a href="#__codelineno-0-198"> 198</a></span>
<span class="normal"><a href="#__codelineno-0-199"> 199</a></span>
<span class="normal"><a href="#__codelineno-0-200"> 200</a></span>
<span class="normal"><a href="#__codelineno-0-201"> 201</a></span>
<span class="normal"><a href="#__codelineno-0-202"> 202</a></span>
<span class="normal"><a href="#__codelineno-0-203"> 203</a></span>
<span class="normal"><a href="#__codelineno-0-204"> 204</a></span>
<span class="normal"><a href="#__codelineno-0-205"> 205</a></span>
<span class="normal"><a href="#__codelineno-0-206"> 206</a></span>
<span class="normal"><a href="#__codelineno-0-207"> 207</a></span>
<span class="normal"><a href="#__codelineno-0-208"> 208</a></span>
<span class="normal"><a href="#__codelineno-0-209"> 209</a></span>
<span class="normal"><a href="#__codelineno-0-210"> 210</a></span>
<span class="normal"><a href="#__codelineno-0-211"> 211</a></span>
<span class="normal"><a href="#__codelineno-0-212"> 212</a></span>
<span class="normal"><a href="#__codelineno-0-213"> 213</a></span>
<span class="normal"><a href="#__codelineno-0-214"> 214</a></span>
<span class="normal"><a href="#__codelineno-0-215"> 215</a></span>
<span class="normal"><a href="#__codelineno-0-216"> 216</a></span>
<span class="normal"><a href="#__codelineno-0-217"> 217</a></span>
<span class="normal"><a href="#__codelineno-0-218"> 218</a></span>
<span class="normal"><a href="#__codelineno-0-219"> 219</a></span>
<span class="normal"><a href="#__codelineno-0-220"> 220</a></span>
<span class="normal"><a href="#__codelineno-0-221"> 221</a></span>
<span class="normal"><a href="#__codelineno-0-222"> 222</a></span>
<span class="normal"><a href="#__codelineno-0-223"> 223</a></span>
<span class="normal"><a href="#__codelineno-0-224"> 224</a></span>
<span class="normal"><a href="#__codelineno-0-225"> 225</a></span>
<span class="normal"><a href="#__codelineno-0-226"> 226</a></span>
<span class="normal"><a href="#__codelineno-0-227"> 227</a></span>
<span class="normal"><a href="#__codelineno-0-228"> 228</a></span>
<span class="normal"><a href="#__codelineno-0-229"> 229</a></span>
<span class="normal"><a href="#__codelineno-0-230"> 230</a></span>
<span class="normal"><a href="#__codelineno-0-231"> 231</a></span>
<span class="normal"><a href="#__codelineno-0-232"> 232</a></span>
<span class="normal"><a href="#__codelineno-0-233"> 233</a></span>
<span class="normal"><a href="#__codelineno-0-234"> 234</a></span>
<span class="normal"><a href="#__codelineno-0-235"> 235</a></span>
<span class="normal"><a href="#__codelineno-0-236"> 236</a></span>
<span class="normal"><a href="#__codelineno-0-237"> 237</a></span>
<span class="normal"><a href="#__codelineno-0-238"> 238</a></span>
<span class="normal"><a href="#__codelineno-0-239"> 239</a></span>
<span class="normal"><a href="#__codelineno-0-240"> 240</a></span>
<span class="normal"><a href="#__codelineno-0-241"> 241</a></span>
<span class="normal"><a href="#__codelineno-0-242"> 242</a></span>
<span class="normal"><a href="#__codelineno-0-243"> 243</a></span>
<span class="normal"><a href="#__codelineno-0-244"> 244</a></span>
<span class="normal"><a href="#__codelineno-0-245"> 245</a></span>
<span class="normal"><a href="#__codelineno-0-246"> 246</a></span>
<span class="normal"><a href="#__codelineno-0-247"> 247</a></span>
<span class="normal"><a href="#__codelineno-0-248"> 248</a></span>
<span class="normal"><a href="#__codelineno-0-249"> 249</a></span>
<span class="normal"><a href="#__codelineno-0-250"> 250</a></span>
<span class="normal"><a href="#__codelineno-0-251"> 251</a></span>
<span class="normal"><a href="#__codelineno-0-252"> 252</a></span>
<span class="normal"><a href="#__codelineno-0-253"> 253</a></span>
<span class="normal"><a href="#__codelineno-0-254"> 254</a></span>
<span class="normal"><a href="#__codelineno-0-255"> 255</a></span>
<span class="normal"><a href="#__codelineno-0-256"> 256</a></span>
<span class="normal"><a href="#__codelineno-0-257"> 257</a></span>
<span class="normal"><a href="#__codelineno-0-258"> 258</a></span>
<span class="normal"><a href="#__codelineno-0-259"> 259</a></span>
<span class="normal"><a href="#__codelineno-0-260"> 260</a></span>
<span class="normal"><a href="#__codelineno-0-261"> 261</a></span>
<span class="normal"><a href="#__codelineno-0-262"> 262</a></span>
<span class="normal"><a href="#__codelineno-0-263"> 263</a></span>
<span class="normal"><a href="#__codelineno-0-264"> 264</a></span>
<span class="normal"><a href="#__codelineno-0-265"> 265</a></span>
<span class="normal"><a href="#__codelineno-0-266"> 266</a></span>
<span class="normal"><a href="#__codelineno-0-267"> 267</a></span>
<span class="normal"><a href="#__codelineno-0-268"> 268</a></span>
<span class="normal"><a href="#__codelineno-0-269"> 269</a></span>
<span class="normal"><a href="#__codelineno-0-270"> 270</a></span>
<span class="normal"><a href="#__codelineno-0-271"> 271</a></span>
<span class="normal"><a href="#__codelineno-0-272"> 272</a></span>
<span class="normal"><a href="#__codelineno-0-273"> 273</a></span>
<span class="normal"><a href="#__codelineno-0-274"> 274</a></span>
<span class="normal"><a href="#__codelineno-0-275"> 275</a></span>
<span class="normal"><a href="#__codelineno-0-276"> 276</a></span>
<span class="normal"><a href="#__codelineno-0-277"> 277</a></span>
<span class="normal"><a href="#__codelineno-0-278"> 278</a></span>
<span class="normal"><a href="#__codelineno-0-279"> 279</a></span>
<span class="normal"><a href="#__codelineno-0-280"> 280</a></span>
<span class="normal"><a href="#__codelineno-0-281"> 281</a></span>
<span class="normal"><a href="#__codelineno-0-282"> 282</a></span>
<span class="normal"><a href="#__codelineno-0-283"> 283</a></span>
<span class="normal"><a href="#__codelineno-0-284"> 284</a></span>
<span class="normal"><a href="#__codelineno-0-285"> 285</a></span>
<span class="normal"><a href="#__codelineno-0-286"> 286</a></span>
<span class="normal"><a href="#__codelineno-0-287"> 287</a></span>
<span class="normal"><a href="#__codelineno-0-288"> 288</a></span>
<span class="normal"><a href="#__codelineno-0-289"> 289</a></span>
<span class="normal"><a href="#__codelineno-0-290"> 290</a></span>
<span class="normal"><a href="#__codelineno-0-291"> 291</a></span>
<span class="normal"><a href="#__codelineno-0-292"> 292</a></span>
<span class="normal"><a href="#__codelineno-0-293"> 293</a></span>
<span class="normal"><a href="#__codelineno-0-294"> 294</a></span>
<span class="normal"><a href="#__codelineno-0-295"> 295</a></span>
<span class="normal"><a href="#__codelineno-0-296"> 296</a></span>
<span class="normal"><a href="#__codelineno-0-297"> 297</a></span>
<span class="normal"><a href="#__codelineno-0-298"> 298</a></span>
<span class="normal"><a href="#__codelineno-0-299"> 299</a></span>
<span class="normal"><a href="#__codelineno-0-300"> 300</a></span>
<span class="normal"><a href="#__codelineno-0-301"> 301</a></span>
<span class="normal"><a href="#__codelineno-0-302"> 302</a></span>
<span class="normal"><a href="#__codelineno-0-303"> 303</a></span>
<span class="normal"><a href="#__codelineno-0-304"> 304</a></span>
<span class="normal"><a href="#__codelineno-0-305"> 305</a></span>
<span class="normal"><a href="#__codelineno-0-306"> 306</a></span>
<span class="normal"><a href="#__codelineno-0-307"> 307</a></span>
<span class="normal"><a href="#__codelineno-0-308"> 308</a></span>
<span class="normal"><a href="#__codelineno-0-309"> 309</a></span>
<span class="normal"><a href="#__codelineno-0-310"> 310</a></span>
<span class="normal"><a href="#__codelineno-0-311"> 311</a></span>
<span class="normal"><a href="#__codelineno-0-312"> 312</a></span>
<span class="normal"><a href="#__codelineno-0-313"> 313</a></span>
<span class="normal"><a href="#__codelineno-0-314"> 314</a></span>
<span class="normal"><a href="#__codelineno-0-315"> 315</a></span>
<span class="normal"><a href="#__codelineno-0-316"> 316</a></span>
<span class="normal"><a href="#__codelineno-0-317"> 317</a></span>
<span class="normal"><a href="#__codelineno-0-318"> 318</a></span>
<span class="normal"><a href="#__codelineno-0-319"> 319</a></span>
<span class="normal"><a href="#__codelineno-0-320"> 320</a></span>
<span class="normal"><a href="#__codelineno-0-321"> 321</a></span>
<span class="normal"><a href="#__codelineno-0-322"> 322</a></span>
<span class="normal"><a href="#__codelineno-0-323"> 323</a></span>
<span class="normal"><a href="#__codelineno-0-324"> 324</a></span>
<span class="normal"><a href="#__codelineno-0-325"> 325</a></span>
<span class="normal"><a href="#__codelineno-0-326"> 326</a></span>
<span class="normal"><a href="#__codelineno-0-327"> 327</a></span>
<span class="normal"><a href="#__codelineno-0-328"> 328</a></span>
<span class="normal"><a href="#__codelineno-0-329"> 329</a></span>
<span class="normal"><a href="#__codelineno-0-330"> 330</a></span>
<span class="normal"><a href="#__codelineno-0-331"> 331</a></span>
<span class="normal"><a href="#__codelineno-0-332"> 332</a></span>
<span class="normal"><a href="#__codelineno-0-333"> 333</a></span>
<span class="normal"><a href="#__codelineno-0-334"> 334</a></span>
<span class="normal"><a href="#__codelineno-0-335"> 335</a></span>
<span class="normal"><a href="#__codelineno-0-336"> 336</a></span>
<span class="normal"><a href="#__codelineno-0-337"> 337</a></span>
<span class="normal"><a href="#__codelineno-0-338"> 338</a></span>
<span class="normal"><a href="#__codelineno-0-339"> 339</a></span>
<span class="normal"><a href="#__codelineno-0-340"> 340</a></span>
<span class="normal"><a href="#__codelineno-0-341"> 341</a></span>
<span class="normal"><a href="#__codelineno-0-342"> 342</a></span>
<span class="normal"><a href="#__codelineno-0-343"> 343</a></span>
<span class="normal"><a href="#__codelineno-0-344"> 344</a></span>
<span class="normal"><a href="#__codelineno-0-345"> 345</a></span>
<span class="normal"><a href="#__codelineno-0-346"> 346</a></span>
<span class="normal"><a href="#__codelineno-0-347"> 347</a></span>
<span class="normal"><a href="#__codelineno-0-348"> 348</a></span>
<span class="normal"><a href="#__codelineno-0-349"> 349</a></span>
<span class="normal"><a href="#__codelineno-0-350"> 350</a></span>
<span class="normal"><a href="#__codelineno-0-351"> 351</a></span>
<span class="normal"><a href="#__codelineno-0-352"> 352</a></span>
<span class="normal"><a href="#__codelineno-0-353"> 353</a></span>
<span class="normal"><a href="#__codelineno-0-354"> 354</a></span>
<span class="normal"><a href="#__codelineno-0-355"> 355</a></span>
<span class="normal"><a href="#__codelineno-0-356"> 356</a></span>
<span class="normal"><a href="#__codelineno-0-357"> 357</a></span>
<span class="normal"><a href="#__codelineno-0-358"> 358</a></span>
<span class="normal"><a href="#__codelineno-0-359"> 359</a></span>
<span class="normal"><a href="#__codelineno-0-360"> 360</a></span>
<span class="normal"><a href="#__codelineno-0-361"> 361</a></span>
<span class="normal"><a href="#__codelineno-0-362"> 362</a></span>
<span class="normal"><a href="#__codelineno-0-363"> 363</a></span>
<span class="normal"><a href="#__codelineno-0-364"> 364</a></span>
<span class="normal"><a href="#__codelineno-0-365"> 365</a></span>
<span class="normal"><a href="#__codelineno-0-366"> 366</a></span>
<span class="normal"><a href="#__codelineno-0-367"> 367</a></span>
<span class="normal"><a href="#__codelineno-0-368"> 368</a></span>
<span class="normal"><a href="#__codelineno-0-369"> 369</a></span>
<span class="normal"><a href="#__codelineno-0-370"> 370</a></span>
<span class="normal"><a href="#__codelineno-0-371"> 371</a></span>
<span class="normal"><a href="#__codelineno-0-372"> 372</a></span>
<span class="normal"><a href="#__codelineno-0-373"> 373</a></span>
<span class="normal"><a href="#__codelineno-0-374"> 374</a></span>
<span class="normal"><a href="#__codelineno-0-375"> 375</a></span>
<span class="normal"><a href="#__codelineno-0-376"> 376</a></span>
<span class="normal"><a href="#__codelineno-0-377"> 377</a></span>
<span class="normal"><a href="#__codelineno-0-378"> 378</a></span>
<span class="normal"><a href="#__codelineno-0-379"> 379</a></span>
<span class="normal"><a href="#__codelineno-0-380"> 380</a></span>
<span class="normal"><a href="#__codelineno-0-381"> 381</a></span>
<span class="normal"><a href="#__codelineno-0-382"> 382</a></span>
<span class="normal"><a href="#__codelineno-0-383"> 383</a></span>
<span class="normal"><a href="#__codelineno-0-384"> 384</a></span>
<span class="normal"><a href="#__codelineno-0-385"> 385</a></span>
<span class="normal"><a href="#__codelineno-0-386"> 386</a></span>
<span class="normal"><a href="#__codelineno-0-387"> 387</a></span>
<span class="normal"><a href="#__codelineno-0-388"> 388</a></span>
<span class="normal"><a href="#__codelineno-0-389"> 389</a></span>
<span class="normal"><a href="#__codelineno-0-390"> 390</a></span>
<span class="normal"><a href="#__codelineno-0-391"> 391</a></span>
<span class="normal"><a href="#__codelineno-0-392"> 392</a></span>
<span class="normal"><a href="#__codelineno-0-393"> 393</a></span>
<span class="normal"><a href="#__codelineno-0-394"> 394</a></span>
<span class="normal"><a href="#__codelineno-0-395"> 395</a></span>
<span class="normal"><a href="#__codelineno-0-396"> 396</a></span>
<span class="normal"><a href="#__codelineno-0-397"> 397</a></span>
<span class="normal"><a href="#__codelineno-0-398"> 398</a></span>
<span class="normal"><a href="#__codelineno-0-399"> 399</a></span>
<span class="normal"><a href="#__codelineno-0-400"> 400</a></span>
<span class="normal"><a href="#__codelineno-0-401"> 401</a></span>
<span class="normal"><a href="#__codelineno-0-402"> 402</a></span>
<span class="normal"><a href="#__codelineno-0-403"> 403</a></span>
<span class="normal"><a href="#__codelineno-0-404"> 404</a></span>
<span class="normal"><a href="#__codelineno-0-405"> 405</a></span>
<span class="normal"><a href="#__codelineno-0-406"> 406</a></span>
<span class="normal"><a href="#__codelineno-0-407"> 407</a></span>
<span class="normal"><a href="#__codelineno-0-408"> 408</a></span>
<span class="normal"><a href="#__codelineno-0-409"> 409</a></span>
<span class="normal"><a href="#__codelineno-0-410"> 410</a></span>
<span class="normal"><a href="#__codelineno-0-411"> 411</a></span>
<span class="normal"><a href="#__codelineno-0-412"> 412</a></span>
<span class="normal"><a href="#__codelineno-0-413"> 413</a></span>
<span class="normal"><a href="#__codelineno-0-414"> 414</a></span>
<span class="normal"><a href="#__codelineno-0-415"> 415</a></span>
<span class="normal"><a href="#__codelineno-0-416"> 416</a></span>
<span class="normal"><a href="#__codelineno-0-417"> 417</a></span>
<span class="normal"><a href="#__codelineno-0-418"> 418</a></span>
<span class="normal"><a href="#__codelineno-0-419"> 419</a></span>
<span class="normal"><a href="#__codelineno-0-420"> 420</a></span>
<span class="normal"><a href="#__codelineno-0-421"> 421</a></span>
<span class="normal"><a href="#__codelineno-0-422"> 422</a></span>
<span class="normal"><a href="#__codelineno-0-423"> 423</a></span>
<span class="normal"><a href="#__codelineno-0-424"> 424</a></span>
<span class="normal"><a href="#__codelineno-0-425"> 425</a></span>
<span class="normal"><a href="#__codelineno-0-426"> 426</a></span>
<span class="normal"><a href="#__codelineno-0-427"> 427</a></span>
<span class="normal"><a href="#__codelineno-0-428"> 428</a></span>
<span class="normal"><a href="#__codelineno-0-429"> 429</a></span>
<span class="normal"><a href="#__codelineno-0-430"> 430</a></span>
<span class="normal"><a href="#__codelineno-0-431"> 431</a></span>
<span class="normal"><a href="#__codelineno-0-432"> 432</a></span>
<span class="normal"><a href="#__codelineno-0-433"> 433</a></span>
<span class="normal"><a href="#__codelineno-0-434"> 434</a></span>
<span class="normal"><a href="#__codelineno-0-435"> 435</a></span>
<span class="normal"><a href="#__codelineno-0-436"> 436</a></span>
<span class="normal"><a href="#__codelineno-0-437"> 437</a></span>
<span class="normal"><a href="#__codelineno-0-438"> 438</a></span>
<span class="normal"><a href="#__codelineno-0-439"> 439</a></span>
<span class="normal"><a href="#__codelineno-0-440"> 440</a></span>
<span class="normal"><a href="#__codelineno-0-441"> 441</a></span>
<span class="normal"><a href="#__codelineno-0-442"> 442</a></span>
<span class="normal"><a href="#__codelineno-0-443"> 443</a></span>
<span class="normal"><a href="#__codelineno-0-444"> 444</a></span>
<span class="normal"><a href="#__codelineno-0-445"> 445</a></span>
<span class="normal"><a href="#__codelineno-0-446"> 446</a></span>
<span class="normal"><a href="#__codelineno-0-447"> 447</a></span>
<span class="normal"><a href="#__codelineno-0-448"> 448</a></span>
<span class="normal"><a href="#__codelineno-0-449"> 449</a></span>
<span class="normal"><a href="#__codelineno-0-450"> 450</a></span>
<span class="normal"><a href="#__codelineno-0-451"> 451</a></span>
<span class="normal"><a href="#__codelineno-0-452"> 452</a></span>
<span class="normal"><a href="#__codelineno-0-453"> 453</a></span>
<span class="normal"><a href="#__codelineno-0-454"> 454</a></span>
<span class="normal"><a href="#__codelineno-0-455"> 455</a></span>
<span class="normal"><a href="#__codelineno-0-456"> 456</a></span>
<span class="normal"><a href="#__codelineno-0-457"> 457</a></span>
<span class="normal"><a href="#__codelineno-0-458"> 458</a></span>
<span class="normal"><a href="#__codelineno-0-459"> 459</a></span>
<span class="normal"><a href="#__codelineno-0-460"> 460</a></span>
<span class="normal"><a href="#__codelineno-0-461"> 461</a></span>
<span class="normal"><a href="#__codelineno-0-462"> 462</a></span>
<span class="normal"><a href="#__codelineno-0-463"> 463</a></span>
<span class="normal"><a href="#__codelineno-0-464"> 464</a></span>
<span class="normal"><a href="#__codelineno-0-465"> 465</a></span>
<span class="normal"><a href="#__codelineno-0-466"> 466</a></span>
<span class="normal"><a href="#__codelineno-0-467"> 467</a></span>
<span class="normal"><a href="#__codelineno-0-468"> 468</a></span>
<span class="normal"><a href="#__codelineno-0-469"> 469</a></span>
<span class="normal"><a href="#__codelineno-0-470"> 470</a></span>
<span class="normal"><a href="#__codelineno-0-471"> 471</a></span>
<span class="normal"><a href="#__codelineno-0-472"> 472</a></span>
<span class="normal"><a href="#__codelineno-0-473"> 473</a></span>
<span class="normal"><a href="#__codelineno-0-474"> 474</a></span>
<span class="normal"><a href="#__codelineno-0-475"> 475</a></span>
<span class="normal"><a href="#__codelineno-0-476"> 476</a></span>
<span class="normal"><a href="#__codelineno-0-477"> 477</a></span>
<span class="normal"><a href="#__codelineno-0-478"> 478</a></span>
<span class="normal"><a href="#__codelineno-0-479"> 479</a></span>
<span class="normal"><a href="#__codelineno-0-480"> 480</a></span>
<span class="normal"><a href="#__codelineno-0-481"> 481</a></span>
<span class="normal"><a href="#__codelineno-0-482"> 482</a></span>
<span class="normal"><a href="#__codelineno-0-483"> 483</a></span>
<span class="normal"><a href="#__codelineno-0-484"> 484</a></span>
<span class="normal"><a href="#__codelineno-0-485"> 485</a></span>
<span class="normal"><a href="#__codelineno-0-486"> 486</a></span>
<span class="normal"><a href="#__codelineno-0-487"> 487</a></span>
<span class="normal"><a href="#__codelineno-0-488"> 488</a></span>
<span class="normal"><a href="#__codelineno-0-489"> 489</a></span>
<span class="normal"><a href="#__codelineno-0-490"> 490</a></span>
<span class="normal"><a href="#__codelineno-0-491"> 491</a></span>
<span class="normal"><a href="#__codelineno-0-492"> 492</a></span>
<span class="normal"><a href="#__codelineno-0-493"> 493</a></span>
<span class="normal"><a href="#__codelineno-0-494"> 494</a></span>
<span class="normal"><a href="#__codelineno-0-495"> 495</a></span>
<span class="normal"><a href="#__codelineno-0-496"> 496</a></span>
<span class="normal"><a href="#__codelineno-0-497"> 497</a></span>
<span class="normal"><a href="#__codelineno-0-498"> 498</a></span>
<span class="normal"><a href="#__codelineno-0-499"> 499</a></span>
<span class="normal"><a href="#__codelineno-0-500"> 500</a></span>
<span class="normal"><a href="#__codelineno-0-501"> 501</a></span>
<span class="normal"><a href="#__codelineno-0-502"> 502</a></span>
<span class="normal"><a href="#__codelineno-0-503"> 503</a></span>
<span class="normal"><a href="#__codelineno-0-504"> 504</a></span>
<span class="normal"><a href="#__codelineno-0-505"> 505</a></span>
<span class="normal"><a href="#__codelineno-0-506"> 506</a></span>
<span class="normal"><a href="#__codelineno-0-507"> 507</a></span>
<span class="normal"><a href="#__codelineno-0-508"> 508</a></span>
<span class="normal"><a href="#__codelineno-0-509"> 509</a></span>
<span class="normal"><a href="#__codelineno-0-510"> 510</a></span>
<span class="normal"><a href="#__codelineno-0-511"> 511</a></span>
<span class="normal"><a href="#__codelineno-0-512"> 512</a></span>
<span class="normal"><a href="#__codelineno-0-513"> 513</a></span>
<span class="normal"><a href="#__codelineno-0-514"> 514</a></span>
<span class="normal"><a href="#__codelineno-0-515"> 515</a></span>
<span class="normal"><a href="#__codelineno-0-516"> 516</a></span>
<span class="normal"><a href="#__codelineno-0-517"> 517</a></span>
<span class="normal"><a href="#__codelineno-0-518"> 518</a></span>
<span class="normal"><a href="#__codelineno-0-519"> 519</a></span>
<span class="normal"><a href="#__codelineno-0-520"> 520</a></span>
<span class="normal"><a href="#__codelineno-0-521"> 521</a></span>
<span class="normal"><a href="#__codelineno-0-522"> 522</a></span>
<span class="normal"><a href="#__codelineno-0-523"> 523</a></span>
<span class="normal"><a href="#__codelineno-0-524"> 524</a></span>
<span class="normal"><a href="#__codelineno-0-525"> 525</a></span>
<span class="normal"><a href="#__codelineno-0-526"> 526</a></span>
<span class="normal"><a href="#__codelineno-0-527"> 527</a></span>
<span class="normal"><a href="#__codelineno-0-528"> 528</a></span>
<span class="normal"><a href="#__codelineno-0-529"> 529</a></span>
<span class="normal"><a href="#__codelineno-0-530"> 530</a></span>
<span class="normal"><a href="#__codelineno-0-531"> 531</a></span>
<span class="normal"><a href="#__codelineno-0-532"> 532</a></span>
<span class="normal"><a href="#__codelineno-0-533"> 533</a></span>
<span class="normal"><a href="#__codelineno-0-534"> 534</a></span>
<span class="normal"><a href="#__codelineno-0-535"> 535</a></span>
<span class="normal"><a href="#__codelineno-0-536"> 536</a></span>
<span class="normal"><a href="#__codelineno-0-537"> 537</a></span>
<span class="normal"><a href="#__codelineno-0-538"> 538</a></span>
<span class="normal"><a href="#__codelineno-0-539"> 539</a></span>
<span class="normal"><a href="#__codelineno-0-540"> 540</a></span>
<span class="normal"><a href="#__codelineno-0-541"> 541</a></span>
<span class="normal"><a href="#__codelineno-0-542"> 542</a></span>
<span class="normal"><a href="#__codelineno-0-543"> 543</a></span>
<span class="normal"><a href="#__codelineno-0-544"> 544</a></span>
<span class="normal"><a href="#__codelineno-0-545"> 545</a></span>
<span class="normal"><a href="#__codelineno-0-546"> 546</a></span>
<span class="normal"><a href="#__codelineno-0-547"> 547</a></span>
<span class="normal"><a href="#__codelineno-0-548"> 548</a></span>
<span class="normal"><a href="#__codelineno-0-549"> 549</a></span>
<span class="normal"><a href="#__codelineno-0-550"> 550</a></span>
<span class="normal"><a href="#__codelineno-0-551"> 551</a></span>
<span class="normal"><a href="#__codelineno-0-552"> 552</a></span>
<span class="normal"><a href="#__codelineno-0-553"> 553</a></span>
<span class="normal"><a href="#__codelineno-0-554"> 554</a></span>
<span class="normal"><a href="#__codelineno-0-555"> 555</a></span>
<span class="normal"><a href="#__codelineno-0-556"> 556</a></span>
<span class="normal"><a href="#__codelineno-0-557"> 557</a></span>
<span class="normal"><a href="#__codelineno-0-558"> 558</a></span>
<span class="normal"><a href="#__codelineno-0-559"> 559</a></span>
<span class="normal"><a href="#__codelineno-0-560"> 560</a></span>
<span class="normal"><a href="#__codelineno-0-561"> 561</a></span>
<span class="normal"><a href="#__codelineno-0-562"> 562</a></span>
<span class="normal"><a href="#__codelineno-0-563"> 563</a></span>
<span class="normal"><a href="#__codelineno-0-564"> 564</a></span>
<span class="normal"><a href="#__codelineno-0-565"> 565</a></span>
<span class="normal"><a href="#__codelineno-0-566"> 566</a></span>
<span class="normal"><a href="#__codelineno-0-567"> 567</a></span>
<span class="normal"><a href="#__codelineno-0-568"> 568</a></span>
<span class="normal"><a href="#__codelineno-0-569"> 569</a></span>
<span class="normal"><a href="#__codelineno-0-570"> 570</a></span>
<span class="normal"><a href="#__codelineno-0-571"> 571</a></span>
<span class="normal"><a href="#__codelineno-0-572"> 572</a></span>
<span class="normal"><a href="#__codelineno-0-573"> 573</a></span>
<span class="normal"><a href="#__codelineno-0-574"> 574</a></span>
<span class="normal"><a href="#__codelineno-0-575"> 575</a></span>
<span class="normal"><a href="#__codelineno-0-576"> 576</a></span>
<span class="normal"><a href="#__codelineno-0-577"> 577</a></span>
<span class="normal"><a href="#__codelineno-0-578"> 578</a></span>
<span class="normal"><a href="#__codelineno-0-579"> 579</a></span>
<span class="normal"><a href="#__codelineno-0-580"> 580</a></span>
<span class="normal"><a href="#__codelineno-0-581"> 581</a></span>
<span class="normal"><a href="#__codelineno-0-582"> 582</a></span>
<span class="normal"><a href="#__codelineno-0-583"> 583</a></span>
<span class="normal"><a href="#__codelineno-0-584"> 584</a></span>
<span class="normal"><a href="#__codelineno-0-585"> 585</a></span>
<span class="normal"><a href="#__codelineno-0-586"> 586</a></span>
<span class="normal"><a href="#__codelineno-0-587"> 587</a></span>
<span class="normal"><a href="#__codelineno-0-588"> 588</a></span>
<span class="normal"><a href="#__codelineno-0-589"> 589</a></span>
<span class="normal"><a href="#__codelineno-0-590"> 590</a></span>
<span class="normal"><a href="#__codelineno-0-591"> 591</a></span>
<span class="normal"><a href="#__codelineno-0-592"> 592</a></span>
<span class="normal"><a href="#__codelineno-0-593"> 593</a></span>
<span class="normal"><a href="#__codelineno-0-594"> 594</a></span>
<span class="normal"><a href="#__codelineno-0-595"> 595</a></span>
<span class="normal"><a href="#__codelineno-0-596"> 596</a></span>
<span class="normal"><a href="#__codelineno-0-597"> 597</a></span>
<span class="normal"><a href="#__codelineno-0-598"> 598</a></span>
<span class="normal"><a href="#__codelineno-0-599"> 599</a></span>
<span class="normal"><a href="#__codelineno-0-600"> 600</a></span>
<span class="normal"><a href="#__codelineno-0-601"> 601</a></span>
<span class="normal"><a href="#__codelineno-0-602"> 602</a></span>
<span class="normal"><a href="#__codelineno-0-603"> 603</a></span>
<span class="normal"><a href="#__codelineno-0-604"> 604</a></span>
<span class="normal"><a href="#__codelineno-0-605"> 605</a></span>
<span class="normal"><a href="#__codelineno-0-606"> 606</a></span>
<span class="normal"><a href="#__codelineno-0-607"> 607</a></span>
<span class="normal"><a href="#__codelineno-0-608"> 608</a></span>
<span class="normal"><a href="#__codelineno-0-609"> 609</a></span>
<span class="normal"><a href="#__codelineno-0-610"> 610</a></span>
<span class="normal"><a href="#__codelineno-0-611"> 611</a></span>
<span class="normal"><a href="#__codelineno-0-612"> 612</a></span>
<span class="normal"><a href="#__codelineno-0-613"> 613</a></span>
<span class="normal"><a href="#__codelineno-0-614"> 614</a></span>
<span class="normal"><a href="#__codelineno-0-615"> 615</a></span>
<span class="normal"><a href="#__codelineno-0-616"> 616</a></span>
<span class="normal"><a href="#__codelineno-0-617"> 617</a></span>
<span class="normal"><a href="#__codelineno-0-618"> 618</a></span>
<span class="normal"><a href="#__codelineno-0-619"> 619</a></span>
<span class="normal"><a href="#__codelineno-0-620"> 620</a></span>
<span class="normal"><a href="#__codelineno-0-621"> 621</a></span>
<span class="normal"><a href="#__codelineno-0-622"> 622</a></span>
<span class="normal"><a href="#__codelineno-0-623"> 623</a></span>
<span class="normal"><a href="#__codelineno-0-624"> 624</a></span>
<span class="normal"><a href="#__codelineno-0-625"> 625</a></span>
<span class="normal"><a href="#__codelineno-0-626"> 626</a></span>
<span class="normal"><a href="#__codelineno-0-627"> 627</a></span>
<span class="normal"><a href="#__codelineno-0-628"> 628</a></span>
<span class="normal"><a href="#__codelineno-0-629"> 629</a></span>
<span class="normal"><a href="#__codelineno-0-630"> 630</a></span>
<span class="normal"><a href="#__codelineno-0-631"> 631</a></span>
<span class="normal"><a href="#__codelineno-0-632"> 632</a></span>
<span class="normal"><a href="#__codelineno-0-633"> 633</a></span>
<span class="normal"><a href="#__codelineno-0-634"> 634</a></span>
<span class="normal"><a href="#__codelineno-0-635"> 635</a></span>
<span class="normal"><a href="#__codelineno-0-636"> 636</a></span>
<span class="normal"><a href="#__codelineno-0-637"> 637</a></span>
<span class="normal"><a href="#__codelineno-0-638"> 638</a></span>
<span class="normal"><a href="#__codelineno-0-639"> 639</a></span>
<span class="normal"><a href="#__codelineno-0-640"> 640</a></span>
<span class="normal"><a href="#__codelineno-0-641"> 641</a></span>
<span class="normal"><a href="#__codelineno-0-642"> 642</a></span>
<span class="normal"><a href="#__codelineno-0-643"> 643</a></span>
<span class="normal"><a href="#__codelineno-0-644"> 644</a></span>
<span class="normal"><a href="#__codelineno-0-645"> 645</a></span>
<span class="normal"><a href="#__codelineno-0-646"> 646</a></span>
<span class="normal"><a href="#__codelineno-0-647"> 647</a></span>
<span class="normal"><a href="#__codelineno-0-648"> 648</a></span>
<span class="normal"><a href="#__codelineno-0-649"> 649</a></span>
<span class="normal"><a href="#__codelineno-0-650"> 650</a></span>
<span class="normal"><a href="#__codelineno-0-651"> 651</a></span>
<span class="normal"><a href="#__codelineno-0-652"> 652</a></span>
<span class="normal"><a href="#__codelineno-0-653"> 653</a></span>
<span class="normal"><a href="#__codelineno-0-654"> 654</a></span>
<span class="normal"><a href="#__codelineno-0-655"> 655</a></span>
<span class="normal"><a href="#__codelineno-0-656"> 656</a></span>
<span class="normal"><a href="#__codelineno-0-657"> 657</a></span>
<span class="normal"><a href="#__codelineno-0-658"> 658</a></span>
<span class="normal"><a href="#__codelineno-0-659"> 659</a></span>
<span class="normal"><a href="#__codelineno-0-660"> 660</a></span>
<span class="normal"><a href="#__codelineno-0-661"> 661</a></span>
<span class="normal"><a href="#__codelineno-0-662"> 662</a></span>
<span class="normal"><a href="#__codelineno-0-663"> 663</a></span>
<span class="normal"><a href="#__codelineno-0-664"> 664</a></span>
<span class="normal"><a href="#__codelineno-0-665"> 665</a></span>
<span class="normal"><a href="#__codelineno-0-666"> 666</a></span>
<span class="normal"><a href="#__codelineno-0-667"> 667</a></span>
<span class="normal"><a href="#__codelineno-0-668"> 668</a></span>
<span class="normal"><a href="#__codelineno-0-669"> 669</a></span>
<span class="normal"><a href="#__codelineno-0-670"> 670</a></span>
<span class="normal"><a href="#__codelineno-0-671"> 671</a></span>
<span class="normal"><a href="#__codelineno-0-672"> 672</a></span>
<span class="normal"><a href="#__codelineno-0-673"> 673</a></span>
<span class="normal"><a href="#__codelineno-0-674"> 674</a></span>
<span class="normal"><a href="#__codelineno-0-675"> 675</a></span>
<span class="normal"><a href="#__codelineno-0-676"> 676</a></span>
<span class="normal"><a href="#__codelineno-0-677"> 677</a></span>
<span class="normal"><a href="#__codelineno-0-678"> 678</a></span>
<span class="normal"><a href="#__codelineno-0-679"> 679</a></span>
<span class="normal"><a href="#__codelineno-0-680"> 680</a></span>
<span class="normal"><a href="#__codelineno-0-681"> 681</a></span>
<span class="normal"><a href="#__codelineno-0-682"> 682</a></span>
<span class="normal"><a href="#__codelineno-0-683"> 683</a></span>
<span class="normal"><a href="#__codelineno-0-684"> 684</a></span>
<span class="normal"><a href="#__codelineno-0-685"> 685</a></span>
<span class="normal"><a href="#__codelineno-0-686"> 686</a></span>
<span class="normal"><a href="#__codelineno-0-687"> 687</a></span>
<span class="normal"><a href="#__codelineno-0-688"> 688</a></span>
<span class="normal"><a href="#__codelineno-0-689"> 689</a></span>
<span class="normal"><a href="#__codelineno-0-690"> 690</a></span>
<span class="normal"><a href="#__codelineno-0-691"> 691</a></span>
<span class="normal"><a href="#__codelineno-0-692"> 692</a></span>
<span class="normal"><a href="#__codelineno-0-693"> 693</a></span>
<span class="normal"><a href="#__codelineno-0-694"> 694</a></span>
<span class="normal"><a href="#__codelineno-0-695"> 695</a></span>
<span class="normal"><a href="#__codelineno-0-696"> 696</a></span>
<span class="normal"><a href="#__codelineno-0-697"> 697</a></span>
<span class="normal"><a href="#__codelineno-0-698"> 698</a></span>
<span class="normal"><a href="#__codelineno-0-699"> 699</a></span>
<span class="normal"><a href="#__codelineno-0-700"> 700</a></span>
<span class="normal"><a href="#__codelineno-0-701"> 701</a></span>
<span class="normal"><a href="#__codelineno-0-702"> 702</a></span>
<span class="normal"><a href="#__codelineno-0-703"> 703</a></span>
<span class="normal"><a href="#__codelineno-0-704"> 704</a></span>
<span class="normal"><a href="#__codelineno-0-705"> 705</a></span>
<span class="normal"><a href="#__codelineno-0-706"> 706</a></span>
<span class="normal"><a href="#__codelineno-0-707"> 707</a></span>
<span class="normal"><a href="#__codelineno-0-708"> 708</a></span>
<span class="normal"><a href="#__codelineno-0-709"> 709</a></span>
<span class="normal"><a href="#__codelineno-0-710"> 710</a></span>
<span class="normal"><a href="#__codelineno-0-711"> 711</a></span>
<span class="normal"><a href="#__codelineno-0-712"> 712</a></span>
<span class="normal"><a href="#__codelineno-0-713"> 713</a></span>
<span class="normal"><a href="#__codelineno-0-714"> 714</a></span>
<span class="normal"><a href="#__codelineno-0-715"> 715</a></span>
<span class="normal"><a href="#__codelineno-0-716"> 716</a></span>
<span class="normal"><a href="#__codelineno-0-717"> 717</a></span>
<span class="normal"><a href="#__codelineno-0-718"> 718</a></span>
<span class="normal"><a href="#__codelineno-0-719"> 719</a></span>
<span class="normal"><a href="#__codelineno-0-720"> 720</a></span>
<span class="normal"><a href="#__codelineno-0-721"> 721</a></span>
<span class="normal"><a href="#__codelineno-0-722"> 722</a></span>
<span class="normal"><a href="#__codelineno-0-723"> 723</a></span>
<span class="normal"><a href="#__codelineno-0-724"> 724</a></span>
<span class="normal"><a href="#__codelineno-0-725"> 725</a></span>
<span class="normal"><a href="#__codelineno-0-726"> 726</a></span>
<span class="normal"><a href="#__codelineno-0-727"> 727</a></span>
<span class="normal"><a href="#__codelineno-0-728"> 728</a></span>
<span class="normal"><a href="#__codelineno-0-729"> 729</a></span>
<span class="normal"><a href="#__codelineno-0-730"> 730</a></span>
<span class="normal"><a href="#__codelineno-0-731"> 731</a></span>
<span class="normal"><a href="#__codelineno-0-732"> 732</a></span>
<span class="normal"><a href="#__codelineno-0-733"> 733</a></span>
<span class="normal"><a href="#__codelineno-0-734"> 734</a></span>
<span class="normal"><a href="#__codelineno-0-735"> 735</a></span>
<span class="normal"><a href="#__codelineno-0-736"> 736</a></span>
<span class="normal"><a href="#__codelineno-0-737"> 737</a></span>
<span class="normal"><a href="#__codelineno-0-738"> 738</a></span>
<span class="normal"><a href="#__codelineno-0-739"> 739</a></span>
<span class="normal"><a href="#__codelineno-0-740"> 740</a></span>
<span class="normal"><a href="#__codelineno-0-741"> 741</a></span>
<span class="normal"><a href="#__codelineno-0-742"> 742</a></span>
<span class="normal"><a href="#__codelineno-0-743"> 743</a></span>
<span class="normal"><a href="#__codelineno-0-744"> 744</a></span>
<span class="normal"><a href="#__codelineno-0-745"> 745</a></span>
<span class="normal"><a href="#__codelineno-0-746"> 746</a></span>
<span class="normal"><a href="#__codelineno-0-747"> 747</a></span>
<span class="normal"><a href="#__codelineno-0-748"> 748</a></span>
<span class="normal"><a href="#__codelineno-0-749"> 749</a></span>
<span class="normal"><a href="#__codelineno-0-750"> 750</a></span>
<span class="normal"><a href="#__codelineno-0-751"> 751</a></span>
<span class="normal"><a href="#__codelineno-0-752"> 752</a></span>
<span class="normal"><a href="#__codelineno-0-753"> 753</a></span>
<span class="normal"><a href="#__codelineno-0-754"> 754</a></span>
<span class="normal"><a href="#__codelineno-0-755"> 755</a></span>
<span class="normal"><a href="#__codelineno-0-756"> 756</a></span>
<span class="normal"><a href="#__codelineno-0-757"> 757</a></span>
<span class="normal"><a href="#__codelineno-0-758"> 758</a></span>
<span class="normal"><a href="#__codelineno-0-759"> 759</a></span>
<span class="normal"><a href="#__codelineno-0-760"> 760</a></span>
<span class="normal"><a href="#__codelineno-0-761"> 761</a></span>
<span class="normal"><a href="#__codelineno-0-762"> 762</a></span>
<span class="normal"><a href="#__codelineno-0-763"> 763</a></span>
<span class="normal"><a href="#__codelineno-0-764"> 764</a></span>
<span class="normal"><a href="#__codelineno-0-765"> 765</a></span>
<span class="normal"><a href="#__codelineno-0-766"> 766</a></span>
<span class="normal"><a href="#__codelineno-0-767"> 767</a></span>
<span class="normal"><a href="#__codelineno-0-768"> 768</a></span>
<span class="normal"><a href="#__codelineno-0-769"> 769</a></span>
<span class="normal"><a href="#__codelineno-0-770"> 770</a></span>
<span class="normal"><a href="#__codelineno-0-771"> 771</a></span>
<span class="normal"><a href="#__codelineno-0-772"> 772</a></span>
<span class="normal"><a href="#__codelineno-0-773"> 773</a></span>
<span class="normal"><a href="#__codelineno-0-774"> 774</a></span>
<span class="normal"><a href="#__codelineno-0-775"> 775</a></span>
<span class="normal"><a href="#__codelineno-0-776"> 776</a></span>
<span class="normal"><a href="#__codelineno-0-777"> 777</a></span>
<span class="normal"><a href="#__codelineno-0-778"> 778</a></span>
<span class="normal"><a href="#__codelineno-0-779"> 779</a></span>
<span class="normal"><a href="#__codelineno-0-780"> 780</a></span>
<span class="normal"><a href="#__codelineno-0-781"> 781</a></span>
<span class="normal"><a href="#__codelineno-0-782"> 782</a></span>
<span class="normal"><a href="#__codelineno-0-783"> 783</a></span>
<span class="normal"><a href="#__codelineno-0-784"> 784</a></span>
<span class="normal"><a href="#__codelineno-0-785"> 785</a></span>
<span class="normal"><a href="#__codelineno-0-786"> 786</a></span>
<span class="normal"><a href="#__codelineno-0-787"> 787</a></span>
<span class="normal"><a href="#__codelineno-0-788"> 788</a></span>
<span class="normal"><a href="#__codelineno-0-789"> 789</a></span>
<span class="normal"><a href="#__codelineno-0-790"> 790</a></span>
<span class="normal"><a href="#__codelineno-0-791"> 791</a></span>
<span class="normal"><a href="#__codelineno-0-792"> 792</a></span>
<span class="normal"><a href="#__codelineno-0-793"> 793</a></span>
<span class="normal"><a href="#__codelineno-0-794"> 794</a></span>
<span class="normal"><a href="#__codelineno-0-795"> 795</a></span>
<span class="normal"><a href="#__codelineno-0-796"> 796</a></span>
<span class="normal"><a href="#__codelineno-0-797"> 797</a></span>
<span class="normal"><a href="#__codelineno-0-798"> 798</a></span>
<span class="normal"><a href="#__codelineno-0-799"> 799</a></span>
<span class="normal"><a href="#__codelineno-0-800"> 800</a></span>
<span class="normal"><a href="#__codelineno-0-801"> 801</a></span>
<span class="normal"><a href="#__codelineno-0-802"> 802</a></span>
<span class="normal"><a href="#__codelineno-0-803"> 803</a></span>
<span class="normal"><a href="#__codelineno-0-804"> 804</a></span>
<span class="normal"><a href="#__codelineno-0-805"> 805</a></span>
<span class="normal"><a href="#__codelineno-0-806"> 806</a></span>
<span class="normal"><a href="#__codelineno-0-807"> 807</a></span>
<span class="normal"><a href="#__codelineno-0-808"> 808</a></span>
<span class="normal"><a href="#__codelineno-0-809"> 809</a></span>
<span class="normal"><a href="#__codelineno-0-810"> 810</a></span>
<span class="normal"><a href="#__codelineno-0-811"> 811</a></span>
<span class="normal"><a href="#__codelineno-0-812"> 812</a></span>
<span class="normal"><a href="#__codelineno-0-813"> 813</a></span>
<span class="normal"><a href="#__codelineno-0-814"> 814</a></span>
<span class="normal"><a href="#__codelineno-0-815"> 815</a></span>
<span class="normal"><a href="#__codelineno-0-816"> 816</a></span>
<span class="normal"><a href="#__codelineno-0-817"> 817</a></span>
<span class="normal"><a href="#__codelineno-0-818"> 818</a></span>
<span class="normal"><a href="#__codelineno-0-819"> 819</a></span>
<span class="normal"><a href="#__codelineno-0-820"> 820</a></span>
<span class="normal"><a href="#__codelineno-0-821"> 821</a></span>
<span class="normal"><a href="#__codelineno-0-822"> 822</a></span>
<span class="normal"><a href="#__codelineno-0-823"> 823</a></span>
<span class="normal"><a href="#__codelineno-0-824"> 824</a></span>
<span class="normal"><a href="#__codelineno-0-825"> 825</a></span>
<span class="normal"><a href="#__codelineno-0-826"> 826</a></span>
<span class="normal"><a href="#__codelineno-0-827"> 827</a></span>
<span class="normal"><a href="#__codelineno-0-828"> 828</a></span>
<span class="normal"><a href="#__codelineno-0-829"> 829</a></span>
<span class="normal"><a href="#__codelineno-0-830"> 830</a></span>
<span class="normal"><a href="#__codelineno-0-831"> 831</a></span>
<span class="normal"><a href="#__codelineno-0-832"> 832</a></span>
<span class="normal"><a href="#__codelineno-0-833"> 833</a></span>
<span class="normal"><a href="#__codelineno-0-834"> 834</a></span>
<span class="normal"><a href="#__codelineno-0-835"> 835</a></span>
<span class="normal"><a href="#__codelineno-0-836"> 836</a></span>
<span class="normal"><a href="#__codelineno-0-837"> 837</a></span>
<span class="normal"><a href="#__codelineno-0-838"> 838</a></span>
<span class="normal"><a href="#__codelineno-0-839"> 839</a></span>
<span class="normal"><a href="#__codelineno-0-840"> 840</a></span>
<span class="normal"><a href="#__codelineno-0-841"> 841</a></span>
<span class="normal"><a href="#__codelineno-0-842"> 842</a></span>
<span class="normal"><a href="#__codelineno-0-843"> 843</a></span>
<span class="normal"><a href="#__codelineno-0-844"> 844</a></span>
<span class="normal"><a href="#__codelineno-0-845"> 845</a></span>
<span class="normal"><a href="#__codelineno-0-846"> 846</a></span>
<span class="normal"><a href="#__codelineno-0-847"> 847</a></span>
<span class="normal"><a href="#__codelineno-0-848"> 848</a></span>
<span class="normal"><a href="#__codelineno-0-849"> 849</a></span>
<span class="normal"><a href="#__codelineno-0-850"> 850</a></span>
<span class="normal"><a href="#__codelineno-0-851"> 851</a></span>
<span class="normal"><a href="#__codelineno-0-852"> 852</a></span>
<span class="normal"><a href="#__codelineno-0-853"> 853</a></span>
<span class="normal"><a href="#__codelineno-0-854"> 854</a></span>
<span class="normal"><a href="#__codelineno-0-855"> 855</a></span>
<span class="normal"><a href="#__codelineno-0-856"> 856</a></span>
<span class="normal"><a href="#__codelineno-0-857"> 857</a></span>
<span class="normal"><a href="#__codelineno-0-858"> 858</a></span>
<span class="normal"><a href="#__codelineno-0-859"> 859</a></span>
<span class="normal"><a href="#__codelineno-0-860"> 860</a></span>
<span class="normal"><a href="#__codelineno-0-861"> 861</a></span>
<span class="normal"><a href="#__codelineno-0-862"> 862</a></span>
<span class="normal"><a href="#__codelineno-0-863"> 863</a></span>
<span class="normal"><a href="#__codelineno-0-864"> 864</a></span>
<span class="normal"><a href="#__codelineno-0-865"> 865</a></span>
<span class="normal"><a href="#__codelineno-0-866"> 866</a></span>
<span class="normal"><a href="#__codelineno-0-867"> 867</a></span>
<span class="normal"><a href="#__codelineno-0-868"> 868</a></span>
<span class="normal"><a href="#__codelineno-0-869"> 869</a></span>
<span class="normal"><a href="#__codelineno-0-870"> 870</a></span>
<span class="normal"><a href="#__codelineno-0-871"> 871</a></span>
<span class="normal"><a href="#__codelineno-0-872"> 872</a></span>
<span class="normal"><a href="#__codelineno-0-873"> 873</a></span>
<span class="normal"><a href="#__codelineno-0-874"> 874</a></span>
<span class="normal"><a href="#__codelineno-0-875"> 875</a></span>
<span class="normal"><a href="#__codelineno-0-876"> 876</a></span>
<span class="normal"><a href="#__codelineno-0-877"> 877</a></span>
<span class="normal"><a href="#__codelineno-0-878"> 878</a></span>
<span class="normal"><a href="#__codelineno-0-879"> 879</a></span>
<span class="normal"><a href="#__codelineno-0-880"> 880</a></span>
<span class="normal"><a href="#__codelineno-0-881"> 881</a></span>
<span class="normal"><a href="#__codelineno-0-882"> 882</a></span>
<span class="normal"><a href="#__codelineno-0-883"> 883</a></span>
<span class="normal"><a href="#__codelineno-0-884"> 884</a></span>
<span class="normal"><a href="#__codelineno-0-885"> 885</a></span>
<span class="normal"><a href="#__codelineno-0-886"> 886</a></span>
<span class="normal"><a href="#__codelineno-0-887"> 887</a></span>
<span class="normal"><a href="#__codelineno-0-888"> 888</a></span>
<span class="normal"><a href="#__codelineno-0-889"> 889</a></span>
<span class="normal"><a href="#__codelineno-0-890"> 890</a></span>
<span class="normal"><a href="#__codelineno-0-891"> 891</a></span>
<span class="normal"><a href="#__codelineno-0-892"> 892</a></span>
<span class="normal"><a href="#__codelineno-0-893"> 893</a></span>
<span class="normal"><a href="#__codelineno-0-894"> 894</a></span>
<span class="normal"><a href="#__codelineno-0-895"> 895</a></span>
<span class="normal"><a href="#__codelineno-0-896"> 896</a></span>
<span class="normal"><a href="#__codelineno-0-897"> 897</a></span>
<span class="normal"><a href="#__codelineno-0-898"> 898</a></span>
<span class="normal"><a href="#__codelineno-0-899"> 899</a></span>
<span class="normal"><a href="#__codelineno-0-900"> 900</a></span>
<span class="normal"><a href="#__codelineno-0-901"> 901</a></span>
<span class="normal"><a href="#__codelineno-0-902"> 902</a></span>
<span class="normal"><a href="#__codelineno-0-903"> 903</a></span>
<span class="normal"><a href="#__codelineno-0-904"> 904</a></span>
<span class="normal"><a href="#__codelineno-0-905"> 905</a></span>
<span class="normal"><a href="#__codelineno-0-906"> 906</a></span>
<span class="normal"><a href="#__codelineno-0-907"> 907</a></span>
<span class="normal"><a href="#__codelineno-0-908"> 908</a></span>
<span class="normal"><a href="#__codelineno-0-909"> 909</a></span>
<span class="normal"><a href="#__codelineno-0-910"> 910</a></span>
<span class="normal"><a href="#__codelineno-0-911"> 911</a></span>
<span class="normal"><a href="#__codelineno-0-912"> 912</a></span>
<span class="normal"><a href="#__codelineno-0-913"> 913</a></span>
<span class="normal"><a href="#__codelineno-0-914"> 914</a></span>
<span class="normal"><a href="#__codelineno-0-915"> 915</a></span>
<span class="normal"><a href="#__codelineno-0-916"> 916</a></span>
<span class="normal"><a href="#__codelineno-0-917"> 917</a></span>
<span class="normal"><a href="#__codelineno-0-918"> 918</a></span>
<span class="normal"><a href="#__codelineno-0-919"> 919</a></span>
<span class="normal"><a href="#__codelineno-0-920"> 920</a></span>
<span class="normal"><a href="#__codelineno-0-921"> 921</a></span>
<span class="normal"><a href="#__codelineno-0-922"> 922</a></span>
<span class="normal"><a href="#__codelineno-0-923"> 923</a></span>
<span class="normal"><a href="#__codelineno-0-924"> 924</a></span>
<span class="normal"><a href="#__codelineno-0-925"> 925</a></span>
<span class="normal"><a href="#__codelineno-0-926"> 926</a></span>
<span class="normal"><a href="#__codelineno-0-927"> 927</a></span>
<span class="normal"><a href="#__codelineno-0-928"> 928</a></span>
<span class="normal"><a href="#__codelineno-0-929"> 929</a></span>
<span class="normal"><a href="#__codelineno-0-930"> 930</a></span>
<span class="normal"><a href="#__codelineno-0-931"> 931</a></span>
<span class="normal"><a href="#__codelineno-0-932"> 932</a></span>
<span class="normal"><a href="#__codelineno-0-933"> 933</a></span>
<span class="normal"><a href="#__codelineno-0-934"> 934</a></span>
<span class="normal"><a href="#__codelineno-0-935"> 935</a></span>
<span class="normal"><a href="#__codelineno-0-936"> 936</a></span>
<span class="normal"><a href="#__codelineno-0-937"> 937</a></span>
<span class="normal"><a href="#__codelineno-0-938"> 938</a></span>
<span class="normal"><a href="#__codelineno-0-939"> 939</a></span>
<span class="normal"><a href="#__codelineno-0-940"> 940</a></span>
<span class="normal"><a href="#__codelineno-0-941"> 941</a></span>
<span class="normal"><a href="#__codelineno-0-942"> 942</a></span>
<span class="normal"><a href="#__codelineno-0-943"> 943</a></span>
<span class="normal"><a href="#__codelineno-0-944"> 944</a></span>
<span class="normal"><a href="#__codelineno-0-945"> 945</a></span>
<span class="normal"><a href="#__codelineno-0-946"> 946</a></span>
<span class="normal"><a href="#__codelineno-0-947"> 947</a></span>
<span class="normal"><a href="#__codelineno-0-948"> 948</a></span>
<span class="normal"><a href="#__codelineno-0-949"> 949</a></span>
<span class="normal"><a href="#__codelineno-0-950"> 950</a></span>
<span class="normal"><a href="#__codelineno-0-951"> 951</a></span>
<span class="normal"><a href="#__codelineno-0-952"> 952</a></span>
<span class="normal"><a href="#__codelineno-0-953"> 953</a></span>
<span class="normal"><a href="#__codelineno-0-954"> 954</a></span>
<span class="normal"><a href="#__codelineno-0-955"> 955</a></span>
<span class="normal"><a href="#__codelineno-0-956"> 956</a></span>
<span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span>
<span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span>
<span class="normal"><a href="#__codelineno-0-1069">1069</a></span>
<span class="normal"><a href="#__codelineno-0-1070">1070</a></span>
<span class="normal"><a href="#__codelineno-0-1071">1071</a></span>
<span class="normal"><a href="#__codelineno-0-1072">1072</a></span>
<span class="normal"><a href="#__codelineno-0-1073">1073</a></span>
<span class="normal"><a href="#__codelineno-0-1074">1074</a></span>
<span class="normal"><a href="#__codelineno-0-1075">1075</a></span>
<span class="normal"><a href="#__codelineno-0-1076">1076</a></span>
<span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span>
<span class="normal"><a href="#__codelineno-0-1081">1081</a></span>
<span class="normal"><a href="#__codelineno-0-1082">1082</a></span>
<span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span>
<span class="normal"><a href="#__codelineno-0-1114">1114</a></span>
<span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span>
<span class="normal"><a href="#__codelineno-0-1124">1124</a></span>
<span class="normal"><a href="#__codelineno-0-1125">1125</a></span>
<span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span>
<span class="normal"><a href="#__codelineno-0-1142">1142</a></span>
<span class="normal"><a href="#__codelineno-0-1143">1143</a></span>
<span class="normal"><a href="#__codelineno-0-1144">1144</a></span>
<span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span>
<span class="normal"><a href="#__codelineno-0-1166">1166</a></span>
<span class="normal"><a href="#__codelineno-0-1167">1167</a></span>
<span class="normal"><a href="#__codelineno-0-1168">1168</a></span>
<span class="normal"><a href="#__codelineno-0-1169">1169</a></span>
<span class="normal"><a href="#__codelineno-0-1170">1170</a></span>
<span class="normal"><a href="#__codelineno-0-1171">1171</a></span>
<span class="normal"><a href="#__codelineno-0-1172">1172</a></span>
<span class="normal"><a href="#__codelineno-0-1173">1173</a></span>
<span class="normal"><a href="#__codelineno-0-1174">1174</a></span>
<span class="normal"><a href="#__codelineno-0-1175">1175</a></span>
<span class="normal"><a href="#__codelineno-0-1176">1176</a></span>
<span class="normal"><a href="#__codelineno-0-1177">1177</a></span>
<span class="normal"><a href="#__codelineno-0-1178">1178</a></span>
<span class="normal"><a href="#__codelineno-0-1179">1179</a></span>
<span class="normal"><a href="#__codelineno-0-1180">1180</a></span>
<span class="normal"><a href="#__codelineno-0-1181">1181</a></span>
<span class="normal"><a href="#__codelineno-0-1182">1182</a></span>
<span class="normal"><a href="#__codelineno-0-1183">1183</a></span>
<span class="normal"><a href="#__codelineno-0-1184">1184</a></span>
<span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span>
<span class="normal"><a href="#__codelineno-0-1187">1187</a></span>
<span class="normal"><a href="#__codelineno-0-1188">1188</a></span>
<span class="normal"><a href="#__codelineno-0-1189">1189</a></span>
<span class="normal"><a href="#__codelineno-0-1190">1190</a></span>
<span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span>
<span class="normal"><a href="#__codelineno-0-1199">1199</a></span>
<span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span>
<span class="normal"><a href="#__codelineno-0-1236">1236</a></span>
<span class="normal"><a href="#__codelineno-0-1237">1237</a></span>
<span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span>
<span class="normal"><a href="#__codelineno-0-1244">1244</a></span>
<span class="normal"><a href="#__codelineno-0-1245">1245</a></span>
<span class="normal"><a href="#__codelineno-0-1246">1246</a></span>
<span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span>
<span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span>
<span class="normal"><a href="#__codelineno-0-1308">1308</a></span>
<span class="normal"><a href="#__codelineno-0-1309">1309</a></span>
<span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span>
<span class="normal"><a href="#__codelineno-0-1312">1312</a></span>
<span class="normal"><a href="#__codelineno-0-1313">1313</a></span>
<span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span>
<span class="normal"><a href="#__codelineno-0-1545">1545</a></span>
<span class="normal"><a href="#__codelineno-0-1546">1546</a></span>
<span class="normal"><a href="#__codelineno-0-1547">1547</a></span>
<span class="normal"><a href="#__codelineno-0-1548">1548</a></span>
<span class="normal"><a href="#__codelineno-0-1549">1549</a></span>
<span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span>
<span class="normal"><a href="#__codelineno-0-1568">1568</a></span>
<span class="normal"><a href="#__codelineno-0-1569">1569</a></span>
<span class="normal"><a href="#__codelineno-0-1570">1570</a></span>
<span class="normal"><a href="#__codelineno-0-1571">1571</a></span>
<span class="normal"><a href="#__codelineno-0-1572">1572</a></span>
<span class="normal"><a href="#__codelineno-0-1573">1573</a></span>
<span class="normal"><a href="#__codelineno-0-1574">1574</a></span>
<span class="normal"><a href="#__codelineno-0-1575">1575</a></span>
<span class="normal"><a href="#__codelineno-0-1576">1576</a></span>
<span class="normal"><a href="#__codelineno-0-1577">1577</a></span>
<span class="normal"><a href="#__codelineno-0-1578">1578</a></span>
<span class="normal"><a href="#__codelineno-0-1579">1579</a></span>
<span class="normal"><a href="#__codelineno-0-1580">1580</a></span>
<span class="normal"><a href="#__codelineno-0-1581">1581</a></span>
<span class="normal"><a href="#__codelineno-0-1582">1582</a></span>
<span class="normal"><a href="#__codelineno-0-1583">1583</a></span>
<span class="normal"><a href="#__codelineno-0-1584">1584</a></span>
<span class="normal"><a href="#__codelineno-0-1585">1585</a></span>
<span class="normal"><a href="#__codelineno-0-1586">1586</a></span>
<span class="normal"><a href="#__codelineno-0-1587">1587</a></span>
<span class="normal"><a href="#__codelineno-0-1588">1588</a></span>
<span class="normal"><a href="#__codelineno-0-1589">1589</a></span>
<span class="normal"><a href="#__codelineno-0-1590">1590</a></span>
<span class="normal"><a href="#__codelineno-0-1591">1591</a></span>
<span class="normal"><a href="#__codelineno-0-1592">1592</a></span>
<span class="normal"><a href="#__codelineno-0-1593">1593</a></span>
<span class="normal"><a href="#__codelineno-0-1594">1594</a></span>
<span class="normal"><a href="#__codelineno-0-1595">1595</a></span>
<span class="normal"><a href="#__codelineno-0-1596">1596</a></span>
<span class="normal"><a href="#__codelineno-0-1597">1597</a></span>
<span class="normal"><a href="#__codelineno-0-1598">1598</a></span>
<span class="normal"><a href="#__codelineno-0-1599">1599</a></span>
<span class="normal"><a href="#__codelineno-0-1600">1600</a></span>
<span class="normal"><a href="#__codelineno-0-1601">1601</a></span>
<span class="normal"><a href="#__codelineno-0-1602">1602</a></span>
<span class="normal"><a href="#__codelineno-0-1603">1603</a></span>
<span class="normal"><a href="#__codelineno-0-1604">1604</a></span>
<span class="normal"><a href="#__codelineno-0-1605">1605</a></span>
<span class="normal"><a href="#__codelineno-0-1606">1606</a></span>
<span class="normal"><a href="#__codelineno-0-1607">1607</a></span>
<span class="normal"><a href="#__codelineno-0-1608">1608</a></span>
<span class="normal"><a href="#__codelineno-0-1609">1609</a></span>
<span class="normal"><a href="#__codelineno-0-1610">1610</a></span>
<span class="normal"><a href="#__codelineno-0-1611">1611</a></span>
<span class="normal"><a href="#__codelineno-0-1612">1612</a></span>
<span class="normal"><a href="#__codelineno-0-1613">1613</a></span>
<span class="normal"><a href="#__codelineno-0-1614">1614</a></span>
<span class="normal"><a href="#__codelineno-0-1615">1615</a></span>
<span class="normal"><a href="#__codelineno-0-1616">1616</a></span>
<span class="normal"><a href="#__codelineno-0-1617">1617</a></span>
<span class="normal"><a href="#__codelineno-0-1618">1618</a></span>
<span class="normal"><a href="#__codelineno-0-1619">1619</a></span>
<span class="normal"><a href="#__codelineno-0-1620">1620</a></span>
<span class="normal"><a href="#__codelineno-0-1621">1621</a></span>
<span class="normal"><a href="#__codelineno-0-1622">1622</a></span>
<span class="normal"><a href="#__codelineno-0-1623">1623</a></span>
<span class="normal"><a href="#__codelineno-0-1624">1624</a></span>
<span class="normal"><a href="#__codelineno-0-1625">1625</a></span>
<span class="normal"><a href="#__codelineno-0-1626">1626</a></span>
<span class="normal"><a href="#__codelineno-0-1627">1627</a></span>
<span class="normal"><a href="#__codelineno-0-1628">1628</a></span>
<span class="normal"><a href="#__codelineno-0-1629">1629</a></span>
<span class="normal"><a href="#__codelineno-0-1630">1630</a></span>
<span class="normal"><a href="#__codelineno-0-1631">1631</a></span>
<span class="normal"><a href="#__codelineno-0-1632">1632</a></span>
<span class="normal"><a href="#__codelineno-0-1633">1633</a></span>
<span class="normal"><a href="#__codelineno-0-1634">1634</a></span>
<span class="normal"><a href="#__codelineno-0-1635">1635</a></span>
<span class="normal"><a href="#__codelineno-0-1636">1636</a></span>
<span class="normal"><a href="#__codelineno-0-1637">1637</a></span>
<span class="normal"><a href="#__codelineno-0-1638">1638</a></span>
<span class="normal"><a href="#__codelineno-0-1639">1639</a></span>
<span class="normal"><a href="#__codelineno-0-1640">1640</a></span>
<span class="normal"><a href="#__codelineno-0-1641">1641</a></span>
<span class="normal"><a href="#__codelineno-0-1642">1642</a></span>
<span class="normal"><a href="#__codelineno-0-1643">1643</a></span>
<span class="normal"><a href="#__codelineno-0-1644">1644</a></span>
<span class="normal"><a href="#__codelineno-0-1645">1645</a></span>
<span class="normal"><a href="#__codelineno-0-1646">1646</a></span>
<span class="normal"><a href="#__codelineno-0-1647">1647</a></span>
<span class="normal"><a href="#__codelineno-0-1648">1648</a></span>
<span class="normal"><a href="#__codelineno-0-1649">1649</a></span>
<span class="normal"><a href="#__codelineno-0-1650">1650</a></span>
<span class="normal"><a href="#__codelineno-0-1651">1651</a></span>
<span class="normal"><a href="#__codelineno-0-1652">1652</a></span>
<span class="normal"><a href="#__codelineno-0-1653">1653</a></span>
<span class="normal"><a href="#__codelineno-0-1654">1654</a></span>
<span class="normal"><a href="#__codelineno-0-1655">1655</a></span>
<span class="normal"><a href="#__codelineno-0-1656">1656</a></span>
<span class="normal"><a href="#__codelineno-0-1657">1657</a></span>
<span class="normal"><a href="#__codelineno-0-1658">1658</a></span>
<span class="normal"><a href="#__codelineno-0-1659">1659</a></span>
<span class="normal"><a href="#__codelineno-0-1660">1660</a></span>
<span class="normal"><a href="#__codelineno-0-1661">1661</a></span>
<span class="normal"><a href="#__codelineno-0-1662">1662</a></span>
<span class="normal"><a href="#__codelineno-0-1663">1663</a></span>
<span class="normal"><a href="#__codelineno-0-1664">1664</a></span>
<span class="normal"><a href="#__codelineno-0-1665">1665</a></span>
<span class="normal"><a href="#__codelineno-0-1666">1666</a></span>
<span class="normal"><a href="#__codelineno-0-1667">1667</a></span>
<span class="normal"><a href="#__codelineno-0-1668">1668</a></span>
<span class="normal"><a href="#__codelineno-0-1669">1669</a></span>
<span class="normal"><a href="#__codelineno-0-1670">1670</a></span>
<span class="normal"><a href="#__codelineno-0-1671">1671</a></span>
<span class="normal"><a href="#__codelineno-0-1672">1672</a></span>
<span class="normal"><a href="#__codelineno-0-1673">1673</a></span>
<span class="normal"><a href="#__codelineno-0-1674">1674</a></span>
<span class="normal"><a href="#__codelineno-0-1675">1675</a></span>
<span class="normal"><a href="#__codelineno-0-1676">1676</a></span>
<span class="normal"><a href="#__codelineno-0-1677">1677</a></span>
<span class="normal"><a href="#__codelineno-0-1678">1678</a></span>
<span class="normal"><a href="#__codelineno-0-1679">1679</a></span>
<span class="normal"><a href="#__codelineno-0-1680">1680</a></span>
<span class="normal"><a href="#__codelineno-0-1681">1681</a></span>
<span class="normal"><a href="#__codelineno-0-1682">1682</a></span>
<span class="normal"><a href="#__codelineno-0-1683">1683</a></span>
<span class="normal"><a href="#__codelineno-0-1684">1684</a></span>
<span class="normal"><a href="#__codelineno-0-1685">1685</a></span>
<span class="normal"><a href="#__codelineno-0-1686">1686</a></span>
<span class="normal"><a href="#__codelineno-0-1687">1687</a></span>
<span class="normal"><a href="#__codelineno-0-1688">1688</a></span>
<span class="normal"><a href="#__codelineno-0-1689">1689</a></span>
<span class="normal"><a href="#__codelineno-0-1690">1690</a></span>
<span class="normal"><a href="#__codelineno-0-1691">1691</a></span>
<span class="normal"><a href="#__codelineno-0-1692">1692</a></span>
<span class="normal"><a href="#__codelineno-0-1693">1693</a></span>
<span class="normal"><a href="#__codelineno-0-1694">1694</a></span>
<span class="normal"><a href="#__codelineno-0-1695">1695</a></span>
<span class="normal"><a href="#__codelineno-0-1696">1696</a></span>
<span class="normal"><a href="#__codelineno-0-1697">1697</a></span>
<span class="normal"><a href="#__codelineno-0-1698">1698</a></span>
<span class="normal"><a href="#__codelineno-0-1699">1699</a></span>
<span class="normal"><a href="#__codelineno-0-1700">1700</a></span>
<span class="normal"><a href="#__codelineno-0-1701">1701</a></span>
<span class="normal"><a href="#__codelineno-0-1702">1702</a></span>
<span class="normal"><a href="#__codelineno-0-1703">1703</a></span>
<span class="normal"><a href="#__codelineno-0-1704">1704</a></span>
<span class="normal"><a href="#__codelineno-0-1705">1705</a></span>
<span class="normal"><a href="#__codelineno-0-1706">1706</a></span>
<span class="normal"><a href="#__codelineno-0-1707">1707</a></span>
<span class="normal"><a href="#__codelineno-0-1708">1708</a></span>
<span class="normal"><a href="#__codelineno-0-1709">1709</a></span>
<span class="normal"><a href="#__codelineno-0-1710">1710</a></span>
<span class="normal"><a href="#__codelineno-0-1711">1711</a></span>
<span class="normal"><a href="#__codelineno-0-1712">1712</a></span>
<span class="normal"><a href="#__codelineno-0-1713">1713</a></span>
<span class="normal"><a href="#__codelineno-0-1714">1714</a></span>
<span class="normal"><a href="#__codelineno-0-1715">1715</a></span>
<span class="normal"><a href="#__codelineno-0-1716">1716</a></span>
<span class="normal"><a href="#__codelineno-0-1717">1717</a></span>
<span class="normal"><a href="#__codelineno-0-1718">1718</a></span>
<span class="normal"><a href="#__codelineno-0-1719">1719</a></span>
<span class="normal"><a href="#__codelineno-0-1720">1720</a></span>
<span class="normal"><a href="#__codelineno-0-1721">1721</a></span>
<span class="normal"><a href="#__codelineno-0-1722">1722</a></span>
<span class="normal"><a href="#__codelineno-0-1723">1723</a></span>
<span class="normal"><a href="#__codelineno-0-1724">1724</a></span>
<span class="normal"><a href="#__codelineno-0-1725">1725</a></span>
<span class="normal"><a href="#__codelineno-0-1726">1726</a></span>
<span class="normal"><a href="#__codelineno-0-1727">1727</a></span>
<span class="normal"><a href="#__codelineno-0-1728">1728</a></span>
<span class="normal"><a href="#__codelineno-0-1729">1729</a></span>
<span class="normal"><a href="#__codelineno-0-1730">1730</a></span>
<span class="normal"><a href="#__codelineno-0-1731">1731</a></span>
<span class="normal"><a href="#__codelineno-0-1732">1732</a></span>
<span class="normal"><a href="#__codelineno-0-1733">1733</a></span>
<span class="normal"><a href="#__codelineno-0-1734">1734</a></span>
<span class="normal"><a href="#__codelineno-0-1735">1735</a></span>
<span class="normal"><a href="#__codelineno-0-1736">1736</a></span>
<span class="normal"><a href="#__codelineno-0-1737">1737</a></span>
<span class="normal"><a href="#__codelineno-0-1738">1738</a></span>
<span class="normal"><a href="#__codelineno-0-1739">1739</a></span>
<span class="normal"><a href="#__codelineno-0-1740">1740</a></span>
<span class="normal"><a href="#__codelineno-0-1741">1741</a></span>
<span class="normal"><a href="#__codelineno-0-1742">1742</a></span>
<span class="normal"><a href="#__codelineno-0-1743">1743</a></span>
<span class="normal"><a href="#__codelineno-0-1744">1744</a></span>
<span class="normal"><a href="#__codelineno-0-1745">1745</a></span>
<span class="normal"><a href="#__codelineno-0-1746">1746</a></span>
<span class="normal"><a href="#__codelineno-0-1747">1747</a></span>
<span class="normal"><a href="#__codelineno-0-1748">1748</a></span>
<span class="normal"><a href="#__codelineno-0-1749">1749</a></span>
<span class="normal"><a href="#__codelineno-0-1750">1750</a></span>
<span class="normal"><a href="#__codelineno-0-1751">1751</a></span>
<span class="normal"><a href="#__codelineno-0-1752">1752</a></span>
<span class="normal"><a href="#__codelineno-0-1753">1753</a></span>
<span class="normal"><a href="#__codelineno-0-1754">1754</a></span>
<span class="normal"><a href="#__codelineno-0-1755">1755</a></span>
<span class="normal"><a href="#__codelineno-0-1756">1756</a></span>
<span class="normal"><a href="#__codelineno-0-1757">1757</a></span>
<span class="normal"><a href="#__codelineno-0-1758">1758</a></span>
<span class="normal"><a href="#__codelineno-0-1759">1759</a></span>
<span class="normal"><a href="#__codelineno-0-1760">1760</a></span>
<span class="normal"><a href="#__codelineno-0-1761">1761</a></span>
<span class="normal"><a href="#__codelineno-0-1762">1762</a></span>
<span class="normal"><a href="#__codelineno-0-1763">1763</a></span>
<span class="normal"><a href="#__codelineno-0-1764">1764</a></span>
<span class="normal"><a href="#__codelineno-0-1765">1765</a></span>
<span class="normal"><a href="#__codelineno-0-1766">1766</a></span>
<span class="normal"><a href="#__codelineno-0-1767">1767</a></span>
<span class="normal"><a href="#__codelineno-0-1768">1768</a></span>
<span class="normal"><a href="#__codelineno-0-1769">1769</a></span>
<span class="normal"><a href="#__codelineno-0-1770">1770</a></span>
<span class="normal"><a href="#__codelineno-0-1771">1771</a></span>
<span class="normal"><a href="#__codelineno-0-1772">1772</a></span>
<span class="normal"><a href="#__codelineno-0-1773">1773</a></span>
<span class="normal"><a href="#__codelineno-0-1774">1774</a></span>
<span class="normal"><a href="#__codelineno-0-1775">1775</a></span>
<span class="normal"><a href="#__codelineno-0-1776">1776</a></span>
<span class="normal"><a href="#__codelineno-0-1777">1777</a></span>
<span class="normal"><a href="#__codelineno-0-1778">1778</a></span>
<span class="normal"><a href="#__codelineno-0-1779">1779</a></span>
<span class="normal"><a href="#__codelineno-0-1780">1780</a></span>
<span class="normal"><a href="#__codelineno-0-1781">1781</a></span>
<span class="normal"><a href="#__codelineno-0-1782">1782</a></span>
<span class="normal"><a href="#__codelineno-0-1783">1783</a></span>
<span class="normal"><a href="#__codelineno-0-1784">1784</a></span>
<span class="normal"><a href="#__codelineno-0-1785">1785</a></span>
<span class="normal"><a href="#__codelineno-0-1786">1786</a></span>
<span class="normal"><a href="#__codelineno-0-1787">1787</a></span>
<span class="normal"><a href="#__codelineno-0-1788">1788</a></span>
<span class="normal"><a href="#__codelineno-0-1789">1789</a></span>
<span class="normal"><a href="#__codelineno-0-1790">1790</a></span>
<span class="normal"><a href="#__codelineno-0-1791">1791</a></span>
<span class="normal"><a href="#__codelineno-0-1792">1792</a></span>
<span class="normal"><a href="#__codelineno-0-1793">1793</a></span>
<span class="normal"><a href="#__codelineno-0-1794">1794</a></span>
<span class="normal"><a href="#__codelineno-0-1795">1795</a></span>
<span class="normal"><a href="#__codelineno-0-1796">1796</a></span>
<span class="normal"><a href="#__codelineno-0-1797">1797</a></span>
<span class="normal"><a href="#__codelineno-0-1798">1798</a></span>
<span class="normal"><a href="#__codelineno-0-1799">1799</a></span>
<span class="normal"><a href="#__codelineno-0-1800">1800</a></span>
<span class="normal"><a href="#__codelineno-0-1801">1801</a></span>
<span class="normal"><a href="#__codelineno-0-1802">1802</a></span>
<span class="normal"><a href="#__codelineno-0-1803">1803</a></span>
<span class="normal"><a href="#__codelineno-0-1804">1804</a></span>
<span class="normal"><a href="#__codelineno-0-1805">1805</a></span>
<span class="normal"><a href="#__codelineno-0-1806">1806</a></span>
<span class="normal"><a href="#__codelineno-0-1807">1807</a></span>
<span class="normal"><a href="#__codelineno-0-1808">1808</a></span>
<span class="normal"><a href="#__codelineno-0-1809">1809</a></span>
<span class="normal"><a href="#__codelineno-0-1810">1810</a></span>
<span class="normal"><a href="#__codelineno-0-1811">1811</a></span>
<span class="normal"><a href="#__codelineno-0-1812">1812</a></span>
<span class="normal"><a href="#__codelineno-0-1813">1813</a></span>
<span class="normal"><a href="#__codelineno-0-1814">1814</a></span>
<span class="normal"><a href="#__codelineno-0-1815">1815</a></span>
<span class="normal"><a href="#__codelineno-0-1816">1816</a></span>
<span class="normal"><a href="#__codelineno-0-1817">1817</a></span>
<span class="normal"><a href="#__codelineno-0-1818">1818</a></span>
<span class="normal"><a href="#__codelineno-0-1819">1819</a></span>
<span class="normal"><a href="#__codelineno-0-1820">1820</a></span>
<span class="normal"><a href="#__codelineno-0-1821">1821</a></span>
<span class="normal"><a href="#__codelineno-0-1822">1822</a></span>
<span class="normal"><a href="#__codelineno-0-1823">1823</a></span>
<span class="normal"><a href="#__codelineno-0-1824">1824</a></span>
<span class="normal"><a href="#__codelineno-0-1825">1825</a></span>
<span class="normal"><a href="#__codelineno-0-1826">1826</a></span>
<span class="normal"><a href="#__codelineno-0-1827">1827</a></span>
<span class="normal"><a href="#__codelineno-0-1828">1828</a></span>
<span class="normal"><a href="#__codelineno-0-1829">1829</a></span>
<span class="normal"><a href="#__codelineno-0-1830">1830</a></span>
<span class="normal"><a href="#__codelineno-0-1831">1831</a></span>
<span class="normal"><a href="#__codelineno-0-1832">1832</a></span>
<span class="normal"><a href="#__codelineno-0-1833">1833</a></span>
<span class="normal"><a href="#__codelineno-0-1834">1834</a></span>
<span class="normal"><a href="#__codelineno-0-1835">1835</a></span>
<span class="normal"><a href="#__codelineno-0-1836">1836</a></span>
<span class="normal"><a href="#__codelineno-0-1837">1837</a></span>
<span class="normal"><a href="#__codelineno-0-1838">1838</a></span>
<span class="normal"><a href="#__codelineno-0-1839">1839</a></span>
<span class="normal"><a href="#__codelineno-0-1840">1840</a></span>
<span class="normal"><a href="#__codelineno-0-1841">1841</a></span>
<span class="normal"><a href="#__codelineno-0-1842">1842</a></span>
<span class="normal"><a href="#__codelineno-0-1843">1843</a></span>
<span class="normal"><a href="#__codelineno-0-1844">1844</a></span>
<span class="normal"><a href="#__codelineno-0-1845">1845</a></span>
<span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span>
<span class="normal"><a href="#__codelineno-0-1857">1857</a></span>
<span class="normal"><a href="#__codelineno-0-1858">1858</a></span>
<span class="normal"><a href="#__codelineno-0-1859">1859</a></span>
<span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span>
<span class="normal"><a href="#__codelineno-0-1893">1893</a></span>
<span class="normal"><a href="#__codelineno-0-1894">1894</a></span>
<span class="normal"><a href="#__codelineno-0-1895">1895</a></span>
<span class="normal"><a href="#__codelineno-0-1896">1896</a></span>
<span class="normal"><a href="#__codelineno-0-1897">1897</a></span>
<span class="normal"><a href="#__codelineno-0-1898">1898</a></span>
<span class="normal"><a href="#__codelineno-0-1899">1899</a></span>
<span class="normal"><a href="#__codelineno-0-1900">1900</a></span>
<span class="normal"><a href="#__codelineno-0-1901">1901</a></span>
<span class="normal"><a href="#__codelineno-0-1902">1902</a></span>
<span class="normal"><a href="#__codelineno-0-1903">1903</a></span>
<span class="normal"><a href="#__codelineno-0-1904">1904</a></span>
<span class="normal"><a href="#__codelineno-0-1905">1905</a></span>
<span class="normal"><a href="#__codelineno-0-1906">1906</a></span>
<span class="normal"><a href="#__codelineno-0-1907">1907</a></span>
<span class="normal"><a href="#__codelineno-0-1908">1908</a></span>
<span class="normal"><a href="#__codelineno-0-1909">1909</a></span>
<span class="normal"><a href="#__codelineno-0-1910">1910</a></span>
<span class="normal"><a href="#__codelineno-0-1911">1911</a></span>
<span class="normal"><a href="#__codelineno-0-1912">1912</a></span>
<span class="normal"><a href="#__codelineno-0-1913">1913</a></span>
<span class="normal"><a href="#__codelineno-0-1914">1914</a></span>
<span class="normal"><a href="#__codelineno-0-1915">1915</a></span>
<span class="normal"><a href="#__codelineno-0-1916">1916</a></span>
<span class="normal"><a href="#__codelineno-0-1917">1917</a></span>
<span class="normal"><a href="#__codelineno-0-1918">1918</a></span>
<span class="normal"><a href="#__codelineno-0-1919">1919</a></span>
<span class="normal"><a href="#__codelineno-0-1920">1920</a></span>
<span class="normal"><a href="#__codelineno-0-1921">1921</a></span>
<span class="normal"><a href="#__codelineno-0-1922">1922</a></span>
<span class="normal"><a href="#__codelineno-0-1923">1923</a></span>
<span class="normal"><a href="#__codelineno-0-1924">1924</a></span>
<span class="normal"><a href="#__codelineno-0-1925">1925</a></span>
<span class="normal"><a href="#__codelineno-0-1926">1926</a></span>
<span class="normal"><a href="#__codelineno-0-1927">1927</a></span>
<span class="normal"><a href="#__codelineno-0-1928">1928</a></span>
<span class="normal"><a href="#__codelineno-0-1929">1929</a></span>
<span class="normal"><a href="#__codelineno-0-1930">1930</a></span>
<span class="normal"><a href="#__codelineno-0-1931">1931</a></span>
<span class="normal"><a href="#__codelineno-0-1932">1932</a></span>
<span class="normal"><a href="#__codelineno-0-1933">1933</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="k">class</span><span class="w"> </span><span class="nc">Calibration</span><span class="p">(</span><span class="n">Serializable</span><span class="p">):</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    Survey calibration using entropy balancing methods.</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    Calibration adjusts survey weights to match known population moments (targets) while</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    minimizing the distance from base weights.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    df : IntoFrameT</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        Input dataframe containing the survey data to be calibrated.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    moments : list[Moment | str] | Moment | str | None, optional</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        Moment objects or paths to saved moments defining calibration targets.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        Can be a single Moment, list of Moments, or paths to saved Moment files.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        Default is None.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    missing_to_zero : bool, optional</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        Whether to fill missing values with zero before calibration. Default is True.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    index : list[str] | None, optional</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        Column names to use as unique identifiers for observations. If None,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        a row number index will be created. Default is None.</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    weight : str, optional</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        Column name containing base weights. If empty string, uniform weights</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        of 1 will be created. Default is &quot;&quot;.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    initial_guess : str, optional</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        Column name for initial weight guesses to improve convergence. Default is &quot;&quot;.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    final_weight : str, optional</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        Column name for output calibrated weights. If empty, defaults to</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        &quot;___final_weight&quot;. Default is &quot;&quot;.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    aggregation : str, optional</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        How to combine multiple moments: &quot;Combined&quot; (all at once), &quot;Sequential&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        (one at a time), or &quot;Both&quot; (sequential first, then combined if needed).</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        Default is &quot;Combined&quot;.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    iterations : int, optional</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        Maximum number of iterations for calibration algorithm. If -1, uses</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        method-specific defaults (50 for aebw, 250 for legacy_ebw). Default is -1.</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    iterations_loop : int, optional</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        Maximum number of loops for sequential/trimmed calibration. Default is 20.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">    tolerance : float, optional</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        Convergence tolerance for maximum difference between targets and estimates.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        Default is 0.00001.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    Attributes</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">    df : IntoFrameT</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        Dataframe with calibrated weights in the final_weight column.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    moments : list[Moment]</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        List of Moment objects used for calibration.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    diagnostics_out : dict | None</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        Dictionary containing convergence status and diagnostic dataframe after</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        running calibration.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">    Examples</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    --------</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    Basic calibration to match population totals:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    &gt;&gt;&gt; import polars as pl</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">    &gt;&gt;&gt; from survey_kit.calibration import Calibration, Moment</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    &gt;&gt;&gt;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">    &gt;&gt;&gt; # Create sample data</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    &gt;&gt;&gt; df = pl.DataFrame({</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    &gt;&gt;&gt;     &quot;id&quot;: range(100),</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">    &gt;&gt;&gt;     &quot;age_group&quot;: [&quot;18-34&quot;, &quot;35-54&quot;, &quot;55+&quot;] * 33 + [&quot;18-34&quot;],</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    &gt;&gt;&gt;     &quot;region&quot;: [&quot;North&quot;, &quot;South&quot;] * 50,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    &gt;&gt;&gt;     &quot;base_weight&quot;: [1.0] * 100</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">    &gt;&gt;&gt; })</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    &gt;&gt;&gt;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">    &gt;&gt;&gt; # Define target moments</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">    &gt;&gt;&gt; age_moment = Moment(df=df, formula=&quot;C(age_group)&quot;, weight=&quot;base_weight&quot;)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    &gt;&gt;&gt;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">    &gt;&gt;&gt; # Run calibration</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">    &gt;&gt;&gt; c = Calibration(df=df, moments=[age_moment], weight=&quot;base_weight&quot;)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    &gt;&gt;&gt; results = c.run()</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    &gt;&gt;&gt;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    &gt;&gt;&gt; # Get the calibrated weights (appended to the original data)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    &gt;&gt;&gt; calibrated_df = c.get_final_weights(df)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Multiple moments with sequential calibration:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    &gt;&gt;&gt; region_moment = Moment(df=df, formula=&quot;C(region)&quot;, weight=&quot;base_weight&quot;)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    &gt;&gt;&gt; c = Calibration(</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    &gt;&gt;&gt;     df=df,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    &gt;&gt;&gt;     moments=[age_moment, region_moment],</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    &gt;&gt;&gt;     aggregation=&quot;Sequential&quot;,</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">    &gt;&gt;&gt;     weight=&quot;base_weight&quot;</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">    &gt;&gt;&gt; )</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">    &gt;&gt;&gt; results = c.run(min_obs=10)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    With weight trimming:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    &gt;&gt;&gt; from survey_kit.calibration.trim import Trim</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    &gt;&gt;&gt; trim_params = Trim(trim=True, min_val=0.2, max_val=3.0)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    &gt;&gt;&gt; results = c.run(trim=trim_params, min_obs=[0, 10, 50])</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">    -----</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">    - The calibration preserves the total sum of weights while adjusting individual</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">    weight values to match target moments.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">    - Sequential aggregation calibrates to each moment one at a time, while combined</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">    aggregation solves for all moments simultaneously.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">    - The &quot;Both&quot; aggregation tries sequential first and falls back to combined if</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">    convergence criteria aren&#39;t met.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">    - Use min_obs parameter to exclude moments with too few non-zero observations,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">    which can cause convergence issues.</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">_save_suffix</span> <span class="o">=</span> <span class="s2">&quot;calibration&quot;</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">_save_exclude_items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nw_type&quot;</span><span class="p">]</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">df</span><span class="p">:</span> <span class="n">IntoFrameT</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">moments</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Moment</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">Moment</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">missing_to_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">index</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">weight</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="n">initial_guess</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="n">final_weight</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Combined&quot;</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">iterations_loop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00001</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="p">):</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="n">moments</span> <span class="o">=</span> <span class="n">list_input</span><span class="p">(</span><span class="n">moments</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">list_input</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="c1">#   Pending other optimizations?</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;aebw&quot;</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="n">acceptableMethods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aebw&quot;</span><span class="p">,</span> <span class="s2">&quot;legacy_ebw&quot;</span><span class="p">]</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">bAcceptableMethods</span> <span class="o">=</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">acceptableMethods</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">acceptableAggregations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Combined&quot;</span><span class="p">,</span> <span class="s2">&quot;Sequential&quot;</span><span class="p">,</span> <span class="s2">&quot;Both&quot;</span><span class="p">]</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">bAcceptableAggregation</span> <span class="o">=</span> <span class="n">aggregation</span> <span class="ow">in</span> <span class="n">acceptableAggregations</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">bAcceptableMethods</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ONLY </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">acceptableMethods</span><span class="p">)</span><span class="si">}</span><span class="s2"> ARE ACCEPTABLE METHODS - passed(</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">bAcceptableAggregation</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ONLY </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">acceptableAggregations</span><span class="p">)</span><span class="si">}</span><span class="s2"> ARE ACCEPTABLE METHODS - passed(</span><span class="si">{</span><span class="n">aggregation</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">if</span> <span class="n">missing_to_zero</span> <span class="ow">and</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">fill_missing</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="c1">#   Check that base weight is &gt; 0</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">if</span> <span class="n">weight</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">c_weight</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">c_invalid_weights</span> <span class="o">=</span> <span class="n">c_weight</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">c_weight</span><span class="o">.</span><span class="n">is_null</span><span class="p">()</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">n_invalid</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">c_invalid_weights</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="k">if</span> <span class="n">n_invalid</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="sa">f</span><span class="s2">&quot;  Dropping </span><span class="si">{</span><span class="n">n_invalid</span><span class="si">}</span><span class="s2"> observation(s) with invalid base weights (&lt;= 0 or missing)&quot;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">c_invalid_weights</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="c1"># Add an index, if there isn&#39;t one</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="c1">#   We need one to be able to put the file back together again</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;___rownumber&quot;</span><span class="p">]</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="o">.</span><span class="n">with_row_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">weight</span> <span class="o">=</span> <span class="s2">&quot;___ones&quot;</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">weight</span><span class="p">))</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span> <span class="o">=</span> <span class="n">initial_guess</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">if</span> <span class="n">final_weight</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="n">final_weight</span> <span class="o">=</span> <span class="s2">&quot;___final_weight&quot;</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span> <span class="o">=</span> <span class="n">final_weight</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">))</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">=</span> <span class="n">aggregation</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="c1">#   Default values if not passed</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="k">if</span> <span class="n">iterations</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;aebw&quot;</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                <span class="n">iterations</span> <span class="o">=</span> <span class="mi">50</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                <span class="n">iterations</span> <span class="o">=</span> <span class="mi">250</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">iterations</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iterations_loop</span> <span class="o">=</span> <span class="n">iterations_loop</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="c1"># Process each &quot;target&quot; moment passed in</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="c1">#   and create a paired &quot;weight&quot; moment object</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">moments</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">moments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="k">for</span> <span class="n">momenti</span> <span class="ow">in</span> <span class="n">moments</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_single_moment</span><span class="p">(</span><span class="n">momenti</span><span class="p">))</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="c1">#   Placeholder for combined moments when running both sequential and combined</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="c1">#   Placeholder for post-run diagnostics information</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics_out</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_single_moment</span><span class="p">(</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">m_input</span><span class="p">:</span> <span class="n">Moment</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">IntoFrameT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Moment</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="c1"># Clone the moment object - the processed one will be based on the data to calibrate,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="c1">#                           the input one is based on the data passed originally</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="c1">#                           which need not be the same (something should generally differ...)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m_input</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="n">m</span> <span class="o">=</span> <span class="n">Moment</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">m_input</span><span class="p">)</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="n">m</span> <span class="o">=</span> <span class="n">deepcopy_with_fallback</span><span class="p">(</span><span class="n">m_input</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">m</span><span class="o">.</span><span class="n">non_zero_target</span> <span class="o">=</span> <span class="n">m_input</span><span class="o">.</span><span class="n">non_zero</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="n">m</span><span class="o">.</span><span class="n">n_observations_target</span> <span class="o">=</span> <span class="n">m_input</span><span class="o">.</span><span class="n">n_observations</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="n">m</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="n">m</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="n">m</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="n">m</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="n">m</span><span class="o">.</span><span class="n">initialize_moment</span><span class="p">(</span><span class="n">target_moment</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="c1">#   Does this moment have any targets?</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="n">m</span><span class="o">.</span><span class="n">_get_model_matrix</span><span class="p">()</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="n">m</span><span class="o">.</span><span class="n">_get_targets</span><span class="p">(</span><span class="n">non_zero_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="n">m</span><span class="o">.</span><span class="n">n_observations</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="c1">#   Process any submoments</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="n">sub_moments</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="k">for</span> <span class="n">subi</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">:</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                <span class="n">subi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_single_moment</span><span class="p">(</span><span class="n">subi</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="n">sub_moments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subi</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">m</span><span class="o">.</span><span class="n">sub_moments</span> <span class="o">=</span> <span class="n">sub_moments</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compare_moment_variables</span><span class="p">(</span><span class="n">m_target</span><span class="o">=</span><span class="n">m_input</span><span class="p">,</span> <span class="n">m_weight</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="k">return</span> <span class="n">m</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compare_moment_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_target</span><span class="p">:</span> <span class="n">Moment</span><span class="p">,</span> <span class="n">m_weight</span><span class="p">:</span> <span class="n">Moment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">        Do the variables match across source and weighting moments?</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">           Won&#39;t if a value doesn&#39;t exist in one data set that does in the other</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">           If don&#39;t match, set to the intersection of variables - can only weight to the things in both samples</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">        m_target : Moment</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">            Input moment with targets calculated</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">        m_weight : Moment, optional</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">            moment for calibration</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">        -------</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">        None</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="k">if</span> <span class="n">m_target</span><span class="o">.</span><span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">m_weight</span><span class="o">.</span><span class="n">model_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="n">cols_target</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_target</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="n">cols_weight</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_weight</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="n">m_weight</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols_target</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">cols_weight</span><span class="p">))</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">censor_to_min_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_obs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">        In calibration, do we want to limit to moments with greater than some</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">           threshold of observations where x != 0</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">        min_obs : int, optional</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">            The minimum number of != 0 observations.</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="sd">            The default is 0. (don&#39;t censor)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">        -------</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">        None</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="k">for</span> <span class="n">momenti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">:</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_censort_to_min_obs_by_moment</span><span class="p">(</span><span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">momenti</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="k">for</span> <span class="n">subi</span> <span class="ow">in</span> <span class="n">momenti</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">:</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_censort_to_min_obs_by_moment</span><span class="p">(</span><span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">subi</span><span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">censor_to_min_obs</span><span class="p">(</span><span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs</span><span class="p">)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_censort_to_min_obs_by_moment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Moment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">        For each moment, censor, if needed</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">        min_obs : int</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a><span class="sd">            Minimum non-zero observations to censor at</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">        m : Moment</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">            Moment to censor</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">        -------</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">        None</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">non_zero_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="n">nw_type</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">non_zero_target</span><span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="n">nonzero_cols</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                <span class="n">nw_type</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">include_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="n">m</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">nonzero_cols</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">nonzero_cols</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">min_obs</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="p">)[</span><span class="n">nonzero_cols</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">non_zero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="n">nw_type</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">non_zero</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="n">nonzero_cols</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                <span class="n">nw_type</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">include_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="p">)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="n">m</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">nonzero_cols</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">nonzero_cols</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">min_obs</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>            <span class="p">)[</span><span class="n">nonzero_cols</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">combine_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sub_moments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">        To simultaneously weight to lots of moments, we need to combine them</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">            This directly edits the items in self.moments</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">        all : bool, optional</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">            Combine all or just submoments into parent moments?</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a><span class="sd">            The default is False.</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">        sub_moments : bool, optional</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">            Combine submoments?</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="sd">            The default is True.</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">        -------</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">        None</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="k">if</span> <span class="nb">all</span> <span class="ow">or</span> <span class="n">sub_moments</span><span class="p">:</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Aggregating any sub_moments&quot;</span><span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">)):</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_moment_with_sub_moments</span><span class="p">(</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                    <span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="k">if</span> <span class="nb">all</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>            <span class="c1">#   Check that submoments are combined</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>            <span class="k">for</span> <span class="n">momenti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">:</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">momenti</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Must combine sub moments before combining all moments&quot;</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="c1">#   Merge aggregate the moments together into one</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">moments</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_combine_moment_list</span><span class="p">(</span><span class="n">m_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">,</span> <span class="n">with_count_prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="p">]</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_moment_with_sub_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Moment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Moment</span><span class="p">:</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">        Combine this moment and its submoments (i.e. moments by state)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">            into one moment for weighting</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">        m : Moment</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">            Input moment</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">        -------</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">        Moment</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">            The combined moment with no submoments</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>            <span class="c1"># No submoments</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>            <span class="k">return</span> <span class="n">m</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>            <span class="c1"># Combine this with sub, adding by prefix to submoments only</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>            <span class="n">m_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>            <span class="n">prefix_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>            <span class="k">for</span> <span class="n">subi</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">:</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>                <span class="n">m_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subi</span><span class="p">)</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>                <span class="n">prefix_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_moment_list</span><span class="p">(</span><span class="n">m_list</span><span class="o">=</span><span class="n">m_list</span><span class="p">,</span> <span class="n">with_by_prefix</span><span class="o">=</span><span class="n">prefix_list</span><span class="p">)</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>        <span class="k">return</span> <span class="n">m</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_moment_list</span><span class="p">(</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>        <span class="n">m_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Moment</span><span class="p">],</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="n">with_by_prefix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="n">with_count_prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Moment</span><span class="p">:</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>        <span class="c1">#   Combined moment</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="n">m_combined</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="k">for</span> <span class="n">i_moment</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_list</span><span class="p">):</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>            <span class="k">if</span> <span class="n">with_by_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                <span class="n">with_by_prefixi</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">with_by_prefix</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                <span class="n">with_by_prefixi</span> <span class="o">=</span> <span class="n">with_by_prefix</span><span class="p">[</span><span class="n">i_moment</span><span class="p">]</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>                <span class="n">with_by_prefixi</span> <span class="o">=</span> <span class="n">with_by_prefix</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>            <span class="c1">#   Add the prefix?</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_prefix</span><span class="p">(</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>                <span class="n">with_by_prefix</span><span class="o">=</span><span class="n">with_by_prefixi</span><span class="p">,</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>                <span class="n">with_count_prefix</span><span class="o">=</span><span class="n">with_count_prefix</span><span class="p">,</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>                <span class="n">count_value</span><span class="o">=</span><span class="n">i_moment</span><span class="p">,</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>                <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>            <span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="k">if</span> <span class="n">with_by_prefixi</span><span class="p">:</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                <span class="n">sub_moment_column_name</span> <span class="o">=</span> <span class="s2">&quot;_in&quot;</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                <span class="n">sub_moment_column_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>            <span class="n">m_combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_moments_concatenate_data</span><span class="p">(</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>                <span class="n">m_add</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                <span class="n">m_out</span><span class="o">=</span><span class="n">m_combined</span><span class="p">,</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                <span class="n">sub_moment_column_name</span><span class="o">=</span><span class="n">sub_moment_column_name</span><span class="p">,</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>            <span class="p">)</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="c1">#   Fill in the missing values left by submoment subgroups</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>        <span class="n">m_combined</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="n">fill_missing</span><span class="p">(</span><span class="n">m_combined</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="c1">#   m_combined.df = m_combined.df.sort(self.index)</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="c1">#   m_combined.ModelMatrix = m_combined.ModelMatrix.sort(self.index)</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>        <span class="n">m_combined</span><span class="o">.</span><span class="n">by_where_expressions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="n">m_combined</span><span class="o">.</span><span class="n">sub_moments</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="k">return</span> <span class="n">m_combined</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_prefix</span><span class="p">(</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="n">with_by_prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>        <span class="n">with_count_prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>        <span class="n">count_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>        <span class="n">m</span><span class="p">:</span> <span class="n">Moment</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>    <span class="p">):</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="k">if</span> <span class="n">with_by_prefix</span><span class="p">:</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>            <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">by_where_strings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="k">if</span> <span class="n">with_count_prefix</span><span class="p">:</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>            <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;m</span><span class="si">{</span><span class="n">count_value</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="k">return</span> <span class="n">prefix</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>    <span class="c1">#   Actually put them moments together</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_moments_concatenate_data</span><span class="p">(</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="n">m_add</span><span class="p">:</span> <span class="n">Moment</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>        <span class="n">m_out</span><span class="p">:</span> <span class="n">Moment</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>        <span class="n">sub_moment_column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Moment</span><span class="p">:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>        <span class="c1">#   NonZero always should exist if this is actually a moment to be estimated</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>        <span class="c1">#       Rather than just a parent to submoments,</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>        <span class="k">if</span> <span class="n">m_add</span><span class="o">.</span><span class="n">non_zero</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>            <span class="c1">#   if it&#39;s null, don&#39;t add anything from this and just return the combined moment</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>            <span class="k">return</span> <span class="n">m_out</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>        <span class="c1">#   NonZero always should exist if this is actually a moment to be estimated</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="c1">#       so get the list of column names from it</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="n">columns_to_add</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">non_zero</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>        <span class="c1">#   Nothing to add?, if so, return m_out as we&#39;re doing nothing here</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns_to_add</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>            <span class="k">return</span> <span class="n">m_out</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>        <span class="c1"># Add the dummy for being in this submoment</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>        <span class="k">if</span> <span class="n">sub_moment_column_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>            <span class="c1">#   Non-zero count is the number of observations in group</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>            <span class="n">m_add</span><span class="o">.</span><span class="n">non_zero</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">non_zero</span><span class="p">)</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">n_observations</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">sub_moment_column_name</span><span class="p">)</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>                <span class="p">)</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>            <span class="p">)</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>            <span class="n">m_add</span><span class="o">.</span><span class="n">non_zero_target</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">non_zero_target</span><span class="p">)</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">n_observations_target</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">sub_moment_column_name</span><span class="p">)</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>                <span class="p">)</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>            <span class="p">)</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>            <span class="c1">#   Target is share in this Moment (set to 1 as it should be ByShare, which it will be multiplied by )</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>            <span class="k">if</span> <span class="n">m_add</span><span class="o">.</span><span class="n">rescale</span><span class="p">:</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>                <span class="n">m_add</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">sub_moment_column_name</span><span class="p">))</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                <span class="p">)</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                <span class="n">m_add</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">by_share</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">sub_moment_column_name</span><span class="p">))</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>                <span class="p">)</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>            <span class="c1">#   No scaling needed</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>            <span class="k">if</span> <span class="n">m_add</span><span class="o">.</span><span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                <span class="n">m_add</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">by_share</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">sub_moment_column_name</span><span class="p">)</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>                <span class="p">)</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>            <span class="c1">#   Model matrix - add dummy (1) as this</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>            <span class="k">if</span> <span class="n">m_add</span><span class="o">.</span><span class="n">model_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>                <span class="k">if</span> <span class="n">m_add</span><span class="o">.</span><span class="n">rescale</span><span class="p">:</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>                    <span class="n">m_add</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">)</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>                        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>                            <span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">by_share</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>                                <span class="n">sub_moment_column_name</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>                            <span class="p">)</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>                        <span class="p">)</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                        <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                    <span class="p">)</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>                    <span class="n">m_add</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>                        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">sub_moment_column_name</span><span class="p">))</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>                        <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                    <span class="p">)</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>            <span class="n">m_add</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_moment_column_name</span><span class="p">)</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>        <span class="c1">#   Add the prefix to all the column names</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>        <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>            <span class="k">for</span> <span class="n">itemi</span> <span class="ow">in</span> <span class="p">[</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>                <span class="s2">&quot;model_matrix&quot;</span><span class="p">,</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>                <span class="s2">&quot;targets&quot;</span><span class="p">,</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>                <span class="s2">&quot;scale&quot;</span><span class="p">,</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                <span class="s2">&quot;non_zero&quot;</span><span class="p">,</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>                <span class="s2">&quot;non_zero_target&quot;</span><span class="p">,</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>            <span class="p">]:</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>                <span class="n">dfi</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m_add</span><span class="p">,</span> <span class="n">itemi</span><span class="p">)</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>                <span class="k">if</span> <span class="n">dfi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>                    <span class="nb">setattr</span><span class="p">(</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>                        <span class="n">m_add</span><span class="p">,</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>                        <span class="n">itemi</span><span class="p">,</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                        <span class="n">rename_with_prefix_suffix</span><span class="p">(</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>                            <span class="n">df</span><span class="o">=</span><span class="n">dfi</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">exclude_list</span><span class="o">=</span><span class="n">m_add</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>                        <span class="p">),</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>                    <span class="p">)</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>        <span class="c1">#   Also to the list of columns to be calibrated against</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>        <span class="n">m_add</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">coli</span> <span class="k">for</span> <span class="n">coli</span> <span class="ow">in</span> <span class="n">m_add</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>        <span class="n">m_add</span><span class="o">.</span><span class="n">by_share</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>        <span class="c1">#   If m_out is None, we&#39;re done, and m_add is the &quot;combined&quot; moment</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>        <span class="k">if</span> <span class="n">m_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>            <span class="k">return</span> <span class="n">m_add</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>        <span class="c1">#   If m_out is not None, we need to combined m_out and m_add</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>        <span class="c1">#   Update the name of the added columns, if anything was changed above</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>        <span class="n">columns_to_add</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">non_zero</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>        <span class="c1">#   Combine the &quot;data&quot; (df and ModelMatrix)</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>        <span class="k">if</span> <span class="n">m_out</span><span class="o">.</span><span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>            <span class="n">m_out</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">m_add</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>            <span class="n">m_out</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="n">m_add</span><span class="o">.</span><span class="n">model_matrix</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>            <span class="n">df_add</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>                    <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>                        <span class="n">m_add</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m_out</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>                        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>                        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;bExist&quot;</span><span class="p">))</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>                        <span class="o">.</span><span class="n">to_native</span><span class="p">(),</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>                        <span class="n">on</span><span class="o">=</span><span class="n">m_add</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>                        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>                    <span class="p">)</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>                <span class="p">)</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;bExist&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_missing</span><span class="p">())</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;bExist&quot;</span><span class="p">)</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>            <span class="p">)</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>            <span class="n">m_out</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">concat_wrapper</span><span class="p">([</span><span class="n">m_out</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">df_add</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;diagonal&quot;</span><span class="p">)</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>            <span class="n">m_out</span><span class="o">.</span><span class="n">model_matrix</span> <span class="o">=</span> <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>                <span class="n">m_out</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">,</span> <span class="n">m_add</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">m_add</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;full&quot;</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>            <span class="p">)</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>        <span class="c1">#   The summary data</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="k">for</span> <span class="n">itemi</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;non_zero&quot;</span><span class="p">,</span> <span class="s2">&quot;non_zero_target&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>            <span class="n">dfi_add</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m_add</span><span class="p">,</span> <span class="n">itemi</span><span class="p">)</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>            <span class="n">dfi_out</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m_out</span><span class="p">,</span> <span class="n">itemi</span><span class="p">)</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>            <span class="k">if</span> <span class="n">dfi_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>                <span class="nb">setattr</span><span class="p">(</span><span class="n">m_out</span><span class="p">,</span> <span class="n">itemi</span><span class="p">,</span> <span class="n">dfi_add</span><span class="p">)</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>                <span class="nb">setattr</span><span class="p">(</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>                    <span class="n">m_out</span><span class="p">,</span> <span class="n">itemi</span><span class="p">,</span> <span class="n">concat_wrapper</span><span class="p">([</span><span class="n">dfi_out</span><span class="p">,</span> <span class="n">dfi_add</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>                <span class="p">)</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="n">m_out</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">m_add</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>        <span class="k">return</span> <span class="n">m_out</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>        <span class="n">min_obs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>        <span class="n">skip_setup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>        <span class="n">print_diagnostics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>        <span class="n">skip_diagnostics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>        <span class="n">trim</span><span class="p">:</span> <span class="n">Trim</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>        <span class="o">**</span><span class="n">additional_params</span><span class="p">,</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a><span class="sd">        Run the calibration to estimate the weights from the moments.</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a><span class="sd">        min_obs : int | list[int], optional</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a><span class="sd">            Limit the moments to those with more than some number of</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><span class="sd">            non-zero observations.</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a><span class="sd">            You can pass a list of increasing values so that if</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a><span class="sd">            the model doesn&#39;t converge with the lowest number</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="sd">            (the most constraints), then try again dropping</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a><span class="sd">            constraints with more non-zero observations and try again.</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><span class="sd">            I.e. if you pass [0,10,100], it will see if the model converges</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a><span class="sd">            with min_obs = 0, if not, it will try with min_obs = 10, etc.</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><span class="sd">            The default is 0.</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><span class="sd">        print_diagnostics : bool, optional</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a><span class="sd">            Print the diagnostics (do the weights match the target moments)?</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="sd">            The default is True.</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a><span class="sd">        skip_diagnostics : bool, optional</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a><span class="sd">            Don&#39;t even calculate the diagnostics?</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a><span class="sd">            They can take a while to calculate, but</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a><span class="sd">            you really shouldn&#39;t skip this.</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a><span class="sd">            The default is False.</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><span class="sd">        trim : Trim | None, optional</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="sd">            Pass a Trim object with bounds on the weights.</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a><span class="sd">            The default is None.</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a><span class="sd">        **additional_params : dict</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a><span class="sd">            Any additional params that are specific to a</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a><span class="sd">            calibration algorithm.</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><span class="sd">        -------</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a><span class="sd">        dict</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a><span class="sd">            A dictionary with diagnostics information including:</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="sd">            - &#39;converged&#39; : bool</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><span class="sd">                Whether the calibration converged.</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><span class="sd">            - &#39;max_diff&#39; : float</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a><span class="sd">                Maximum difference between targets and estimates (if diagnostics calculated).</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a><span class="sd">            - &#39;diagnostics&#39; : DataFrame</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a><span class="sd">                Detailed diagnostics by moment (if skip_diagnostics=False).</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="sd">        Examples</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a><span class="sd">        --------</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a><span class="sd">        Basic calibration run::</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a><span class="sd">            diagnostics = c.run(min_obs=50)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a><span class="sd">            print(f&quot;Converged: {diagnostics[&#39;converged&#39;]}&quot;)</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a><span class="sd">            print(f&quot;Max difference: {diagnostics[&#39;max_diff&#39;]}&quot;)</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a><span class="sd">        Run with fallback min_obs levels::</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a><span class="sd">            # Try with no minimum first, then 10, then 100 if previous fails</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a><span class="sd">            diagnostics = c.run(min_obs=[0, 10, 100])</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a><span class="sd">        Run with weight trimming::</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a><span class="sd">            trim_params = Trim(trim=True, min_val=0.1, max_val=5.0)</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a><span class="sd">            diagnostics = c.run(trim=trim_params)</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>        <span class="c1">#  Is min_obs a list of values?</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>        <span class="c1">#       If so, run this recursively on the remaining obs, if it doesn&#39;t converge on this one</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>        <span class="n">min_obs_remaining</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">min_obs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_obs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>                <span class="n">min_obs_remaining</span> <span class="o">=</span> <span class="n">min_obs</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_obs</span><span class="p">)]</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>                <span class="n">min_obs</span> <span class="o">=</span> <span class="n">min_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>                <span class="n">min_obs</span> <span class="o">=</span> <span class="n">min_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>                <span class="n">min_obs_remaining</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>        <span class="k">if</span> <span class="n">min_obs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">censor_to_min_obs</span><span class="p">(</span><span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs</span><span class="p">)</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>        <span class="c1">#   Need to loop if trimmed</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>        <span class="c1">#   bLoopNeeded = self.Trimmed</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>        <span class="n">bLoopNeeded</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Sequential&quot;</span><span class="p">:</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>            <span class="c1">#   Sequential - need loop</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>            <span class="n">bLoopNeeded</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Combined&quot;</span><span class="p">:</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_setup</span><span class="p">:</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">combine_moments</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sub_moments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Both&quot;</span><span class="p">:</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_setup</span><span class="p">:</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>                <span class="c1">#   Clone this and create a version with the moments combined</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span> <span class="o">=</span> <span class="n">deepcopy_with_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">=</span> <span class="s2">&quot;Combined&quot;</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>                <span class="c1"># Do not trim within the combined calibration (handled in self)</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>                <span class="c1">#   self.c_combined.Trimmed = False</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">combine_moments</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sub_moments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calibrating weights using &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>        <span class="k">if</span> <span class="n">min_obs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      min obs = </span><span class="si">{</span><span class="n">min_obs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>        <span class="k">if</span> <span class="n">bLoopNeeded</span><span class="p">:</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>            <span class="n">n_loops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations_loop</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>            <span class="n">n_loops</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>        <span class="c1">#   Loop counter</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>        <span class="n">iLoop</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>        <span class="c1">#   Within-loop completion flag</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>        <span class="n">b_complete</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>        <span class="n">diagnostics</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>        <span class="k">while</span> <span class="p">(</span><span class="n">iLoop</span> <span class="o">&lt;</span> <span class="n">n_loops</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b_complete</span><span class="p">:</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>            <span class="k">if</span> <span class="n">n_loops</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n\n</span><span class="s2">Running loop #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iLoop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>            <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_one_loop</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="n">trim</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">)</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>            <span class="n">converged</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;converged&quot;</span><span class="p">]</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>            <span class="k">if</span> <span class="s2">&quot;diagnostics&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>                <span class="c1">#   Not full diagnostics, set to null to load later</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>                <span class="n">diagnostics</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>            <span class="c1">#   Default to complete unless set to False below</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>            <span class="n">b_complete</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>            <span class="k">if</span> <span class="n">trim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>                <span class="c1">#   Need trimming?</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>                <span class="c1">#       Don&#39;t trim if aebw without separately passed bounds</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>                <span class="k">if</span> <span class="n">trim</span><span class="o">.</span><span class="n">trim</span> <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;aebw&quot;</span> <span class="ow">and</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">additional_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>                <span class="p">):</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>                    <span class="n">b_complete</span> <span class="o">=</span> <span class="n">trim</span><span class="o">.</span><span class="n">trim_in_loop</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">iLoop</span><span class="o">=</span><span class="n">iLoop</span><span class="p">,</span> <span class="n">n_loops</span><span class="o">=</span><span class="n">n_loops</span><span class="p">)</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Sequential&quot;</span><span class="p">:</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>                <span class="c1"># Check the max deviation against the tolerance</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>                <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">()</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>                <span class="n">max_diff</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;max_diff&quot;</span><span class="p">]</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>                <span class="n">converged</span> <span class="o">=</span> <span class="n">max_diff</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tolerance_Loop</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>                <span class="n">b_complete</span> <span class="o">=</span> <span class="n">converged</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>            <span class="n">iLoop</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_diagnostics</span><span class="p">:</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>            <span class="k">if</span> <span class="n">diagnostics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>                <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">()</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>            <span class="k">if</span> <span class="n">n_loops</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>                <span class="n">b_complete</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;max_diff&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>                <span class="n">b_complete</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;max_diff&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">b_complete</span> <span class="ow">or</span> <span class="n">converged</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">min_obs_remaining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>                <span class="c1">#   Recursively call this again, if needed</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>                <span class="c1">#   Reset the &quot;final weight&quot; (current weight) to the original one passed</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>                <span class="c1">#       (ignores the failed run&#39;s output)</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a>                    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">))</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a>                <span class="p">)</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>                <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>                    <span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs_remaining</span><span class="p">,</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>                    <span class="n">skip_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>                    <span class="n">print_diagnostics</span><span class="o">=</span><span class="n">print_diagnostics</span><span class="p">,</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>                    <span class="n">skip_diagnostics</span><span class="o">=</span><span class="n">skip_diagnostics</span><span class="p">,</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>                    <span class="o">**</span><span class="n">additional_params</span><span class="p">,</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>                <span class="p">)</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>                <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;converged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converged</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>            <span class="k">if</span> <span class="s2">&quot;diagnostics&quot;</span> <span class="ow">in</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>                <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">])</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>                    <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>                <span class="p">)</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics_out</span> <span class="o">=</span> <span class="n">diagnostics</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>            <span class="k">if</span> <span class="n">print_diagnostics</span><span class="p">:</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">()</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>        <span class="k">return</span> <span class="n">diagnostics</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">censor_to_min_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_obs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a><span class="sd">        In calibration, do we want to limit to moments with greater than some</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a><span class="sd">           threshold of observations where x != 0</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a><span class="sd">        min_obs : int, optional</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a><span class="sd">            The minimum number of != 0 observations.</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a><span class="sd">            The default is 0. (don&#39;t censor)</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a><span class="sd">        -------</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a><span class="sd">        None</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>        <span class="k">for</span> <span class="n">momenti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">:</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_censor_to_min_obs_by_moment</span><span class="p">(</span><span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">momenti</span><span class="p">)</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>            <span class="k">for</span> <span class="n">subi</span> <span class="ow">in</span> <span class="n">momenti</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">:</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_censor_to_min_obs_by_moment</span><span class="p">(</span><span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">subi</span><span class="p">)</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">censor_to_min_obs</span><span class="p">(</span><span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs</span><span class="p">)</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_censor_to_min_obs_by_moment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Moment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a><span class="sd">        For each moment, censor, if needed</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a><span class="sd">        min_obs : int</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a><span class="sd">            Minimum non-zero observations to censor at</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="sd">        m : Moment</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a><span class="sd">            Moment to censor</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a><span class="sd">        -------</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a><span class="sd">        None</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">non_zero_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>            <span class="n">nw_type</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">non_zero_target</span><span class="p">)</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>            <span class="n">nonzero_cols</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>                <span class="n">nw_type</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">include_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>            <span class="p">)</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>            <span class="n">m</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">nonzero_cols</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">nonzero_cols</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">min_obs</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>            <span class="p">)[</span><span class="n">nonzero_cols</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">non_zero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>            <span class="n">nw_type</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">non_zero</span><span class="p">)</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>            <span class="n">nonzero_cols</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>                <span class="n">nw_type</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">include_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>            <span class="p">)</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>            <span class="n">m</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">nonzero_cols</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">nonzero_cols</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">min_obs</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>            <span class="p">)[</span><span class="n">nonzero_cols</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_run_one_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trim</span><span class="p">:</span> <span class="n">Trim</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">):</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>        <span class="k">if</span> <span class="n">additional_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>            <span class="n">additional_params</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>        <span class="c1">#   Delegate for actual calibration call</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>        <span class="n">fCalibrate</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>        <span class="n">additional_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;legacy_ebw&quot;</span><span class="p">:</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a>            <span class="n">fCalibrate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_legacy_ebw</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;aebw&quot;</span><span class="p">:</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a>            <span class="n">fCalibrate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accelerated_ebw_moment</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a>            <span class="c1">#   Bound ratio adjustment to ebw</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>            <span class="n">additional_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;bounds&quot;</span><span class="p">)</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>            <span class="c1">#   Constraint violation penalty parameter</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>            <span class="n">additional_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">)</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a>            <span class="c1">#   If passed, Sanders&#39;s version of Hainmueller&#39;s EBW</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a>            <span class="n">additional_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dual_only&quot;</span><span class="p">)</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>            <span class="n">additional_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dense&quot;</span><span class="p">)</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>            <span class="n">additional_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;scale_weights_to_n&quot;</span><span class="p">)</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>            <span class="n">additional_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;fallback_bounded&quot;</span><span class="p">)</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a>            <span class="n">additional_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;fallback_iterations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a>            <span class="k">if</span> <span class="n">trim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>                <span class="k">if</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">additional_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bounds passed directly, ignoring trim parameters: &quot;</span><span class="p">)</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">trim</span><span class="p">)</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Do I want to pass trim bounds to the calibration?&quot;</span><span class="p">)</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a>                    <span class="c1"># additional_params[&quot;bounds&quot;] = (trim.min_val,</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>                    <span class="c1">#                                trim.max_val)</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>        <span class="c1">#   Keep only relevant parameters</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>        <span class="n">additional_params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>            <span class="n">keyi</span><span class="p">:</span> <span class="n">valuei</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a>            <span class="k">for</span> <span class="n">keyi</span><span class="p">,</span> <span class="n">valuei</span> <span class="ow">in</span> <span class="n">additional_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a>            <span class="k">if</span> <span class="n">keyi</span> <span class="ow">in</span> <span class="n">additional_list</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>        <span class="p">}</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>        <span class="c1">#   Create an empty diagnostics variable - some aggregations populate this</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>        <span class="n">diagnostics</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Combined&quot;</span><span class="p">:</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>            <span class="n">converged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_combined</span><span class="p">(</span><span class="n">fCalibrate</span><span class="o">=</span><span class="n">fCalibrate</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">)</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Sequential&quot;</span><span class="p">:</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_run_sequential</span><span class="p">(</span><span class="n">fCalibrate</span><span class="o">=</span><span class="n">fCalibrate</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">)</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>            <span class="c1">#   This is just passed, convergence is checked later</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a>            <span class="c1">#       through the diagnostics</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>            <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Both&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_run_sequential</span><span class="p">(</span><span class="n">fCalibrate</span><span class="o">=</span><span class="n">fCalibrate</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">)</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>            <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">()</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>            <span class="k">if</span> <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;max_diff&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tolerance</span><span class="p">:</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>                    <span class="s2">&quot;     Did not converge for sequential, running combined calibration&quot;</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>                <span class="p">)</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>                <span class="n">cols_df</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>                <span class="n">cols_df</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>                <span class="n">cols_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a>                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">(),</span>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols_df</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">(),</span>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a>                    <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a>                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a>                <span class="p">)</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">additional_params</span><span class="p">)</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a>                <span class="c1">#   Get the final diagnostics from the combined run</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>                <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">diagnostics_out</span>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a>                <span class="c1"># Update the weights back</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">(),</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols_df</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">(),</span>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a>                    <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a>                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a>                <span class="p">)</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a>                    <span class="s2">&quot;     Converged for sequential, skipping combined calibration&quot;</span>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a>                <span class="p">)</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>        <span class="k">if</span> <span class="n">diagnostics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a>            <span class="n">diagnostics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;converged&quot;</span><span class="p">:</span> <span class="n">converged</span><span class="p">}</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a>        <span class="k">return</span> <span class="n">diagnostics</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_run_combined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fCalibrate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">):</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a>        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1044" name="__codelineno-0-1044"></a>
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">model_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;     Calibration using combined moments&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a>            <span class="n">converged</span> <span class="o">=</span> <span class="n">fCalibrate</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">)</span>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a>        <span class="k">return</span> <span class="n">converged</span>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_run_sequential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fCalibrate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">):</span>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a>        <span class="k">for</span> <span class="n">i_moment</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">):</span>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Moment: </span><span class="si">{</span><span class="n">i_moment</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">ModelMatrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a>                <span class="n">converged</span> <span class="o">=</span> <span class="n">fCalibrate</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">)</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a>            <span class="k">for</span> <span class="n">i_sub</span><span class="p">,</span> <span class="n">subi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">):</span>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Moment: </span><span class="si">{</span><span class="n">i_moment</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">i_sub</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a>                <span class="k">if</span> <span class="n">subi</span><span class="o">.</span><span class="n">model_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a>                    <span class="n">converged</span> <span class="o">=</span> <span class="n">fCalibrate</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">subi</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">)</span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a>        <span class="k">return</span> <span class="n">converged</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_legacy_ebw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Moment</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a>        <span class="p">[</span><span class="n">initial_guess</span><span class="p">,</span> <span class="n">base_weight</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">targetsi</span><span class="p">,</span> <span class="n">tol_adj</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moment_inputs</span><span class="p">(</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a>            <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="n">sequential</span>
<a id="__codelineno-0-1069" name="__codelineno-0-1069"></a>        <span class="p">)</span>
<a id="__codelineno-0-1070" name="__codelineno-0-1070"></a>
<a id="__codelineno-0-1071" name="__codelineno-0-1071"></a>        <span class="n">nw_type</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
<a id="__codelineno-0-1072" name="__codelineno-0-1072"></a>
<a id="__codelineno-0-1073" name="__codelineno-0-1073"></a>        <span class="c1">#   Initial weights</span>
<a id="__codelineno-0-1074" name="__codelineno-0-1074"></a>        <span class="k">if</span> <span class="n">base_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1075" name="__codelineno-0-1075"></a>            <span class="n">base_weight</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1076" name="__codelineno-0-1076"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-1077" name="__codelineno-0-1077"></a>            <span class="p">)</span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a>            <span class="n">initial_guess</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a>            <span class="c1">#   aebw_options[&quot;initial_ratio_guess&quot;] = base_weight</span>
<a id="__codelineno-0-1081" name="__codelineno-0-1081"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1082" name="__codelineno-0-1082"></a>            <span class="n">base_weight</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1083" name="__codelineno-0-1083"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">base_weight</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a>            <span class="p">)</span>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a>            <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a>            <span class="p">)</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a>            <span class="c1">#   aebw_options[&quot;initial_ratio_guess&quot;] = initial_guess</span>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a>        <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a>                <span class="p">[</span><span class="n">cs</span><span class="o">.</span><span class="n">boolean</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">Float32</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">numeric</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">Float64</span><span class="p">)]</span>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a>            <span class="p">)</span>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a>        <span class="p">)</span>
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a>        <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">Float64</span><span class="p">))</span>
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a>            <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a>            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a>            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a>        <span class="p">)</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a>        <span class="n">targetsi</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">targetsi</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a>        <span class="n">b_converged</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">legacy_calibration</span><span class="p">(</span>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a>                <span class="n">mean_population_moments</span><span class="o">=</span><span class="n">targetsi</span><span class="p">,</span>
<a id="__codelineno-0-1114" name="__codelineno-0-1114"></a>                <span class="n">x_sample</span><span class="o">=</span><span class="n">xi</span><span class="p">,</span>
<a id="__codelineno-0-1115" name="__codelineno-0-1115"></a>                <span class="n">weights0</span><span class="o">=</span><span class="n">base_weight</span><span class="p">,</span>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a>                <span class="n">penalty_fn</span><span class="o">=</span><span class="s2">&quot;log_diff&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a>                <span class="n">rank_regularization_term</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">*</span> <span class="n">tol_adj</span><span class="p">,</span>
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>                <span class="n">initial_guess</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">,</span>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a>                <span class="n">n_iterations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a>            <span class="p">)</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a>            <span class="c1">#   Make sure the print log goes with the code that executed it (rather than at the end of the log)</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1124" name="__codelineno-0-1124"></a>
<a id="__codelineno-0-1125" name="__codelineno-0-1125"></a>            <span class="n">b_converged</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
<a id="__codelineno-0-1126" name="__codelineno-0-1126"></a>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a>            <span class="n">w_out</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_arrow</span><span class="p">(</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a>                    <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>                        <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">schema</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;column_0&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">}</span>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a>                    <span class="p">)</span><span class="o">.</span><span class="n">to_arrow</span><span class="p">(),</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a>                    <span class="n">backend</span><span class="o">=</span><span class="n">backend_eager</span><span class="p">(</span><span class="n">nw_type</span><span class="o">.</span><span class="n">backend</span><span class="p">),</span>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a>                <span class="p">)</span>
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a>            <span class="p">)</span>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a>        <span class="k">if</span> <span class="n">w_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_merge_on_weights</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_out</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="n">sequential</span><span class="p">)</span>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a>
<a id="__codelineno-0-1142" name="__codelineno-0-1142"></a>        <span class="k">return</span> <span class="n">b_converged</span>
<a id="__codelineno-0-1143" name="__codelineno-0-1143"></a>
<a id="__codelineno-0-1144" name="__codelineno-0-1144"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_accelerated_ebw_moment</span><span class="p">(</span>
<a id="__codelineno-0-1145" name="__codelineno-0-1145"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a>        <span class="n">m</span><span class="p">:</span> <span class="n">Moment</span><span class="p">,</span>
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a>        <span class="n">sequential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a>        <span class="n">dense</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a>        <span class="n">bounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a>        <span class="c1">#  eta=None,</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a>        <span class="n">fallback_bounded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a>        <span class="n">fallback_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a>        <span class="n">dual_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a>        <span class="n">only_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a>        <span class="n">scale_weights_to_n</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a><span class="sd">        Call accelerated ebw calibration code</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a><span class="sd">            (https://github.t26.it.census.gov/sande440/entropy-balance-weighting)</span>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a><span class="sd">        m : Moment</span>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a><span class="sd">            Moment to be calibrated to</span>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a><span class="sd">        sequential : TYPE, optional</span>
<a id="__codelineno-0-1166" name="__codelineno-0-1166"></a><span class="sd">            Is this part of a sequential optimization. The default is False.</span>
<a id="__codelineno-0-1167" name="__codelineno-0-1167"></a><span class="sd">        dense : bool, optional</span>
<a id="__codelineno-0-1168" name="__codelineno-0-1168"></a><span class="sd">            Dense matrix (vs. sparse). The default is True.</span>
<a id="__codelineno-0-1169" name="__codelineno-0-1169"></a><span class="sd">        bounds : tuple(float,float) | None, optional</span>
<a id="__codelineno-0-1170" name="__codelineno-0-1170"></a><span class="sd">            tuple of lower, upper bound.</span>
<a id="__codelineno-0-1171" name="__codelineno-0-1171"></a><span class="sd">            If bounds are set, the &quot;elastic&quot; calibration is called,</span>
<a id="__codelineno-0-1172" name="__codelineno-0-1172"></a><span class="sd">            which tries to match as well as possible, but can</span>
<a id="__codelineno-0-1173" name="__codelineno-0-1173"></a><span class="sd">            handle unsatisfiable constraints</span>
<a id="__codelineno-0-1174" name="__codelineno-0-1174"></a><span class="sd">            (by trying to get as closs as possible)</span>
<a id="__codelineno-0-1175" name="__codelineno-0-1175"></a><span class="sd">            Can be (0,None) for no bounds elastic calibration.</span>
<a id="__codelineno-0-1176" name="__codelineno-0-1176"></a><span class="sd">            The default is None.</span>
<a id="__codelineno-0-1177" name="__codelineno-0-1177"></a><span class="sd">        #   eta : TYPE, optional</span>
<a id="__codelineno-0-1178" name="__codelineno-0-1178"></a><span class="sd">        #       Elastic calibration penalty parameter. The default is None.</span>
<a id="__codelineno-0-1179" name="__codelineno-0-1179"></a><span class="sd">        fallback_bounded : bool, optional</span>
<a id="__codelineno-0-1180" name="__codelineno-0-1180"></a><span class="sd">            If unbounded calibration fails to converge, fallback to bounded</span>
<a id="__codelineno-0-1181" name="__codelineno-0-1181"></a><span class="sd">            for &quot;as close as possible&quot; calibration</span>
<a id="__codelineno-0-1182" name="__codelineno-0-1182"></a><span class="sd">            with no bounds (bounds=[epsilon_weight_lower_bound,None])</span>
<a id="__codelineno-0-1183" name="__codelineno-0-1183"></a><span class="sd">            The default is False.</span>
<a id="__codelineno-0-1184" name="__codelineno-0-1184"></a><span class="sd">        fallback_iterations : int, optional</span>
<a id="__codelineno-0-1185" name="__codelineno-0-1185"></a><span class="sd">            Number of iterations if falling back to elastic, bounded optimization.</span>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a><span class="sd">            The default is self.Iterations</span>
<a id="__codelineno-0-1187" name="__codelineno-0-1187"></a><span class="sd">        dual_only : bool, optional</span>
<a id="__codelineno-0-1188" name="__codelineno-0-1188"></a><span class="sd">            Use dual only (Hainmueller-like) optimization. The default is False.</span>
<a id="__codelineno-0-1189" name="__codelineno-0-1189"></a><span class="sd">        only_bounds : bool, optional</span>
<a id="__codelineno-0-1190" name="__codelineno-0-1190"></a><span class="sd">            If you have bounds, do  you want to start with the</span>
<a id="__codelineno-0-1191" name="__codelineno-0-1191"></a><span class="sd">            bounds or see if the normal procedure satisfies the bounds?</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a><span class="sd">            If true, start with the bounded elastic,</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a><span class="sd">            if False, trie without the bounds and verify if they are satisfied.</span>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a><span class="sd">            The default is False.</span>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a><span class="sd">        scale_weights_to_n : bool, optional</span>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a><span class="sd">            Scaling weights to sum to n of sample seems</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a><span class="sd">            to run faster, so do that? The default is True.</span>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a>
<a id="__codelineno-0-1199" name="__codelineno-0-1199"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-1200" name="__codelineno-0-1200"></a><span class="sd">        -------</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a><span class="sd">        b_converged : boolean</span>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a><span class="sd">            Converged?  It also sets the weights in self</span>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a>        <span class="n">epsilon_weight_lower_bound</span> <span class="o">=</span> <span class="mf">10e-5</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s2">&quot;concat&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a>            <span class="n">np</span><span class="o">.</span><span class="n">concat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a>        <span class="p">[</span><span class="n">initial_guess</span><span class="p">,</span> <span class="n">base_weight</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">targetsi</span><span class="p">,</span> <span class="n">tol_adj</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moment_inputs</span><span class="p">(</span>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a>            <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="n">sequential</span>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a>        <span class="p">)</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a>        <span class="n">nw_type</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a>        <span class="n">n_weights</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">)</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a>        <span class="n">aebw_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dense</span><span class="o">=</span><span class="n">dense</span><span class="p">,</span> <span class="n">dual_only</span><span class="o">=</span><span class="n">dual_only</span><span class="p">)</span>
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a>        <span class="c1"># if eta is not None:</span>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a>        <span class="c1">#     aebw_options[&quot;eta&quot;] = eta</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a>        <span class="c1">#   If you pass in [0,None], then I&#39;m assuming only_bounds</span>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a>        <span class="c1">#       because that is unbounded</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a>        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a>            <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">epsilon_weight_lower_bound</span> <span class="ow">and</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a>                <span class="n">only_bounds</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a>            <span class="k">if</span> <span class="n">only_bounds</span><span class="p">:</span>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a>                <span class="n">aebw_options</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a>        <span class="c1">#   Initial weights</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a>        <span class="k">if</span> <span class="n">base_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a>            <span class="n">base_weight</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a>            <span class="p">)</span>
<a id="__codelineno-0-1236" name="__codelineno-0-1236"></a>            <span class="n">initial_guess</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1237" name="__codelineno-0-1237"></a>
<a id="__codelineno-0-1238" name="__codelineno-0-1238"></a>            <span class="c1">#   aebw_options[&quot;initial_ratio_guess&quot;] = base_weight</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>            <span class="n">base_weight</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">base_weight</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a>            <span class="p">)</span>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a>            <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1244" name="__codelineno-0-1244"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-1245" name="__codelineno-0-1245"></a>            <span class="p">)</span>
<a id="__codelineno-0-1246" name="__codelineno-0-1246"></a>
<a id="__codelineno-0-1247" name="__codelineno-0-1247"></a>            <span class="c1">#   aebw_options[&quot;initial_ratio_guess&quot;] = initial_guess</span>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a>        <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>                <span class="p">[</span><span class="n">cs</span><span class="o">.</span><span class="n">boolean</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">Float32</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">numeric</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">Float64</span><span class="p">)]</span>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a>            <span class="p">)</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a>        <span class="p">)</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a>        <span class="k">if</span> <span class="n">dense</span><span class="p">:</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a>            <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">Float64</span><span class="p">))</span>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a>                <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a>                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a>                <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a>            <span class="p">)</span>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_array</span><span class="p">(</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">Float64</span><span class="p">))</span>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a>                <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a>                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a>                <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a>            <span class="p">)</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a>        <span class="n">targetsi</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">targetsi</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a>        <span class="k">if</span> <span class="n">scale_weights_to_n</span><span class="p">:</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>            <span class="n">sum_weights</span> <span class="o">=</span> <span class="n">base_weight</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a>            <span class="n">adjustment</span> <span class="o">=</span> <span class="n">n_weights</span> <span class="o">/</span> <span class="n">sum_weights</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a>            <span class="n">base_weight</span> <span class="o">=</span> <span class="n">base_weight</span> <span class="o">*</span> <span class="n">adjustment</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>            <span class="k">if</span> <span class="n">initial_guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a>                <span class="n">initial_guess</span> <span class="o">=</span> <span class="n">initial_guess</span> <span class="o">*</span> <span class="n">adjustment</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a>        <span class="n">b_converged</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a>        <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a>        <span class="n">w_out</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a>            <span class="n">aebw_options</span><span class="p">[</span><span class="s2">&quot;max_steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a>            <span class="n">aebw_options</span><span class="p">[</span><span class="s2">&quot;optimality_violation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">*</span> <span class="n">tol_adj</span>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">ebw_routines</span><span class="o">.</span><span class="n">entropy_balance</span><span class="p">(</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a>                <span class="n">mean_population_moments</span><span class="o">=</span><span class="n">targetsi</span><span class="p">,</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>                <span class="n">x_sample</span><span class="o">=</span><span class="n">xi</span><span class="p">,</span>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a>                <span class="n">weights0</span><span class="o">=</span><span class="n">base_weight</span><span class="p">,</span>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a>                <span class="n">options</span><span class="o">=</span><span class="n">aebw_options</span><span class="p">,</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a>            <span class="p">)</span>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a>            <span class="c1">#   Make sure the print log goes with the code that executed it (rather than at the end of the log)</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a>            <span class="n">b_converged</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">converged</span>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1306" name="__codelineno-0-1306"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failure of initial calibration&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1308" name="__codelineno-0-1308"></a>
<a id="__codelineno-0-1309" name="__codelineno-0-1309"></a>        <span class="n">check_bounds</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">only_bounds</span> <span class="ow">and</span> <span class="p">(</span><span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-1310" name="__codelineno-0-1310"></a>        <span class="n">rerun_with_bounds</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a>        <span class="k">if</span> <span class="n">b_converged</span><span class="p">:</span>
<a id="__codelineno-0-1312" name="__codelineno-0-1312"></a>            <span class="n">w_out</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-1313" name="__codelineno-0-1313"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_arrow</span><span class="p">(</span>
<a id="__codelineno-0-1314" name="__codelineno-0-1314"></a>                    <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a>                        <span class="n">results</span><span class="o">.</span><span class="n">new_weights</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;column_0&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">}</span>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a>                    <span class="p">)</span><span class="o">.</span><span class="n">to_arrow</span><span class="p">(),</span>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a>                    <span class="n">backend</span><span class="o">=</span><span class="n">backend_eager</span><span class="p">(</span><span class="n">nw_type</span><span class="o">.</span><span class="n">backend</span><span class="p">),</span>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a>                <span class="p">)</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a>            <span class="p">)</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a>        <span class="n">ratio</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a>        <span class="k">if</span> <span class="n">check_bounds</span><span class="p">:</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a>            <span class="c1">#   It converged, but are we finished?</span>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a>            <span class="n">df_base_weight</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_arrow</span><span class="p">(</span>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a>                <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">base_weight</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;base&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">})</span><span class="o">.</span><span class="n">to_arrow</span><span class="p">(),</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a>                <span class="n">backend</span><span class="o">=</span><span class="n">backend_eager</span><span class="p">(</span><span class="n">nw_type</span><span class="o">.</span><span class="n">backend</span><span class="p">),</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a>            <span class="p">)</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a>            <span class="n">c_ratio</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;new&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a>                <span class="n">concat_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a>                    <span class="p">[</span><span class="n">df_base_weight</span><span class="p">,</span> <span class="n">w_out</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;column_0&quot;</span><span class="p">:</span> <span class="s2">&quot;new&quot;</span><span class="p">})],</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a>                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a>                <span class="p">)</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a>            <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">c_ratio</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">),</span> <span class="n">c_ratio</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">)])</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a>            <span class="n">min_ratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a>            <span class="n">max_ratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a>            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a>            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>            <span class="k">if</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lower_bound</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>                <span class="n">rerun_with_bounds</span> <span class="o">=</span> <span class="n">lower_bound</span> <span class="o">&gt;</span> <span class="n">min_ratio</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rerun_with_bounds</span> <span class="ow">and</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">upper_bound</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>                <span class="n">rerun_with_bounds</span> <span class="o">=</span> <span class="n">rerun_with_bounds</span> <span class="ow">or</span> <span class="p">(</span><span class="n">upper_bound</span> <span class="o">&lt;</span> <span class="n">max_ratio</span><span class="p">)</span>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>            <span class="k">if</span> <span class="n">rerun_with_bounds</span><span class="p">:</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Bounds satisfied:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     bounds = </span><span class="si">{</span><span class="n">bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     limits = </span><span class="si">{</span><span class="p">[</span><span class="n">min_ratio</span><span class="p">,</span><span class="w"> </span><span class="n">max_ratio</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">b_converged</span> <span class="ow">and</span> <span class="n">fallback_bounded</span><span class="p">)</span> <span class="ow">or</span> <span class="n">rerun_with_bounds</span><span class="p">:</span>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>            <span class="c1">#   Failed, did you use bounds the first time?</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a>            <span class="c1">#       Bounds will run the &quot;as close as possible&quot; version</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>            <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a>                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">epsilon_weight_lower_bound</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a>            <span class="n">aebw_options</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounds</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Attempting to calibrate with bounds: </span><span class="si">{</span><span class="n">bounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a>            <span class="c1">#   Set the initial guess</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a>            <span class="c1"># if w_out is not None:</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a>            <span class="c1">#     df_base_weight = pl.from_numpy(base_weight,</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a>            <span class="c1">#                                     schema={&quot;base&quot;:pl.Float64})</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>            <span class="c1">#     c_ratio = pl.col(&quot;new&quot;)/pl.col(&quot;base&quot;)</span>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a>            <span class="c1">#     ratio = (pl.concat([df_base_weight,</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a>            <span class="c1">#                         w_out.rename({&quot;column_0&quot;:&quot;new&quot;})],</span>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a>            <span class="c1">#                         how=&quot;horizontal&quot;)</span>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a>            <span class="c1">#               .select(c_ratio)</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a>            <span class="c1">#               )</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a>            <span class="c1">#   Initial guess doesn&#39;t work for bounded value: line 434 (inv_h_sqrt = sp..)</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a>            <span class="c1"># if ratio is not None:</span>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a>            <span class="c1">#     aebw_options[&quot;initial_ratio_guess&quot;] = ratio.to_numpy().ravel()</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a>            <span class="k">if</span> <span class="n">fallback_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a>                <span class="n">aebw_options</span><span class="p">[</span><span class="s2">&quot;max_steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback_iterations</span>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a>
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">ebw_routines</span><span class="o">.</span><span class="n">entropy_balance_elastic</span><span class="p">(</span>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a>                <span class="n">mean_population_moments</span><span class="o">=</span><span class="n">targetsi</span><span class="p">,</span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a>                <span class="n">x_sample</span><span class="o">=</span><span class="n">xi</span><span class="p">,</span>
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a>                <span class="n">weights0</span><span class="o">=</span><span class="n">base_weight</span><span class="p">,</span>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a>                <span class="n">options</span><span class="o">=</span><span class="n">aebw_options</span><span class="p">,</span>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a>            <span class="p">)</span>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a>            <span class="n">b_converged</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">converged</span>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a>            <span class="n">w_out</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_arrow</span><span class="p">(</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a>                    <span class="n">pl</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a>                        <span class="n">results</span><span class="o">.</span><span class="n">new_weights</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;column_0&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">}</span>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a>                    <span class="p">)</span><span class="o">.</span><span class="n">to_arrow</span><span class="p">(),</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a>                    <span class="n">backend</span><span class="o">=</span><span class="n">backend_eager</span><span class="p">(</span><span class="n">nw_type</span><span class="o">.</span><span class="n">backend</span><span class="p">),</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a>                <span class="p">)</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a>            <span class="p">)</span>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a>            <span class="c1"># except Exception as e:</span>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a>            <span class="c1">#     logger.error(f&quot;Failure of calibration with bounds: {bounds}&quot;)</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a>            <span class="c1">#     logger.error(e)</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>        <span class="k">if</span> <span class="n">w_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_merge_on_weights</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_out</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="n">sequential</span><span class="p">)</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a>        <span class="k">return</span> <span class="n">b_converged</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_moment_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Moment</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a>        <span class="c1">#   Initial weights</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a>        <span class="n">cols_weights</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">]</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a>            <span class="n">cols_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span><span class="p">)</span>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a>        <span class="n">cols_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="n">cols_weights</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a>        <span class="n">qi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a>                <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">(),</span>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols_df</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">(),</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a>                    <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a>                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a>                <span class="p">)</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a>            <span class="p">)</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a>            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols_weights</span><span class="p">)</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>        <span class="p">)</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a>        <span class="n">qi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">safe_sum_cast</span><span class="p">(</span><span class="n">qi</span><span class="p">))</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">([</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span> <span class="o">/</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">coli</span> <span class="ow">in</span> <span class="n">cols_weights</span><span class="p">])</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a>        <span class="p">)</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>            <span class="n">qi_base</span> <span class="o">=</span> <span class="n">qi</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>            <span class="n">qi</span> <span class="o">=</span> <span class="n">qi</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span><span class="p">)</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>            <span class="n">qi_base</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">safe_sum_cast</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">qi_base</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">]))</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>                    <span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span> <span class="o">/</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>                    <span class="p">)</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>                <span class="p">)</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>            <span class="p">)</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>            <span class="n">qi_base</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>        <span class="n">col_qi</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">qi</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>        <span class="n">qi</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">qi</span><span class="p">)</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>        <span class="n">qi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">safe_sum_cast</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">qi</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">col_qi</span><span class="p">))</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>                <span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col_qi</span><span class="p">)</span> <span class="o">/</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col_qi</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>                    <span class="n">qi</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>                <span class="p">)</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>            <span class="p">)</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>        <span class="p">)</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">rescaled_model_matrix</span><span class="p">(</span><span class="n">narrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>        <span class="c1"># Targets need to be adjusted for submoments</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>        <span class="n">targetsi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">())</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">by_share</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>            <span class="p">)</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>        <span class="p">)</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>        <span class="c1">#   Adjust tolerance for subgroup byshare to match actual passed tolerance</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>        <span class="k">if</span> <span class="n">sequential</span><span class="p">:</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>            <span class="n">tol_adj</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">by_share</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>            <span class="n">tol_adj</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>        <span class="k">if</span> <span class="n">add_intercept</span><span class="p">:</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>            <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;___weighting_intercept___&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a>            <span class="p">)</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>            <span class="n">targetsi</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">targetsi</span><span class="p">)</span>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;___weighting_intercept___&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a>            <span class="p">)</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">qi</span><span class="p">,</span> <span class="n">qi_base</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">targetsi</span><span class="p">,</span> <span class="n">tol_adj</span><span class="p">]</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_on_weights</span><span class="p">(</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Moment</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">IntoFrameT</span><span class="p">,</span> <span class="n">sequential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a>    <span class="p">):</span>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a>        <span class="n">temp_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span> <span class="o">+</span> <span class="s2">&quot;___temp___&quot;</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">safe_sum_cast</span><span class="p">(</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a>            <span class="n">weights</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">weights</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">temp_name</span><span class="p">}),</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a>            <span class="n">columns</span><span class="o">=</span><span class="n">temp_name</span><span class="p">,</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a>        <span class="p">)</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a>        <span class="c1">#   Adjust to share in this group (relative to total weight in this group vs. overall)</span>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>        <span class="c1">#       relative to total weights that sum to the n in the sample</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>        <span class="n">n_obs</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a>                <span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span> <span class="o">/</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">n_obs</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a>            <span class="p">)</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>        <span class="p">)</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>        <span class="c1">#   .rename({wOut.columns[0]:self.final_weight}</span>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>        <span class="k">if</span> <span class="n">sequential</span><span class="p">:</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">by_share</span> <span class="o">/</span> <span class="n">n_obs</span> <span class="o">/</span> <span class="n">safe_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>            <span class="p">)</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a>            <span class="c1">#   Merge by index</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a>                <span class="p">[</span>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">)</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>                    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a>                    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">(),</span>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a>                    <span class="n">weights</span><span class="p">,</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a>                <span class="p">],</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a>                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a>            <span class="p">)</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>                    <span class="n">join_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>                <span class="p">)</span>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_missing</span><span class="p">())</span>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a>                    <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">temp_name</span><span class="p">))</span>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a>                    <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">))</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>                    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a>                <span class="p">)</span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a>                <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a>            <span class="p">)</span>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a>            <span class="c1">#   Concatenate, it&#39;s faster (since the data&#39;s sorted and the same length)</span>
<a id="__codelineno-0-1545" name="__codelineno-0-1545"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1546" name="__codelineno-0-1546"></a>                <span class="n">concat_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1547" name="__codelineno-0-1547"></a>                    <span class="p">[</span>
<a id="__codelineno-0-1548" name="__codelineno-0-1548"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-1549" name="__codelineno-0-1549"></a>                        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1550" name="__codelineno-0-1550"></a>                        <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a>                        <span class="o">.</span><span class="n">collect</span><span class="p">(),</span>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">temp_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">}),</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a>                    <span class="p">],</span>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a>                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a>                <span class="p">)</span>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a>                <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a>            <span class="p">)</span>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a>        <span class="c1"># diagi = self._diagnostics_moment(m=m,</span>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a>        <span class="c1">#                                  with_by_prefix=False,</span>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>        <span class="c1">#                                  with_count_prefix=False,</span>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>        <span class="c1">#                                  count_value=False)</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>        <span class="c1"># logger.info(diagi)</span>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-1568" name="__codelineno-0-1568"></a>        <span class="n">diag</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1569" name="__codelineno-0-1569"></a>
<a id="__codelineno-0-1570" name="__codelineno-0-1570"></a>        <span class="n">with_count_prefix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
<a id="__codelineno-0-1571" name="__codelineno-0-1571"></a>        <span class="k">for</span> <span class="n">i_moment</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">):</span>
<a id="__codelineno-0-1572" name="__codelineno-0-1572"></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1573" name="__codelineno-0-1573"></a>                <span class="n">diagi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics_moment</span><span class="p">(</span>
<a id="__codelineno-0-1574" name="__codelineno-0-1574"></a>                    <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
<a id="__codelineno-0-1575" name="__codelineno-0-1575"></a>                    <span class="n">with_by_prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1576" name="__codelineno-0-1576"></a>                    <span class="n">with_count_prefix</span><span class="o">=</span><span class="n">with_count_prefix</span><span class="p">,</span>
<a id="__codelineno-0-1577" name="__codelineno-0-1577"></a>                    <span class="n">count_value</span><span class="o">=</span><span class="n">i_moment</span><span class="p">,</span>
<a id="__codelineno-0-1578" name="__codelineno-0-1578"></a>                <span class="p">)</span>
<a id="__codelineno-0-1579" name="__codelineno-0-1579"></a>
<a id="__codelineno-0-1580" name="__codelineno-0-1580"></a>                <span class="k">if</span> <span class="n">diag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">diagi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1581" name="__codelineno-0-1581"></a>                    <span class="n">diag</span> <span class="o">=</span> <span class="n">diagi</span>
<a id="__codelineno-0-1582" name="__codelineno-0-1582"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1583" name="__codelineno-0-1583"></a>                    <span class="n">diag</span> <span class="o">=</span> <span class="n">concat_wrapper</span><span class="p">([</span><span class="n">diag</span><span class="p">,</span> <span class="n">diagi</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1584" name="__codelineno-0-1584"></a>
<a id="__codelineno-0-1585" name="__codelineno-0-1585"></a>            <span class="k">for</span> <span class="n">subi</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sub_moments</span><span class="p">:</span>
<a id="__codelineno-0-1586" name="__codelineno-0-1586"></a>                <span class="n">diagi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics_moment</span><span class="p">(</span>
<a id="__codelineno-0-1587" name="__codelineno-0-1587"></a>                    <span class="n">m</span><span class="o">=</span><span class="n">subi</span><span class="p">,</span>
<a id="__codelineno-0-1588" name="__codelineno-0-1588"></a>                    <span class="n">with_by_prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1589" name="__codelineno-0-1589"></a>                    <span class="n">with_count_prefix</span><span class="o">=</span><span class="n">with_count_prefix</span><span class="p">,</span>
<a id="__codelineno-0-1590" name="__codelineno-0-1590"></a>                    <span class="n">count_value</span><span class="o">=</span><span class="n">i_moment</span><span class="p">,</span>
<a id="__codelineno-0-1591" name="__codelineno-0-1591"></a>                <span class="p">)</span>
<a id="__codelineno-0-1592" name="__codelineno-0-1592"></a>
<a id="__codelineno-0-1593" name="__codelineno-0-1593"></a>                <span class="k">if</span> <span class="n">diag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">diagi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1594" name="__codelineno-0-1594"></a>                    <span class="n">diag</span> <span class="o">=</span> <span class="n">diagi</span>
<a id="__codelineno-0-1595" name="__codelineno-0-1595"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1596" name="__codelineno-0-1596"></a>                    <span class="n">diag</span> <span class="o">=</span> <span class="n">concat_wrapper</span><span class="p">([</span><span class="n">diag</span><span class="p">,</span> <span class="n">diagi</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1597" name="__codelineno-0-1597"></a>
<a id="__codelineno-0-1598" name="__codelineno-0-1598"></a>        <span class="n">diag</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1599" name="__codelineno-0-1599"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
<a id="__codelineno-0-1600" name="__codelineno-0-1600"></a>            <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Estimates&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_missing</span><span class="p">()))</span>
<a id="__codelineno-0-1601" name="__codelineno-0-1601"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Estimates&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Targets&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1602" name="__codelineno-0-1602"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-1603" name="__codelineno-0-1603"></a>                <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Estimates&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Targets&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;percent&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1604" name="__codelineno-0-1604"></a>            <span class="p">)</span>
<a id="__codelineno-0-1605" name="__codelineno-0-1605"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1606" name="__codelineno-0-1606"></a>        <span class="p">)</span>
<a id="__codelineno-0-1607" name="__codelineno-0-1607"></a>
<a id="__codelineno-0-1608" name="__codelineno-0-1608"></a>        <span class="n">diag</span> <span class="o">=</span> <span class="n">compress_df</span><span class="p">(</span><span class="n">diag</span><span class="p">,</span> <span class="n">no_boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1609" name="__codelineno-0-1609"></a>        <span class="n">max_diff</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1610" name="__codelineno-0-1610"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
<a id="__codelineno-0-1611" name="__codelineno-0-1611"></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Calibrated&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1612" name="__codelineno-0-1612"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;percent&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;abs_diff&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1613" name="__codelineno-0-1613"></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;abs_diff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<a id="__codelineno-0-1614" name="__codelineno-0-1614"></a>            <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
<a id="__codelineno-0-1615" name="__codelineno-0-1615"></a>            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-1616" name="__codelineno-0-1616"></a>            <span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1617" name="__codelineno-0-1617"></a>        <span class="p">)</span>
<a id="__codelineno-0-1618" name="__codelineno-0-1618"></a>
<a id="__codelineno-0-1619" name="__codelineno-0-1619"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">:</span> <span class="n">diag</span><span class="p">,</span> <span class="s2">&quot;max_diff&quot;</span><span class="p">:</span> <span class="n">max_diff</span><span class="p">}</span>
<a id="__codelineno-0-1620" name="__codelineno-0-1620"></a>
<a id="__codelineno-0-1621" name="__codelineno-0-1621"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_diagnostics_moment</span><span class="p">(</span>
<a id="__codelineno-0-1622" name="__codelineno-0-1622"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1623" name="__codelineno-0-1623"></a>        <span class="n">m</span><span class="p">:</span> <span class="n">Moment</span><span class="p">,</span>
<a id="__codelineno-0-1624" name="__codelineno-0-1624"></a>        <span class="n">with_by_prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1625" name="__codelineno-0-1625"></a>        <span class="n">with_count_prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1626" name="__codelineno-0-1626"></a>        <span class="n">count_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-1627" name="__codelineno-0-1627"></a>    <span class="p">):</span>
<a id="__codelineno-0-1628" name="__codelineno-0-1628"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">model_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1629" name="__codelineno-0-1629"></a>            <span class="c1">#   Do nothing</span>
<a id="__codelineno-0-1630" name="__codelineno-0-1630"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-1631" name="__codelineno-0-1631"></a>
<a id="__codelineno-0-1632" name="__codelineno-0-1632"></a>        <span class="c1">#   Calculate the stats on model matrix</span>
<a id="__codelineno-0-1633" name="__codelineno-0-1633"></a>        <span class="c1">#       Rescale the data (if necessary)</span>
<a id="__codelineno-0-1634" name="__codelineno-0-1634"></a>        <span class="n">cols_df</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1635" name="__codelineno-0-1635"></a>        <span class="n">cols_df</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1636" name="__codelineno-0-1636"></a>        <span class="n">cols_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-0-1637" name="__codelineno-0-1637"></a>        <span class="n">cols_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1638" name="__codelineno-0-1638"></a>
<a id="__codelineno-0-1639" name="__codelineno-0-1639"></a>        <span class="n">df_statsin</span> <span class="o">=</span> <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1640" name="__codelineno-0-1640"></a>            <span class="n">m</span><span class="o">.</span><span class="n">rescaled_model_matrix</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
<a id="__codelineno-0-1641" name="__codelineno-0-1641"></a>        <span class="p">)</span>
<a id="__codelineno-0-1642" name="__codelineno-0-1642"></a>
<a id="__codelineno-0-1643" name="__codelineno-0-1643"></a>        <span class="c1">#       What are we calculating</span>
<a id="__codelineno-0-1644" name="__codelineno-0-1644"></a>        <span class="n">c_exclude</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">]</span>
<a id="__codelineno-0-1645" name="__codelineno-0-1645"></a>        <span class="n">c_exclude</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1646" name="__codelineno-0-1646"></a>
<a id="__codelineno-0-1647" name="__codelineno-0-1647"></a>        <span class="n">cols_in_mm</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-1648" name="__codelineno-0-1648"></a>            <span class="n">coli</span>
<a id="__codelineno-0-1649" name="__codelineno-0-1649"></a>            <span class="k">for</span> <span class="n">coli</span> <span class="ow">in</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()</span>
<a id="__codelineno-0-1650" name="__codelineno-0-1650"></a>            <span class="k">if</span> <span class="n">coli</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-0-1651" name="__codelineno-0-1651"></a>        <span class="p">]</span>
<a id="__codelineno-0-1652" name="__codelineno-0-1652"></a>        <span class="n">column_stats</span> <span class="o">=</span> <span class="n">column_stats_builder</span><span class="p">(</span>
<a id="__codelineno-0-1653" name="__codelineno-0-1653"></a>            <span class="n">cols_include</span><span class="o">=</span><span class="n">cols_in_mm</span><span class="p">,</span>
<a id="__codelineno-0-1654" name="__codelineno-0-1654"></a>            <span class="n">df</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">model_matrix</span><span class="p">,</span>
<a id="__codelineno-0-1655" name="__codelineno-0-1655"></a>            <span class="n">cols_exclude</span><span class="o">=</span><span class="n">c_exclude</span><span class="p">,</span>
<a id="__codelineno-0-1656" name="__codelineno-0-1656"></a>            <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1657" name="__codelineno-0-1657"></a>        <span class="p">)</span>
<a id="__codelineno-0-1658" name="__codelineno-0-1658"></a>        <span class="c1">#       Final weighted estimates</span>
<a id="__codelineno-0-1659" name="__codelineno-0-1659"></a>        <span class="n">df_estimates</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1660" name="__codelineno-0-1660"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-1661" name="__codelineno-0-1661"></a>                <span class="n">calculate_by</span><span class="p">(</span>
<a id="__codelineno-0-1662" name="__codelineno-0-1662"></a>                    <span class="n">df</span><span class="o">=</span><span class="n">df_statsin</span><span class="p">,</span>
<a id="__codelineno-0-1663" name="__codelineno-0-1663"></a>                    <span class="n">column_stats</span><span class="o">=</span><span class="n">column_stats</span><span class="p">,</span>
<a id="__codelineno-0-1664" name="__codelineno-0-1664"></a>                    <span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">,</span>
<a id="__codelineno-0-1665" name="__codelineno-0-1665"></a>                    <span class="n">no_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1666" name="__codelineno-0-1666"></a>                <span class="p">)</span>
<a id="__codelineno-0-1667" name="__codelineno-0-1667"></a>            <span class="p">)</span>
<a id="__codelineno-0-1668" name="__codelineno-0-1668"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">numeric</span><span class="p">()</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">by_share</span><span class="p">)</span>
<a id="__codelineno-0-1669" name="__codelineno-0-1669"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Estimates&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1670" name="__codelineno-0-1670"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1671" name="__codelineno-0-1671"></a>        <span class="p">)</span>
<a id="__codelineno-0-1672" name="__codelineno-0-1672"></a>        <span class="n">df_estimates</span> <span class="o">=</span> <span class="n">df_estimates</span>
<a id="__codelineno-0-1673" name="__codelineno-0-1673"></a>
<a id="__codelineno-0-1674" name="__codelineno-0-1674"></a>        <span class="c1">#       Initial values</span>
<a id="__codelineno-0-1675" name="__codelineno-0-1675"></a>        <span class="n">df_initial</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1676" name="__codelineno-0-1676"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span>
<a id="__codelineno-0-1677" name="__codelineno-0-1677"></a>                <span class="n">calculate_by</span><span class="p">(</span>
<a id="__codelineno-0-1678" name="__codelineno-0-1678"></a>                    <span class="n">df</span><span class="o">=</span><span class="n">df_statsin</span><span class="p">,</span>
<a id="__codelineno-0-1679" name="__codelineno-0-1679"></a>                    <span class="n">column_stats</span><span class="o">=</span><span class="n">column_stats</span><span class="p">,</span>
<a id="__codelineno-0-1680" name="__codelineno-0-1680"></a>                    <span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
<a id="__codelineno-0-1681" name="__codelineno-0-1681"></a>                    <span class="n">no_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1682" name="__codelineno-0-1682"></a>                <span class="p">)</span>
<a id="__codelineno-0-1683" name="__codelineno-0-1683"></a>            <span class="p">)</span>
<a id="__codelineno-0-1684" name="__codelineno-0-1684"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">numeric</span><span class="p">()</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">by_share</span><span class="p">)</span>
<a id="__codelineno-0-1685" name="__codelineno-0-1685"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Initial&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1686" name="__codelineno-0-1686"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1687" name="__codelineno-0-1687"></a>        <span class="p">)</span>
<a id="__codelineno-0-1688" name="__codelineno-0-1688"></a>
<a id="__codelineno-0-1689" name="__codelineno-0-1689"></a>        <span class="c1">#   Return some basic info with the diagnostics</span>
<a id="__codelineno-0-1690" name="__codelineno-0-1690"></a>        <span class="n">df_targets</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1691" name="__codelineno-0-1691"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-0-1692" name="__codelineno-0-1692"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Targets&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1693" name="__codelineno-0-1693"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1694" name="__codelineno-0-1694"></a>        <span class="p">)</span>
<a id="__codelineno-0-1695" name="__codelineno-0-1695"></a>
<a id="__codelineno-0-1696" name="__codelineno-0-1696"></a>        <span class="c1">#   Non-zero counts in the weighted data</span>
<a id="__codelineno-0-1697" name="__codelineno-0-1697"></a>        <span class="n">df_non_zero</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1698" name="__codelineno-0-1698"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">non_zero</span><span class="p">)</span>
<a id="__codelineno-0-1699" name="__codelineno-0-1699"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;NonZero&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1700" name="__codelineno-0-1700"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1701" name="__codelineno-0-1701"></a>        <span class="p">)</span>
<a id="__codelineno-0-1702" name="__codelineno-0-1702"></a>
<a id="__codelineno-0-1703" name="__codelineno-0-1703"></a>        <span class="c1">#   Non-zero counts in the target data</span>
<a id="__codelineno-0-1704" name="__codelineno-0-1704"></a>        <span class="n">df_non_zero_target</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1705" name="__codelineno-0-1705"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">non_zero_target</span><span class="p">)</span>
<a id="__codelineno-0-1706" name="__codelineno-0-1706"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;NonZero_Target&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1707" name="__codelineno-0-1707"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1708" name="__codelineno-0-1708"></a>        <span class="p">)</span>
<a id="__codelineno-0-1709" name="__codelineno-0-1709"></a>
<a id="__codelineno-0-1710" name="__codelineno-0-1710"></a>        <span class="c1">#   What variables were actually used in the calibration?</span>
<a id="__codelineno-0-1711" name="__codelineno-0-1711"></a>        <span class="c1">#       It seems easiest to use the one row NonZero vector as the basis</span>
<a id="__codelineno-0-1712" name="__codelineno-0-1712"></a>        <span class="n">cols_m_no_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">ci</span> <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">ci</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<a id="__codelineno-0-1713" name="__codelineno-0-1713"></a>        <span class="n">c_ones</span> <span class="o">=</span> <span class="p">[</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span> <span class="k">for</span> <span class="n">coli</span> <span class="ow">in</span> <span class="n">cols_m_no_index</span><span class="p">]</span>
<a id="__codelineno-0-1714" name="__codelineno-0-1714"></a>        <span class="n">c_zeros</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-1715" name="__codelineno-0-1715"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">coli</span><span class="p">)</span> <span class="k">for</span> <span class="n">coli</span> <span class="ow">in</span> <span class="n">cols_in_mm</span> <span class="k">if</span> <span class="n">coli</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_m_no_index</span>
<a id="__codelineno-0-1716" name="__codelineno-0-1716"></a>        <span class="p">]</span>
<a id="__codelineno-0-1717" name="__codelineno-0-1717"></a>
<a id="__codelineno-0-1718" name="__codelineno-0-1718"></a>        <span class="n">df_calibrated</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1719" name="__codelineno-0-1719"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">non_zero</span><span class="p">)</span>
<a id="__codelineno-0-1720" name="__codelineno-0-1720"></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cols_m_no_index</span><span class="p">)</span>
<a id="__codelineno-0-1721" name="__codelineno-0-1721"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">c_ones</span><span class="p">)</span>
<a id="__codelineno-0-1722" name="__codelineno-0-1722"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">c_zeros</span><span class="p">)</span>
<a id="__codelineno-0-1723" name="__codelineno-0-1723"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Calibrated&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">))</span>
<a id="__codelineno-0-1724" name="__codelineno-0-1724"></a>            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1725" name="__codelineno-0-1725"></a>        <span class="p">)</span>
<a id="__codelineno-0-1726" name="__codelineno-0-1726"></a>
<a id="__codelineno-0-1727" name="__codelineno-0-1727"></a>        <span class="c1">#   Stack the results</span>
<a id="__codelineno-0-1728" name="__codelineno-0-1728"></a>        <span class="n">df_diagnostics</span> <span class="o">=</span> <span class="n">concat_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1729" name="__codelineno-0-1729"></a>            <span class="p">[</span>
<a id="__codelineno-0-1730" name="__codelineno-0-1730"></a>                <span class="n">df_initial</span><span class="p">,</span>
<a id="__codelineno-0-1731" name="__codelineno-0-1731"></a>                <span class="n">df_targets</span><span class="p">,</span>
<a id="__codelineno-0-1732" name="__codelineno-0-1732"></a>                <span class="n">df_estimates</span><span class="p">,</span>
<a id="__codelineno-0-1733" name="__codelineno-0-1733"></a>                <span class="n">df_calibrated</span><span class="p">,</span>
<a id="__codelineno-0-1734" name="__codelineno-0-1734"></a>                <span class="n">df_non_zero</span><span class="p">,</span>
<a id="__codelineno-0-1735" name="__codelineno-0-1735"></a>                <span class="n">df_non_zero_target</span><span class="p">,</span>
<a id="__codelineno-0-1736" name="__codelineno-0-1736"></a>            <span class="p">],</span>
<a id="__codelineno-0-1737" name="__codelineno-0-1737"></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;diagonal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1738" name="__codelineno-0-1738"></a>        <span class="p">)</span>
<a id="__codelineno-0-1739" name="__codelineno-0-1739"></a>
<a id="__codelineno-0-1740" name="__codelineno-0-1740"></a>        <span class="c1">#   Add the prefix?</span>
<a id="__codelineno-0-1741" name="__codelineno-0-1741"></a>        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_prefix</span><span class="p">(</span>
<a id="__codelineno-0-1742" name="__codelineno-0-1742"></a>            <span class="n">with_by_prefix</span><span class="o">=</span><span class="n">with_by_prefix</span><span class="p">,</span>
<a id="__codelineno-0-1743" name="__codelineno-0-1743"></a>            <span class="n">with_count_prefix</span><span class="o">=</span><span class="n">with_count_prefix</span><span class="p">,</span>
<a id="__codelineno-0-1744" name="__codelineno-0-1744"></a>            <span class="n">count_value</span><span class="o">=</span><span class="n">count_value</span><span class="p">,</span>
<a id="__codelineno-0-1745" name="__codelineno-0-1745"></a>            <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
<a id="__codelineno-0-1746" name="__codelineno-0-1746"></a>        <span class="p">)</span>
<a id="__codelineno-0-1747" name="__codelineno-0-1747"></a>        <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1748" name="__codelineno-0-1748"></a>            <span class="n">df_diagnostics</span> <span class="o">=</span> <span class="n">rename_with_prefix_suffix</span><span class="p">(</span>
<a id="__codelineno-0-1749" name="__codelineno-0-1749"></a>                <span class="n">df</span><span class="o">=</span><span class="n">df_diagnostics</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ExcludeList</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Column&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1750" name="__codelineno-0-1750"></a>            <span class="p">)</span>
<a id="__codelineno-0-1751" name="__codelineno-0-1751"></a>
<a id="__codelineno-0-1752" name="__codelineno-0-1752"></a>        <span class="c1">#   Reorder and transpose the diagnostics to be easier to read</span>
<a id="__codelineno-0-1753" name="__codelineno-0-1753"></a>        <span class="n">colorder</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-1754" name="__codelineno-0-1754"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_diagnostics</span><span class="p">)</span>
<a id="__codelineno-0-1755" name="__codelineno-0-1755"></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1756" name="__codelineno-0-1756"></a>            <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
<a id="__codelineno-0-1757" name="__codelineno-0-1757"></a>            <span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span>
<a id="__codelineno-0-1758" name="__codelineno-0-1758"></a>            <span class="o">.</span><span class="n">names</span><span class="p">()</span>
<a id="__codelineno-0-1759" name="__codelineno-0-1759"></a>        <span class="p">)</span>
<a id="__codelineno-0-1760" name="__codelineno-0-1760"></a>        <span class="n">nw_type</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">df_diagnostics</span><span class="p">)</span>
<a id="__codelineno-0-1761" name="__codelineno-0-1761"></a>        <span class="n">df_diagnostics</span> <span class="o">=</span> <span class="n">nw_type</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-1762" name="__codelineno-0-1762"></a>        <span class="n">df_diagnostics</span> <span class="o">=</span> <span class="n">nw_type</span><span class="o">.</span><span class="n">from_polars</span><span class="p">(</span>
<a id="__codelineno-0-1763" name="__codelineno-0-1763"></a>            <span class="n">df_diagnostics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">colorder</span><span class="p">)</span>
<a id="__codelineno-0-1764" name="__codelineno-0-1764"></a>            <span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
<a id="__codelineno-0-1765" name="__codelineno-0-1765"></a>                <span class="n">include_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">column_names</span><span class="o">=</span><span class="n">df_diagnostics</span><span class="p">[</span><span class="s2">&quot;Column&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-0-1766" name="__codelineno-0-1766"></a>            <span class="p">)</span>
<a id="__codelineno-0-1767" name="__codelineno-0-1767"></a>            <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;column&quot;</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">})</span>
<a id="__codelineno-0-1768" name="__codelineno-0-1768"></a>        <span class="p">)</span>
<a id="__codelineno-0-1769" name="__codelineno-0-1769"></a>
<a id="__codelineno-0-1770" name="__codelineno-0-1770"></a>        <span class="k">return</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_diagnostics</span><span class="p">)</span><span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="n">nw_type</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1771" name="__codelineno-0-1771"></a>
<a id="__codelineno-0-1772" name="__codelineno-0-1772"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_diagnostics</span><span class="p">(</span>
<a id="__codelineno-0-1773" name="__codelineno-0-1773"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1774" name="__codelineno-0-1774"></a>        <span class="n">max_columns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-0-1775" name="__codelineno-0-1775"></a>        <span class="n">calibrated_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1776" name="__codelineno-0-1776"></a>        <span class="n">min_non_zero</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-1777" name="__codelineno-0-1777"></a>        <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1778" name="__codelineno-0-1778"></a>        <span class="n">descending</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1779" name="__codelineno-0-1779"></a>    <span class="p">):</span>
<a id="__codelineno-0-1780" name="__codelineno-0-1780"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1781" name="__codelineno-0-1781"></a><span class="sd">        Print formatted calibration diagnostics to the logger.</span>
<a id="__codelineno-0-1782" name="__codelineno-0-1782"></a>
<a id="__codelineno-0-1783" name="__codelineno-0-1783"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-1784" name="__codelineno-0-1784"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-1785" name="__codelineno-0-1785"></a><span class="sd">        max_columns : int, optional</span>
<a id="__codelineno-0-1786" name="__codelineno-0-1786"></a><span class="sd">            Maximum number of rows to display. Default is 100.</span>
<a id="__codelineno-0-1787" name="__codelineno-0-1787"></a><span class="sd">        calibrated_only : bool, optional</span>
<a id="__codelineno-0-1788" name="__codelineno-0-1788"></a><span class="sd">            Only show moments that were actually calibrated to. Default is False.</span>
<a id="__codelineno-0-1789" name="__codelineno-0-1789"></a><span class="sd">        min_non_zero : int, optional</span>
<a id="__codelineno-0-1790" name="__codelineno-0-1790"></a><span class="sd">            Minimum non-zero observations required to display a moment. Default is 10.</span>
<a id="__codelineno-0-1791" name="__codelineno-0-1791"></a><span class="sd">        sort : list, optional</span>
<a id="__codelineno-0-1792" name="__codelineno-0-1792"></a><span class="sd">            Column names to sort by. Default is [&quot;Calibrated&quot;, &quot;abs&quot;, &quot;NonZero&quot;].</span>
<a id="__codelineno-0-1793" name="__codelineno-0-1793"></a><span class="sd">        descending : list, optional</span>
<a id="__codelineno-0-1794" name="__codelineno-0-1794"></a><span class="sd">            Sort order for each column in sort. Default is [True, True, True].</span>
<a id="__codelineno-0-1795" name="__codelineno-0-1795"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1796" name="__codelineno-0-1796"></a>
<a id="__codelineno-0-1797" name="__codelineno-0-1797"></a>        <span class="n">diag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics_out</span>
<a id="__codelineno-0-1798" name="__codelineno-0-1798"></a>
<a id="__codelineno-0-1799" name="__codelineno-0-1799"></a>        <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">descending</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1800" name="__codelineno-0-1800"></a>            <span class="n">sort</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Calibrated&quot;</span><span class="p">,</span> <span class="s2">&quot;abs&quot;</span><span class="p">,</span> <span class="s2">&quot;NonZero&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1801" name="__codelineno-0-1801"></a>            <span class="n">descending</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
<a id="__codelineno-0-1802" name="__codelineno-0-1802"></a>
<a id="__codelineno-0-1803" name="__codelineno-0-1803"></a>        <span class="c1">#   Some polars config code to make the diagnostic readable</span>
<a id="__codelineno-0-1804" name="__codelineno-0-1804"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converged:          &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">diag</span><span class="p">[</span><span class="s2">&quot;converged&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-1805" name="__codelineno-0-1805"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Maximum Difference: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">diag</span><span class="p">[</span><span class="s2">&quot;max_diff&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-1806" name="__codelineno-0-1806"></a>
<a id="__codelineno-0-1807" name="__codelineno-0-1807"></a>        <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">diag</span><span class="p">[</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1808" name="__codelineno-0-1808"></a>        <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span>
<a id="__codelineno-0-1809" name="__codelineno-0-1809"></a>
<a id="__codelineno-0-1810" name="__codelineno-0-1810"></a>        <span class="k">if</span> <span class="n">calibrated_only</span><span class="p">:</span>
<a id="__codelineno-0-1811" name="__codelineno-0-1811"></a>            <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">Calibrated</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1812" name="__codelineno-0-1812"></a>
<a id="__codelineno-0-1813" name="__codelineno-0-1813"></a>        <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-1814" name="__codelineno-0-1814"></a>        <span class="c1">#   Only show NonZero_Target if it not identical to NonZero</span>
<a id="__codelineno-0-1815" name="__codelineno-0-1815"></a>        <span class="k">if</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;NonZero&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span>
<a id="__codelineno-0-1816" name="__codelineno-0-1816"></a>            <span class="n">diagnostics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;NonZero_Target&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;NonZero_Target&quot;</span><span class="p">:</span> <span class="s2">&quot;NonZero&quot;</span><span class="p">})</span>
<a id="__codelineno-0-1817" name="__codelineno-0-1817"></a>        <span class="p">):</span>
<a id="__codelineno-0-1818" name="__codelineno-0-1818"></a>            <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NonZero_Target&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1819" name="__codelineno-0-1819"></a>
<a id="__codelineno-0-1820" name="__codelineno-0-1820"></a>        <span class="k">with</span> <span class="n">pl</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="n">fmt_str_lengths</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfg</span><span class="p">:</span>
<a id="__codelineno-0-1821" name="__codelineno-0-1821"></a>            <span class="c1">#   Basic formatting</span>
<a id="__codelineno-0-1822" name="__codelineno-0-1822"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_cell_alignment</span><span class="p">(</span><span class="s2">&quot;RIGHT&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1823" name="__codelineno-0-1823"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_hide_column_data_types</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1824" name="__codelineno-0-1824"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_width_chars</span><span class="p">(</span><span class="mi">600</span><span class="p">)</span>
<a id="__codelineno-0-1825" name="__codelineno-0-1825"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_cols</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()))</span>
<a id="__codelineno-0-1826" name="__codelineno-0-1826"></a>
<a id="__codelineno-0-1827" name="__codelineno-0-1827"></a>            <span class="c1">#   Show all the rows (up to 100)</span>
<a id="__codelineno-0-1828" name="__codelineno-0-1828"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_rows</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">max_columns</span><span class="p">,</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>
<a id="__codelineno-0-1829" name="__codelineno-0-1829"></a>
<a id="__codelineno-0-1830" name="__codelineno-0-1830"></a>            <span class="c1">#   Don&#39;t show tiny moments</span>
<a id="__codelineno-0-1831" name="__codelineno-0-1831"></a>
<a id="__codelineno-0-1832" name="__codelineno-0-1832"></a>            <span class="k">if</span> <span class="n">descending</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1833" name="__codelineno-0-1833"></a>                <span class="n">d_descending</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;descending&quot;</span><span class="p">:</span> <span class="n">descending</span><span class="p">}</span>
<a id="__codelineno-0-1834" name="__codelineno-0-1834"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1835" name="__codelineno-0-1835"></a>                <span class="n">d_descending</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-1836" name="__codelineno-0-1836"></a>
<a id="__codelineno-0-1837" name="__codelineno-0-1837"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-1838" name="__codelineno-0-1838"></a>                <span class="n">diagnostics</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">NonZero</span> <span class="o">&gt;=</span> <span class="n">min_non_zero</span><span class="p">)</span>
<a id="__codelineno-0-1839" name="__codelineno-0-1839"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;abs&quot;</span><span class="p">)))</span>
<a id="__codelineno-0-1840" name="__codelineno-0-1840"></a>                <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="o">**</span><span class="n">d_descending</span><span class="p">)</span>
<a id="__codelineno-0-1841" name="__codelineno-0-1841"></a>                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;abs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1842" name="__codelineno-0-1842"></a>            <span class="p">)</span>
<a id="__codelineno-0-1843" name="__codelineno-0-1843"></a>
<a id="__codelineno-0-1844" name="__codelineno-0-1844"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_final_weights</span><span class="p">(</span>
<a id="__codelineno-0-1845" name="__codelineno-0-1845"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1846" name="__codelineno-0-1846"></a>        <span class="n">df_merge_to</span><span class="p">:</span> <span class="n">IntoFrameT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a>        <span class="n">truncate_low</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a>        <span class="n">truncate_high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntoFrameT</span><span class="p">:</span>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a><span class="sd">        Get the final calibrated weights, optionally merged to another dataframe.</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a>
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a><span class="sd">        df_merge_to : IntoFrameT | None, optional</span>
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a><span class="sd">            Dataframe to merge weights to. If None, returns weights with index only.</span>
<a id="__codelineno-0-1857" name="__codelineno-0-1857"></a><span class="sd">            Default is None.</span>
<a id="__codelineno-0-1858" name="__codelineno-0-1858"></a><span class="sd">        truncate_low : float | None, optional</span>
<a id="__codelineno-0-1859" name="__codelineno-0-1859"></a><span class="sd">            Truncate weights below this value. Default is None.</span>
<a id="__codelineno-0-1860" name="__codelineno-0-1860"></a><span class="sd">        truncate_high : float | None, optional</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a><span class="sd">            Truncate weights above this value. Default is None.</span>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a><span class="sd">        -------</span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a><span class="sd">        IntoFrameT</span>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a><span class="sd">            Dataframe with calibrated weights. If df_merge_to provided, returns that</span>
<a id="__codelineno-0-1867" name="__codelineno-0-1867"></a><span class="sd">            dataframe with weights merged on index. Otherwise returns index columns</span>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a><span class="sd">            and final weight column only.</span>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a>
<a id="__codelineno-0-1871" name="__codelineno-0-1871"></a>        <span class="n">col_weights</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a>        <span class="n">col_weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a>        <span class="n">col_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a>        <span class="n">df_weights</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col_weights</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a>        <span class="n">c_final_weight</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a>        <span class="n">truncate</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a>        <span class="k">if</span> <span class="n">truncate_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a>            <span class="c1">#   N to truncate?</span>
<a id="__codelineno-0-1880" name="__codelineno-0-1880"></a>            <span class="n">expr_low</span> <span class="o">=</span> <span class="n">c_final_weight</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">truncate_low</span><span class="p">)</span>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a>            <span class="n">n_truncate_low</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_weights</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">expr_low</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a>            <span class="p">)</span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     n truncated at </span><span class="si">{</span><span class="n">truncate_low</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">n_truncate_low</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1885" name="__codelineno-0-1885"></a>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a>            <span class="k">if</span> <span class="n">n_truncate_low</span><span class="p">:</span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a>                <span class="n">truncate</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">expr_low</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">truncate_low</span><span class="p">))</span>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a>        <span class="k">if</span> <span class="n">truncate_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a>            <span class="c1">#   N to truncate?</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a>            <span class="n">expr_high</span> <span class="o">=</span> <span class="n">c_final_weight</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">truncate_high</span><span class="p">)</span>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a>            <span class="n">n_truncate_high</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_weights</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">expr_high</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1893" name="__codelineno-0-1893"></a>            <span class="p">)</span>
<a id="__codelineno-0-1894" name="__codelineno-0-1894"></a>
<a id="__codelineno-0-1895" name="__codelineno-0-1895"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     n truncated at </span><span class="si">{</span><span class="n">truncate_high</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">n_truncate_high</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1896" name="__codelineno-0-1896"></a>
<a id="__codelineno-0-1897" name="__codelineno-0-1897"></a>            <span class="k">if</span> <span class="n">n_truncate_high</span><span class="p">:</span>
<a id="__codelineno-0-1898" name="__codelineno-0-1898"></a>                <span class="k">if</span> <span class="n">truncate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1899" name="__codelineno-0-1899"></a>                    <span class="n">base</span> <span class="o">=</span> <span class="n">truncate</span>
<a id="__codelineno-0-1900" name="__codelineno-0-1900"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1901" name="__codelineno-0-1901"></a>                    <span class="n">base</span> <span class="o">=</span> <span class="n">nw</span>
<a id="__codelineno-0-1902" name="__codelineno-0-1902"></a>
<a id="__codelineno-0-1903" name="__codelineno-0-1903"></a>                <span class="n">truncate</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">expr_high</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">truncate_high</span><span class="p">))</span>
<a id="__codelineno-0-1904" name="__codelineno-0-1904"></a>
<a id="__codelineno-0-1905" name="__codelineno-0-1905"></a>        <span class="k">if</span> <span class="n">truncate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1906" name="__codelineno-0-1906"></a>            <span class="n">truncate</span> <span class="o">=</span> <span class="n">truncate</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
<a id="__codelineno-0-1907" name="__codelineno-0-1907"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span>
<a id="__codelineno-0-1908" name="__codelineno-0-1908"></a>            <span class="p">)</span>
<a id="__codelineno-0-1909" name="__codelineno-0-1909"></a>
<a id="__codelineno-0-1910" name="__codelineno-0-1910"></a>            <span class="n">df_weights</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_weights</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">truncate</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1911" name="__codelineno-0-1911"></a>
<a id="__codelineno-0-1912" name="__codelineno-0-1912"></a>        <span class="k">if</span> <span class="n">df_merge_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1913" name="__codelineno-0-1913"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;___rownumber&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-1914" name="__codelineno-0-1914"></a>                <span class="c1">#   Just concatenate, we made the index internally</span>
<a id="__codelineno-0-1915" name="__codelineno-0-1915"></a>                <span class="n">df_weights</span> <span class="o">=</span> <span class="n">concat_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1916" name="__codelineno-0-1916"></a>                    <span class="p">[</span>
<a id="__codelineno-0-1917" name="__codelineno-0-1917"></a>                        <span class="n">df_merge_to</span><span class="p">,</span>
<a id="__codelineno-0-1918" name="__codelineno-0-1918"></a>                        <span class="p">(</span>
<a id="__codelineno-0-1919" name="__codelineno-0-1919"></a>                            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_weights</span><span class="p">)</span>
<a id="__codelineno-0-1920" name="__codelineno-0-1920"></a>                            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1921" name="__codelineno-0-1921"></a>                            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1922" name="__codelineno-0-1922"></a>                            <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1923" name="__codelineno-0-1923"></a>                        <span class="p">),</span>
<a id="__codelineno-0-1924" name="__codelineno-0-1924"></a>                    <span class="p">],</span>
<a id="__codelineno-0-1925" name="__codelineno-0-1925"></a>                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1926" name="__codelineno-0-1926"></a>                <span class="p">)</span>
<a id="__codelineno-0-1927" name="__codelineno-0-1927"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1928" name="__codelineno-0-1928"></a>                <span class="c1">#   Merge on the index (safer - doesn&#39;t require assumption neither have changed)</span>
<a id="__codelineno-0-1929" name="__codelineno-0-1929"></a>                <span class="n">df_weights</span> <span class="o">=</span> <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1930" name="__codelineno-0-1930"></a>                    <span class="n">df_merge_to</span><span class="p">,</span> <span class="n">df_weights</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
<a id="__codelineno-0-1931" name="__codelineno-0-1931"></a>                <span class="p">)</span>
<a id="__codelineno-0-1932" name="__codelineno-0-1932"></a>
<a id="__codelineno-0-1933" name="__codelineno-0-1933"></a>        <span class="k">return</span> <span class="n">df_weights</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="survey_kit.calibration.calibration.Calibration.run" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run</span>


<a href="#survey_kit.calibration.calibration.Calibration.run" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">min_obs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">skip_setup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">print_diagnostics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">skip_diagnostics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">trim</span><span class="p">:</span> <span class="n">Trim</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="o">**</span><span class="n">additional_params</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run the calibration to estimate the weights from the moments.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>min_obs</code>
            </td>
            <td>
                  <code><span title="int">int</span> | <span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Limit the moments to those with more than some number of
non-zero observations.
You can pass a list of increasing values so that if
the model doesn't converge with the lowest number
(the most constraints), then try again dropping
constraints with more non-zero observations and try again.
I.e. if you pass [0,10,100], it will see if the model converges
with min_obs = 0, if not, it will try with min_obs = 10, etc.
The default is 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>print_diagnostics</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print the diagnostics (do the weights match the target moments)?
The default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>skip_diagnostics</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Don't even calculate the diagnostics?
They can take a while to calculate, but
you really shouldn't skip this.
The default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trim</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Trim (survey_kit.calibration.trim.Trim)" href="#survey_kit.calibration.trim.Trim">Trim</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pass a Trim object with bounds on the weights.
The default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**additional_params</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Any additional params that are specific to a
calibration algorithm.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary with diagnostics information including:</p>
<ul>
<li>'converged' : bool
    Whether the calibration converged.</li>
<li>'max_diff' : float
    Maximum difference between targets and estimates (if diagnostics calculated).</li>
<li>'diagnostics' : DataFrame
    Detailed diagnostics by moment (if skip_diagnostics=False).</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic calibration run::</p>
<div class="highlight"><pre><span></span><code>diagnostics = c.run(min_obs=50)
print(f&quot;Converged: {diagnostics[&#39;converged&#39;]}&quot;)
print(f&quot;Max difference: {diagnostics[&#39;max_diff&#39;]}&quot;)
</code></pre></div>
<p>Run with fallback min_obs levels::</p>
<div class="highlight"><pre><span></span><code># Try with no minimum first, then 10, then 100 if previous fails
diagnostics = c.run(min_obs=[0, 10, 100])
</code></pre></div>
<p>Run with weight trimming::</p>
<div class="highlight"><pre><span></span><code>trim_params = Trim(trim=True, min_val=0.1, max_val=5.0)
diagnostics = c.run(trim=trim_params)
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>src\survey_kit\calibration\calibration.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-687" name="__codelineno-0-687"></a><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>    <span class="n">min_obs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="n">skip_setup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>    <span class="n">print_diagnostics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>    <span class="n">skip_diagnostics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>    <span class="n">trim</span><span class="p">:</span> <span class="n">Trim</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>    <span class="o">**</span><span class="n">additional_params</span><span class="p">,</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a><span class="sd">    Run the calibration to estimate the weights from the moments.</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a><span class="sd">    min_obs : int | list[int], optional</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a><span class="sd">        Limit the moments to those with more than some number of</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><span class="sd">        non-zero observations.</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a><span class="sd">        You can pass a list of increasing values so that if</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a><span class="sd">        the model doesn&#39;t converge with the lowest number</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="sd">        (the most constraints), then try again dropping</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a><span class="sd">        constraints with more non-zero observations and try again.</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><span class="sd">        I.e. if you pass [0,10,100], it will see if the model converges</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a><span class="sd">        with min_obs = 0, if not, it will try with min_obs = 10, etc.</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><span class="sd">        The default is 0.</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><span class="sd">    print_diagnostics : bool, optional</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a><span class="sd">        Print the diagnostics (do the weights match the target moments)?</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="sd">        The default is True.</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a><span class="sd">    skip_diagnostics : bool, optional</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a><span class="sd">        Don&#39;t even calculate the diagnostics?</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a><span class="sd">        They can take a while to calculate, but</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a><span class="sd">        you really shouldn&#39;t skip this.</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a><span class="sd">        The default is False.</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><span class="sd">    trim : Trim | None, optional</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="sd">        Pass a Trim object with bounds on the weights.</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a><span class="sd">        The default is None.</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a><span class="sd">    **additional_params : dict</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a><span class="sd">        Any additional params that are specific to a</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a><span class="sd">        calibration algorithm.</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><span class="sd">    -------</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a><span class="sd">    dict</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a><span class="sd">        A dictionary with diagnostics information including:</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="sd">        - &#39;converged&#39; : bool</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><span class="sd">            Whether the calibration converged.</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><span class="sd">        - &#39;max_diff&#39; : float</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a><span class="sd">            Maximum difference between targets and estimates (if diagnostics calculated).</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a><span class="sd">        - &#39;diagnostics&#39; : DataFrame</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a><span class="sd">            Detailed diagnostics by moment (if skip_diagnostics=False).</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="sd">    Examples</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a><span class="sd">    --------</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a><span class="sd">    Basic calibration run::</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a><span class="sd">        diagnostics = c.run(min_obs=50)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a><span class="sd">        print(f&quot;Converged: {diagnostics[&#39;converged&#39;]}&quot;)</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a><span class="sd">        print(f&quot;Max difference: {diagnostics[&#39;max_diff&#39;]}&quot;)</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a><span class="sd">    Run with fallback min_obs levels::</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a><span class="sd">        # Try with no minimum first, then 10, then 100 if previous fails</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a><span class="sd">        diagnostics = c.run(min_obs=[0, 10, 100])</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a><span class="sd">    Run with weight trimming::</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a><span class="sd">        trim_params = Trim(trim=True, min_val=0.1, max_val=5.0)</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a><span class="sd">        diagnostics = c.run(trim=trim_params)</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>    <span class="c1">#  Is min_obs a list of values?</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>    <span class="c1">#       If so, run this recursively on the remaining obs, if it doesn&#39;t converge on this one</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>    <span class="n">min_obs_remaining</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">min_obs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_obs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>            <span class="n">min_obs_remaining</span> <span class="o">=</span> <span class="n">min_obs</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_obs</span><span class="p">)]</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>            <span class="n">min_obs</span> <span class="o">=</span> <span class="n">min_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>            <span class="n">min_obs</span> <span class="o">=</span> <span class="n">min_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>            <span class="n">min_obs_remaining</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>    <span class="k">if</span> <span class="n">min_obs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">censor_to_min_obs</span><span class="p">(</span><span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs</span><span class="p">)</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>    <span class="c1">#   Need to loop if trimmed</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>    <span class="c1">#   bLoopNeeded = self.Trimmed</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>    <span class="n">bLoopNeeded</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Sequential&quot;</span><span class="p">:</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>        <span class="c1">#   Sequential - need loop</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>        <span class="n">bLoopNeeded</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Combined&quot;</span><span class="p">:</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_setup</span><span class="p">:</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">combine_moments</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sub_moments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Both&quot;</span><span class="p">:</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_setup</span><span class="p">:</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>            <span class="c1">#   Clone this and create a version with the moments combined</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span> <span class="o">=</span> <span class="n">deepcopy_with_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">=</span> <span class="s2">&quot;Combined&quot;</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>            <span class="c1"># Do not trim within the combined calibration (handled in self)</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>            <span class="c1">#   self.c_combined.Trimmed = False</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">c_combined</span><span class="o">.</span><span class="n">combine_moments</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sub_moments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calibrating weights using &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>    <span class="k">if</span> <span class="n">min_obs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      min obs = </span><span class="si">{</span><span class="n">min_obs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>    <span class="k">if</span> <span class="n">bLoopNeeded</span><span class="p">:</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>        <span class="n">n_loops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations_loop</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>        <span class="n">n_loops</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>    <span class="c1">#   Loop counter</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>    <span class="n">iLoop</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>    <span class="c1">#   Within-loop completion flag</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>    <span class="n">b_complete</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>    <span class="n">diagnostics</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>    <span class="k">while</span> <span class="p">(</span><span class="n">iLoop</span> <span class="o">&lt;</span> <span class="n">n_loops</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b_complete</span><span class="p">:</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>        <span class="k">if</span> <span class="n">n_loops</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n\n</span><span class="s2">Running loop #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iLoop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>        <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_one_loop</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="n">trim</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">)</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>        <span class="n">converged</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;converged&quot;</span><span class="p">]</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>        <span class="k">if</span> <span class="s2">&quot;diagnostics&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>            <span class="c1">#   Not full diagnostics, set to null to load later</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>            <span class="n">diagnostics</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>        <span class="c1">#   Default to complete unless set to False below</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>        <span class="n">b_complete</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>        <span class="k">if</span> <span class="n">trim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>            <span class="c1">#   Need trimming?</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>            <span class="c1">#       Don&#39;t trim if aebw without separately passed bounds</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>            <span class="k">if</span> <span class="n">trim</span><span class="o">.</span><span class="n">trim</span> <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;aebw&quot;</span> <span class="ow">and</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">additional_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>            <span class="p">):</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>                <span class="n">b_complete</span> <span class="o">=</span> <span class="n">trim</span><span class="o">.</span><span class="n">trim_in_loop</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">iLoop</span><span class="o">=</span><span class="n">iLoop</span><span class="p">,</span> <span class="n">n_loops</span><span class="o">=</span><span class="n">n_loops</span><span class="p">)</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;Sequential&quot;</span><span class="p">:</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>            <span class="c1"># Check the max deviation against the tolerance</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>            <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">()</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>            <span class="n">max_diff</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;max_diff&quot;</span><span class="p">]</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>            <span class="n">converged</span> <span class="o">=</span> <span class="n">max_diff</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tolerance_Loop</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>            <span class="n">b_complete</span> <span class="o">=</span> <span class="n">converged</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>        <span class="n">iLoop</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_diagnostics</span><span class="p">:</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>        <span class="k">if</span> <span class="n">diagnostics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>            <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">()</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>        <span class="k">if</span> <span class="n">n_loops</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>            <span class="n">b_complete</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;max_diff&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>            <span class="n">b_complete</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;max_diff&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">b_complete</span> <span class="ow">or</span> <span class="n">converged</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">min_obs_remaining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>            <span class="c1">#   Recursively call this again, if needed</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>            <span class="c1">#   Reset the &quot;final weight&quot; (current weight) to the original one passed</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>            <span class="c1">#       (ignores the failed run&#39;s output)</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a>                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">))</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a>            <span class="p">)</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>            <span class="n">diagnostics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>                <span class="n">min_obs</span><span class="o">=</span><span class="n">min_obs_remaining</span><span class="p">,</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>                <span class="n">skip_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>                <span class="n">print_diagnostics</span><span class="o">=</span><span class="n">print_diagnostics</span><span class="p">,</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>                <span class="n">skip_diagnostics</span><span class="o">=</span><span class="n">skip_diagnostics</span><span class="p">,</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>                <span class="o">**</span><span class="n">additional_params</span><span class="p">,</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>            <span class="p">)</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>            <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;converged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converged</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>        <span class="k">if</span> <span class="s2">&quot;diagnostics&quot;</span> <span class="ow">in</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>            <span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">[</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">])</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>                <span class="o">.</span><span class="n">lazy_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nw_type</span><span class="p">)</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>                <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>            <span class="p">)</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics_out</span> <span class="o">=</span> <span class="n">diagnostics</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>        <span class="k">if</span> <span class="n">print_diagnostics</span><span class="p">:</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">()</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>    <span class="k">return</span> <span class="n">diagnostics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="survey_kit.calibration.calibration.Calibration.print_diagnostics" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">print_diagnostics</span>


<a href="#survey_kit.calibration.calibration.Calibration.print_diagnostics" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">print_diagnostics</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">max_columns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">calibrated_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">min_non_zero</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">descending</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Print formatted calibration diagnostics to the logger.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>max_columns</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of rows to display. Default is 100.</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calibrated_only</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Only show moments that were actually calibrated to. Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_non_zero</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum non-zero observations required to display a moment. Default is 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sort</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Column names to sort by. Default is ["Calibrated", "abs", "NonZero"].</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>descending</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sort order for each column in sort. Default is [True, True, True].</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\survey_kit\calibration\calibration.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1772">1772</a></span>
<span class="normal"><a href="#__codelineno-0-1773">1773</a></span>
<span class="normal"><a href="#__codelineno-0-1774">1774</a></span>
<span class="normal"><a href="#__codelineno-0-1775">1775</a></span>
<span class="normal"><a href="#__codelineno-0-1776">1776</a></span>
<span class="normal"><a href="#__codelineno-0-1777">1777</a></span>
<span class="normal"><a href="#__codelineno-0-1778">1778</a></span>
<span class="normal"><a href="#__codelineno-0-1779">1779</a></span>
<span class="normal"><a href="#__codelineno-0-1780">1780</a></span>
<span class="normal"><a href="#__codelineno-0-1781">1781</a></span>
<span class="normal"><a href="#__codelineno-0-1782">1782</a></span>
<span class="normal"><a href="#__codelineno-0-1783">1783</a></span>
<span class="normal"><a href="#__codelineno-0-1784">1784</a></span>
<span class="normal"><a href="#__codelineno-0-1785">1785</a></span>
<span class="normal"><a href="#__codelineno-0-1786">1786</a></span>
<span class="normal"><a href="#__codelineno-0-1787">1787</a></span>
<span class="normal"><a href="#__codelineno-0-1788">1788</a></span>
<span class="normal"><a href="#__codelineno-0-1789">1789</a></span>
<span class="normal"><a href="#__codelineno-0-1790">1790</a></span>
<span class="normal"><a href="#__codelineno-0-1791">1791</a></span>
<span class="normal"><a href="#__codelineno-0-1792">1792</a></span>
<span class="normal"><a href="#__codelineno-0-1793">1793</a></span>
<span class="normal"><a href="#__codelineno-0-1794">1794</a></span>
<span class="normal"><a href="#__codelineno-0-1795">1795</a></span>
<span class="normal"><a href="#__codelineno-0-1796">1796</a></span>
<span class="normal"><a href="#__codelineno-0-1797">1797</a></span>
<span class="normal"><a href="#__codelineno-0-1798">1798</a></span>
<span class="normal"><a href="#__codelineno-0-1799">1799</a></span>
<span class="normal"><a href="#__codelineno-0-1800">1800</a></span>
<span class="normal"><a href="#__codelineno-0-1801">1801</a></span>
<span class="normal"><a href="#__codelineno-0-1802">1802</a></span>
<span class="normal"><a href="#__codelineno-0-1803">1803</a></span>
<span class="normal"><a href="#__codelineno-0-1804">1804</a></span>
<span class="normal"><a href="#__codelineno-0-1805">1805</a></span>
<span class="normal"><a href="#__codelineno-0-1806">1806</a></span>
<span class="normal"><a href="#__codelineno-0-1807">1807</a></span>
<span class="normal"><a href="#__codelineno-0-1808">1808</a></span>
<span class="normal"><a href="#__codelineno-0-1809">1809</a></span>
<span class="normal"><a href="#__codelineno-0-1810">1810</a></span>
<span class="normal"><a href="#__codelineno-0-1811">1811</a></span>
<span class="normal"><a href="#__codelineno-0-1812">1812</a></span>
<span class="normal"><a href="#__codelineno-0-1813">1813</a></span>
<span class="normal"><a href="#__codelineno-0-1814">1814</a></span>
<span class="normal"><a href="#__codelineno-0-1815">1815</a></span>
<span class="normal"><a href="#__codelineno-0-1816">1816</a></span>
<span class="normal"><a href="#__codelineno-0-1817">1817</a></span>
<span class="normal"><a href="#__codelineno-0-1818">1818</a></span>
<span class="normal"><a href="#__codelineno-0-1819">1819</a></span>
<span class="normal"><a href="#__codelineno-0-1820">1820</a></span>
<span class="normal"><a href="#__codelineno-0-1821">1821</a></span>
<span class="normal"><a href="#__codelineno-0-1822">1822</a></span>
<span class="normal"><a href="#__codelineno-0-1823">1823</a></span>
<span class="normal"><a href="#__codelineno-0-1824">1824</a></span>
<span class="normal"><a href="#__codelineno-0-1825">1825</a></span>
<span class="normal"><a href="#__codelineno-0-1826">1826</a></span>
<span class="normal"><a href="#__codelineno-0-1827">1827</a></span>
<span class="normal"><a href="#__codelineno-0-1828">1828</a></span>
<span class="normal"><a href="#__codelineno-0-1829">1829</a></span>
<span class="normal"><a href="#__codelineno-0-1830">1830</a></span>
<span class="normal"><a href="#__codelineno-0-1831">1831</a></span>
<span class="normal"><a href="#__codelineno-0-1832">1832</a></span>
<span class="normal"><a href="#__codelineno-0-1833">1833</a></span>
<span class="normal"><a href="#__codelineno-0-1834">1834</a></span>
<span class="normal"><a href="#__codelineno-0-1835">1835</a></span>
<span class="normal"><a href="#__codelineno-0-1836">1836</a></span>
<span class="normal"><a href="#__codelineno-0-1837">1837</a></span>
<span class="normal"><a href="#__codelineno-0-1838">1838</a></span>
<span class="normal"><a href="#__codelineno-0-1839">1839</a></span>
<span class="normal"><a href="#__codelineno-0-1840">1840</a></span>
<span class="normal"><a href="#__codelineno-0-1841">1841</a></span>
<span class="normal"><a href="#__codelineno-0-1842">1842</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1772" name="__codelineno-0-1772"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_diagnostics</span><span class="p">(</span>
<a id="__codelineno-0-1773" name="__codelineno-0-1773"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1774" name="__codelineno-0-1774"></a>    <span class="n">max_columns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-0-1775" name="__codelineno-0-1775"></a>    <span class="n">calibrated_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1776" name="__codelineno-0-1776"></a>    <span class="n">min_non_zero</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-1777" name="__codelineno-0-1777"></a>    <span class="n">sort</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1778" name="__codelineno-0-1778"></a>    <span class="n">descending</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1779" name="__codelineno-0-1779"></a><span class="p">):</span>
<a id="__codelineno-0-1780" name="__codelineno-0-1780"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1781" name="__codelineno-0-1781"></a><span class="sd">    Print formatted calibration diagnostics to the logger.</span>
<a id="__codelineno-0-1782" name="__codelineno-0-1782"></a>
<a id="__codelineno-0-1783" name="__codelineno-0-1783"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-1784" name="__codelineno-0-1784"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1785" name="__codelineno-0-1785"></a><span class="sd">    max_columns : int, optional</span>
<a id="__codelineno-0-1786" name="__codelineno-0-1786"></a><span class="sd">        Maximum number of rows to display. Default is 100.</span>
<a id="__codelineno-0-1787" name="__codelineno-0-1787"></a><span class="sd">    calibrated_only : bool, optional</span>
<a id="__codelineno-0-1788" name="__codelineno-0-1788"></a><span class="sd">        Only show moments that were actually calibrated to. Default is False.</span>
<a id="__codelineno-0-1789" name="__codelineno-0-1789"></a><span class="sd">    min_non_zero : int, optional</span>
<a id="__codelineno-0-1790" name="__codelineno-0-1790"></a><span class="sd">        Minimum non-zero observations required to display a moment. Default is 10.</span>
<a id="__codelineno-0-1791" name="__codelineno-0-1791"></a><span class="sd">    sort : list, optional</span>
<a id="__codelineno-0-1792" name="__codelineno-0-1792"></a><span class="sd">        Column names to sort by. Default is [&quot;Calibrated&quot;, &quot;abs&quot;, &quot;NonZero&quot;].</span>
<a id="__codelineno-0-1793" name="__codelineno-0-1793"></a><span class="sd">    descending : list, optional</span>
<a id="__codelineno-0-1794" name="__codelineno-0-1794"></a><span class="sd">        Sort order for each column in sort. Default is [True, True, True].</span>
<a id="__codelineno-0-1795" name="__codelineno-0-1795"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1796" name="__codelineno-0-1796"></a>
<a id="__codelineno-0-1797" name="__codelineno-0-1797"></a>    <span class="n">diag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics_out</span>
<a id="__codelineno-0-1798" name="__codelineno-0-1798"></a>
<a id="__codelineno-0-1799" name="__codelineno-0-1799"></a>    <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">descending</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1800" name="__codelineno-0-1800"></a>        <span class="n">sort</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Calibrated&quot;</span><span class="p">,</span> <span class="s2">&quot;abs&quot;</span><span class="p">,</span> <span class="s2">&quot;NonZero&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1801" name="__codelineno-0-1801"></a>        <span class="n">descending</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
<a id="__codelineno-0-1802" name="__codelineno-0-1802"></a>
<a id="__codelineno-0-1803" name="__codelineno-0-1803"></a>    <span class="c1">#   Some polars config code to make the diagnostic readable</span>
<a id="__codelineno-0-1804" name="__codelineno-0-1804"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converged:          &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">diag</span><span class="p">[</span><span class="s2">&quot;converged&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-1805" name="__codelineno-0-1805"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Maximum Difference: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">diag</span><span class="p">[</span><span class="s2">&quot;max_diff&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-1806" name="__codelineno-0-1806"></a>
<a id="__codelineno-0-1807" name="__codelineno-0-1807"></a>    <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">diag</span><span class="p">[</span><span class="s2">&quot;diagnostics&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1808" name="__codelineno-0-1808"></a>    <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">NarwhalsType</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span><span class="o">.</span><span class="n">to_polars</span><span class="p">()</span>
<a id="__codelineno-0-1809" name="__codelineno-0-1809"></a>
<a id="__codelineno-0-1810" name="__codelineno-0-1810"></a>    <span class="k">if</span> <span class="n">calibrated_only</span><span class="p">:</span>
<a id="__codelineno-0-1811" name="__codelineno-0-1811"></a>        <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">Calibrated</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1812" name="__codelineno-0-1812"></a>
<a id="__codelineno-0-1813" name="__codelineno-0-1813"></a>    <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-1814" name="__codelineno-0-1814"></a>    <span class="c1">#   Only show NonZero_Target if it not identical to NonZero</span>
<a id="__codelineno-0-1815" name="__codelineno-0-1815"></a>    <span class="k">if</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;NonZero&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span>
<a id="__codelineno-0-1816" name="__codelineno-0-1816"></a>        <span class="n">diagnostics</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;NonZero_Target&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;NonZero_Target&quot;</span><span class="p">:</span> <span class="s2">&quot;NonZero&quot;</span><span class="p">})</span>
<a id="__codelineno-0-1817" name="__codelineno-0-1817"></a>    <span class="p">):</span>
<a id="__codelineno-0-1818" name="__codelineno-0-1818"></a>        <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;NonZero_Target&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1819" name="__codelineno-0-1819"></a>
<a id="__codelineno-0-1820" name="__codelineno-0-1820"></a>    <span class="k">with</span> <span class="n">pl</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="n">fmt_str_lengths</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfg</span><span class="p">:</span>
<a id="__codelineno-0-1821" name="__codelineno-0-1821"></a>        <span class="c1">#   Basic formatting</span>
<a id="__codelineno-0-1822" name="__codelineno-0-1822"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_cell_alignment</span><span class="p">(</span><span class="s2">&quot;RIGHT&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1823" name="__codelineno-0-1823"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_hide_column_data_types</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1824" name="__codelineno-0-1824"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_width_chars</span><span class="p">(</span><span class="mi">600</span><span class="p">)</span>
<a id="__codelineno-0-1825" name="__codelineno-0-1825"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_cols</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diagnostics</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">()))</span>
<a id="__codelineno-0-1826" name="__codelineno-0-1826"></a>
<a id="__codelineno-0-1827" name="__codelineno-0-1827"></a>        <span class="c1">#   Show all the rows (up to 100)</span>
<a id="__codelineno-0-1828" name="__codelineno-0-1828"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">set_tbl_rows</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">max_columns</span><span class="p">,</span> <span class="n">diagnostics</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>
<a id="__codelineno-0-1829" name="__codelineno-0-1829"></a>
<a id="__codelineno-0-1830" name="__codelineno-0-1830"></a>        <span class="c1">#   Don&#39;t show tiny moments</span>
<a id="__codelineno-0-1831" name="__codelineno-0-1831"></a>
<a id="__codelineno-0-1832" name="__codelineno-0-1832"></a>        <span class="k">if</span> <span class="n">descending</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1833" name="__codelineno-0-1833"></a>            <span class="n">d_descending</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;descending&quot;</span><span class="p">:</span> <span class="n">descending</span><span class="p">}</span>
<a id="__codelineno-0-1834" name="__codelineno-0-1834"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1835" name="__codelineno-0-1835"></a>            <span class="n">d_descending</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-1836" name="__codelineno-0-1836"></a>
<a id="__codelineno-0-1837" name="__codelineno-0-1837"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-1838" name="__codelineno-0-1838"></a>            <span class="n">diagnostics</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">NonZero</span> <span class="o">&gt;=</span> <span class="n">min_non_zero</span><span class="p">)</span>
<a id="__codelineno-0-1839" name="__codelineno-0-1839"></a>            <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;abs&quot;</span><span class="p">)))</span>
<a id="__codelineno-0-1840" name="__codelineno-0-1840"></a>            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="o">**</span><span class="n">d_descending</span><span class="p">)</span>
<a id="__codelineno-0-1841" name="__codelineno-0-1841"></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;abs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1842" name="__codelineno-0-1842"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="survey_kit.calibration.calibration.Calibration.get_final_weights" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_final_weights</span>


<a href="#survey_kit.calibration.calibration.Calibration.get_final_weights" class="headerlink" title="Permanent link">&para;</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">get_final_weights</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">df_merge_to</span><span class="p">:</span> <span class="n">IntoFrameT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">truncate_low</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">truncate_high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntoFrameT</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get the final calibrated weights, optionally merged to another dataframe.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df_merge_to</code>
            </td>
            <td>
                  <code><span title="narwhals.typing.IntoFrameT">IntoFrameT</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataframe to merge weights to. If None, returns weights with index only.
Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>truncate_low</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Truncate weights below this value. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>truncate_high</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Truncate weights above this value. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="narwhals.typing.IntoFrameT">IntoFrameT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataframe with calibrated weights. If df_merge_to provided, returns that
dataframe with weights merged on index. Otherwise returns index columns
and final weight column only.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\survey_kit\calibration\calibration.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1844">1844</a></span>
<span class="normal"><a href="#__codelineno-0-1845">1845</a></span>
<span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span>
<span class="normal"><a href="#__codelineno-0-1857">1857</a></span>
<span class="normal"><a href="#__codelineno-0-1858">1858</a></span>
<span class="normal"><a href="#__codelineno-0-1859">1859</a></span>
<span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span>
<span class="normal"><a href="#__codelineno-0-1893">1893</a></span>
<span class="normal"><a href="#__codelineno-0-1894">1894</a></span>
<span class="normal"><a href="#__codelineno-0-1895">1895</a></span>
<span class="normal"><a href="#__codelineno-0-1896">1896</a></span>
<span class="normal"><a href="#__codelineno-0-1897">1897</a></span>
<span class="normal"><a href="#__codelineno-0-1898">1898</a></span>
<span class="normal"><a href="#__codelineno-0-1899">1899</a></span>
<span class="normal"><a href="#__codelineno-0-1900">1900</a></span>
<span class="normal"><a href="#__codelineno-0-1901">1901</a></span>
<span class="normal"><a href="#__codelineno-0-1902">1902</a></span>
<span class="normal"><a href="#__codelineno-0-1903">1903</a></span>
<span class="normal"><a href="#__codelineno-0-1904">1904</a></span>
<span class="normal"><a href="#__codelineno-0-1905">1905</a></span>
<span class="normal"><a href="#__codelineno-0-1906">1906</a></span>
<span class="normal"><a href="#__codelineno-0-1907">1907</a></span>
<span class="normal"><a href="#__codelineno-0-1908">1908</a></span>
<span class="normal"><a href="#__codelineno-0-1909">1909</a></span>
<span class="normal"><a href="#__codelineno-0-1910">1910</a></span>
<span class="normal"><a href="#__codelineno-0-1911">1911</a></span>
<span class="normal"><a href="#__codelineno-0-1912">1912</a></span>
<span class="normal"><a href="#__codelineno-0-1913">1913</a></span>
<span class="normal"><a href="#__codelineno-0-1914">1914</a></span>
<span class="normal"><a href="#__codelineno-0-1915">1915</a></span>
<span class="normal"><a href="#__codelineno-0-1916">1916</a></span>
<span class="normal"><a href="#__codelineno-0-1917">1917</a></span>
<span class="normal"><a href="#__codelineno-0-1918">1918</a></span>
<span class="normal"><a href="#__codelineno-0-1919">1919</a></span>
<span class="normal"><a href="#__codelineno-0-1920">1920</a></span>
<span class="normal"><a href="#__codelineno-0-1921">1921</a></span>
<span class="normal"><a href="#__codelineno-0-1922">1922</a></span>
<span class="normal"><a href="#__codelineno-0-1923">1923</a></span>
<span class="normal"><a href="#__codelineno-0-1924">1924</a></span>
<span class="normal"><a href="#__codelineno-0-1925">1925</a></span>
<span class="normal"><a href="#__codelineno-0-1926">1926</a></span>
<span class="normal"><a href="#__codelineno-0-1927">1927</a></span>
<span class="normal"><a href="#__codelineno-0-1928">1928</a></span>
<span class="normal"><a href="#__codelineno-0-1929">1929</a></span>
<span class="normal"><a href="#__codelineno-0-1930">1930</a></span>
<span class="normal"><a href="#__codelineno-0-1931">1931</a></span>
<span class="normal"><a href="#__codelineno-0-1932">1932</a></span>
<span class="normal"><a href="#__codelineno-0-1933">1933</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1844" name="__codelineno-0-1844"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_final_weights</span><span class="p">(</span>
<a id="__codelineno-0-1845" name="__codelineno-0-1845"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1846" name="__codelineno-0-1846"></a>    <span class="n">df_merge_to</span><span class="p">:</span> <span class="n">IntoFrameT</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a>    <span class="n">truncate_low</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a>    <span class="n">truncate_high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntoFrameT</span><span class="p">:</span>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a><span class="sd">    Get the final calibrated weights, optionally merged to another dataframe.</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a>
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a><span class="sd">    df_merge_to : IntoFrameT | None, optional</span>
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a><span class="sd">        Dataframe to merge weights to. If None, returns weights with index only.</span>
<a id="__codelineno-0-1857" name="__codelineno-0-1857"></a><span class="sd">        Default is None.</span>
<a id="__codelineno-0-1858" name="__codelineno-0-1858"></a><span class="sd">    truncate_low : float | None, optional</span>
<a id="__codelineno-0-1859" name="__codelineno-0-1859"></a><span class="sd">        Truncate weights below this value. Default is None.</span>
<a id="__codelineno-0-1860" name="__codelineno-0-1860"></a><span class="sd">    truncate_high : float | None, optional</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a><span class="sd">        Truncate weights above this value. Default is None.</span>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a><span class="sd">    -------</span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a><span class="sd">    IntoFrameT</span>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a><span class="sd">        Dataframe with calibrated weights. If df_merge_to provided, returns that</span>
<a id="__codelineno-0-1867" name="__codelineno-0-1867"></a><span class="sd">        dataframe with weights merged on index. Otherwise returns index columns</span>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a><span class="sd">        and final weight column only.</span>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a>
<a id="__codelineno-0-1871" name="__codelineno-0-1871"></a>    <span class="n">col_weights</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a>    <span class="n">col_weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a>    <span class="n">col_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a>    <span class="n">df_weights</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col_weights</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a>    <span class="n">c_final_weight</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a>    <span class="n">truncate</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a>    <span class="k">if</span> <span class="n">truncate_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a>        <span class="c1">#   N to truncate?</span>
<a id="__codelineno-0-1880" name="__codelineno-0-1880"></a>        <span class="n">expr_low</span> <span class="o">=</span> <span class="n">c_final_weight</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">truncate_low</span><span class="p">)</span>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a>        <span class="n">n_truncate_low</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_weights</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">expr_low</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a>        <span class="p">)</span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     n truncated at </span><span class="si">{</span><span class="n">truncate_low</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">n_truncate_low</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1885" name="__codelineno-0-1885"></a>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a>        <span class="k">if</span> <span class="n">n_truncate_low</span><span class="p">:</span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a>            <span class="n">truncate</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">expr_low</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">truncate_low</span><span class="p">))</span>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a>    <span class="k">if</span> <span class="n">truncate_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a>        <span class="c1">#   N to truncate?</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a>        <span class="n">expr_high</span> <span class="o">=</span> <span class="n">c_final_weight</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">truncate_high</span><span class="p">)</span>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a>        <span class="n">n_truncate_high</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_weights</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">expr_high</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1893" name="__codelineno-0-1893"></a>        <span class="p">)</span>
<a id="__codelineno-0-1894" name="__codelineno-0-1894"></a>
<a id="__codelineno-0-1895" name="__codelineno-0-1895"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     n truncated at </span><span class="si">{</span><span class="n">truncate_high</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">n_truncate_high</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1896" name="__codelineno-0-1896"></a>
<a id="__codelineno-0-1897" name="__codelineno-0-1897"></a>        <span class="k">if</span> <span class="n">n_truncate_high</span><span class="p">:</span>
<a id="__codelineno-0-1898" name="__codelineno-0-1898"></a>            <span class="k">if</span> <span class="n">truncate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1899" name="__codelineno-0-1899"></a>                <span class="n">base</span> <span class="o">=</span> <span class="n">truncate</span>
<a id="__codelineno-0-1900" name="__codelineno-0-1900"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1901" name="__codelineno-0-1901"></a>                <span class="n">base</span> <span class="o">=</span> <span class="n">nw</span>
<a id="__codelineno-0-1902" name="__codelineno-0-1902"></a>
<a id="__codelineno-0-1903" name="__codelineno-0-1903"></a>            <span class="n">truncate</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">expr_high</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">truncate_high</span><span class="p">))</span>
<a id="__codelineno-0-1904" name="__codelineno-0-1904"></a>
<a id="__codelineno-0-1905" name="__codelineno-0-1905"></a>    <span class="k">if</span> <span class="n">truncate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1906" name="__codelineno-0-1906"></a>        <span class="n">truncate</span> <span class="o">=</span> <span class="n">truncate</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
<a id="__codelineno-0-1907" name="__codelineno-0-1907"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span>
<a id="__codelineno-0-1908" name="__codelineno-0-1908"></a>        <span class="p">)</span>
<a id="__codelineno-0-1909" name="__codelineno-0-1909"></a>
<a id="__codelineno-0-1910" name="__codelineno-0-1910"></a>        <span class="n">df_weights</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_weights</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">truncate</span><span class="p">)</span><span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1911" name="__codelineno-0-1911"></a>
<a id="__codelineno-0-1912" name="__codelineno-0-1912"></a>    <span class="k">if</span> <span class="n">df_merge_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1913" name="__codelineno-0-1913"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;___rownumber&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-1914" name="__codelineno-0-1914"></a>            <span class="c1">#   Just concatenate, we made the index internally</span>
<a id="__codelineno-0-1915" name="__codelineno-0-1915"></a>            <span class="n">df_weights</span> <span class="o">=</span> <span class="n">concat_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1916" name="__codelineno-0-1916"></a>                <span class="p">[</span>
<a id="__codelineno-0-1917" name="__codelineno-0-1917"></a>                    <span class="n">df_merge_to</span><span class="p">,</span>
<a id="__codelineno-0-1918" name="__codelineno-0-1918"></a>                    <span class="p">(</span>
<a id="__codelineno-0-1919" name="__codelineno-0-1919"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df_weights</span><span class="p">)</span>
<a id="__codelineno-0-1920" name="__codelineno-0-1920"></a>                        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-1921" name="__codelineno-0-1921"></a>                        <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-1922" name="__codelineno-0-1922"></a>                        <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-1923" name="__codelineno-0-1923"></a>                    <span class="p">),</span>
<a id="__codelineno-0-1924" name="__codelineno-0-1924"></a>                <span class="p">],</span>
<a id="__codelineno-0-1925" name="__codelineno-0-1925"></a>                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1926" name="__codelineno-0-1926"></a>            <span class="p">)</span>
<a id="__codelineno-0-1927" name="__codelineno-0-1927"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1928" name="__codelineno-0-1928"></a>            <span class="c1">#   Merge on the index (safer - doesn&#39;t require assumption neither have changed)</span>
<a id="__codelineno-0-1929" name="__codelineno-0-1929"></a>            <span class="n">df_weights</span> <span class="o">=</span> <span class="n">join_wrapper</span><span class="p">(</span>
<a id="__codelineno-0-1930" name="__codelineno-0-1930"></a>                <span class="n">df_merge_to</span><span class="p">,</span> <span class="n">df_weights</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
<a id="__codelineno-0-1931" name="__codelineno-0-1931"></a>            <span class="p">)</span>
<a id="__codelineno-0-1932" name="__codelineno-0-1932"></a>
<a id="__codelineno-0-1933" name="__codelineno-0-1933"></a>    <span class="k">return</span> <span class="n">df_weights</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="survey_kit.calibration.trim.Trim" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Trim</span>


<a href="#survey_kit.calibration.trim.Trim" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Serializable (survey_kit.serializable.Serializable)" href="../miscellaneous/#survey_kit.serializable.Serializable">Serializable</a></code></p>


        <p>Weight trimming parameters for iterative calibration.</p>
<p>Controls how calibrated weights are trimmed (bounded) during iterative calibration
to prevent extreme weight values. Trimming can improve practical usability of
weights at the cost of some bias in meeting calibration targets exactly.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trim</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply trimming. Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_val</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum allowed weight ratio (weight/base_weight). Default is 0.05.</p>
              </div>
            </td>
            <td>
                  <code>0.05</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_val</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum allowed weight ratio (weight/base_weight). Default is 5.0.</p>
              </div>
            </td>
            <td>
                  <code>5.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>step</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How much to relax trim bounds on each iteration (multiplied by iteration
number). Default is 0.02.</p>
              </div>
            </td>
            <td>
                  <code>0.02</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tolerance_step</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How much to relax trim tolerance on each iteration. Default is 0.01.</p>
              </div>
            </td>
            <td>
                  <code>0.01</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_n</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Don't trim if fewer than this many observations exceed bounds. This prevents
trimming for a small number of outliers. Default is 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic trimming with standard bounds:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.calibration.trim</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trim</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">trim</span> <span class="o">=</span> <span class="n">Trim</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
</code></pre></div>
    <p>Relaxed trimming that ignores small violations:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">trim</span> <span class="o">=</span> <span class="n">Trim</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">min_val</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">max_val</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">ignore_n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="gp">&gt;&gt;&gt; </span>    <span class="n">step</span><span class="o">=</span><span class="mf">0.03</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="gp">&gt;&gt;&gt; </span><span class="p">)</span>
</code></pre></div>
    <p>Usage in calibration:</p>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">Calibration</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">cal</span> <span class="o">=</span> <span class="n">Calibration</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="n">moments</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;base_weight&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="n">trim</span><span class="p">,</span> <span class="n">iterations_loop</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>Trimming occurs between calibration iterations in an iterative loop.</li>
<li>Bounds are relaxed on each iteration: on iteration i, the max bound becomes
max_val * (1 + i * tolerance_step) and the trim point becomes
max_val * (1 - i * step).</li>
<li>Setting ignore_n &gt; 0 prevents trimming when only a few observations exceed
bounds, which can be useful for preserving calibration accuracy.</li>
<li>Trimming creates a trade-off: tighter bounds reduce variance of weighted
estimates but may prevent exact calibration to targets.</li>
<li>The iterative trimming approach allows the algorithm to gradually find a
balance between meeting targets and respecting weight bounds.</li>
</ul>
</details>







              <details class="quote">
                <summary>Source code in <code>src\survey_kit\calibration\trim.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">Trim</span><span class="p">(</span><span class="n">Serializable</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Weight trimming parameters for iterative calibration.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    Controls how calibrated weights are trimmed (bounded) during iterative calibration</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    to prevent extreme weight values. Trimming can improve practical usability of</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    weights at the cost of some bias in meeting calibration targets exactly.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    trim : bool, optional</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        Whether to apply trimming. Default is False.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    min_val : float, optional</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        Minimum allowed weight ratio (weight/base_weight). Default is 0.05.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    max_val : float, optional</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        Maximum allowed weight ratio (weight/base_weight). Default is 5.0.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    step : float, optional</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        How much to relax trim bounds on each iteration (multiplied by iteration</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        number). Default is 0.02.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    tolerance_step : float, optional</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        How much to relax trim tolerance on each iteration. Default is 0.01.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    ignore_n : int, optional</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        Don&#39;t trim if fewer than this many observations exceed bounds. This prevents</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        trimming for a small number of outliers. Default is 0.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Examples</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    --------</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Basic trimming with standard bounds:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    &gt;&gt;&gt; from survey_kit.calibration.trim import Trim</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    &gt;&gt;&gt; trim = Trim(trim=True, min_val=0.2, max_val=4.0)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    Relaxed trimming that ignores small violations:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    &gt;&gt;&gt; trim = Trim(</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    &gt;&gt;&gt;     trim=True,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    &gt;&gt;&gt;     min_val=0.1,</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    &gt;&gt;&gt;     max_val=5.0,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    &gt;&gt;&gt;     ignore_n=5,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    &gt;&gt;&gt;     step=0.03</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    &gt;&gt;&gt; )</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    Usage in calibration:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">    &gt;&gt;&gt; from survey_kit.calibration import Calibration</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    &gt;&gt;&gt; cal = Calibration(df=df, moments=moments, weight=&quot;base_weight&quot;)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    &gt;&gt;&gt; results = cal.run(trim=trim, iterations_loop=10)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    Notes</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    -----</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    - Trimming occurs between calibration iterations in an iterative loop.</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    - Bounds are relaxed on each iteration: on iteration i, the max bound becomes</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    max_val * (1 + i * tolerance_step) and the trim point becomes</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    max_val * (1 - i * step).</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    - Setting ignore_n &gt; 0 prevents trimming when only a few observations exceed</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    bounds, which can be useful for preserving calibration accuracy.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    - Trimming creates a trade-off: tighter bounds reduce variance of weighted</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    estimates but may prevent exact calibration to targets.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    - The iterative trimming approach allows the algorithm to gradually find a</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    balance between meeting targets and respecting weight bounds.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">_save_suffix</span> <span class="o">=</span> <span class="s2">&quot;calibration_trim&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">trim</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">min_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="n">max_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="n">step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="n">tolerance_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">ignore_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="p">):</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trim</span> <span class="o">=</span> <span class="n">trim</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_val</span> <span class="o">=</span> <span class="n">min_val</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_val</span> <span class="o">=</span> <span class="n">max_val</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance_step</span> <span class="o">=</span> <span class="n">tolerance_step</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_n</span> <span class="o">=</span> <span class="n">ignore_n</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trim_in_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Calibration</span><span class="p">,</span> <span class="n">iLoop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nLoops</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="c1"># Complete unless set to false later</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">bComplete</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="c1">#   Check if the weights need trimming (not on last loop)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iLoop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nLoops</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="c1"># Check min and max weight</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">max_weight</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">min_weight</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="n">trim_limit_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_val</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">iLoop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance_step</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="n">trim_limit_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_val</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">iLoop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance_step</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="n">btrim_max</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">btrim_min</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">n_to_trim_max</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">n_to_trim_min</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="k">if</span> <span class="n">max_weight</span> <span class="o">&gt;</span> <span class="n">trim_limit_max</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                    <span class="n">n_to_trim_max</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                            <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">trim_limit_max</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                        <span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                    <span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                    <span class="n">btrim_max</span> <span class="o">=</span> <span class="n">n_to_trim_max</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_n</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">btrim_max</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                            <span class="sa">f</span><span class="s2">&quot;Max weight (</span><span class="si">{</span><span class="n">max_weight</span><span class="si">}</span><span class="s2">) is greater than trim_max(</span><span class="si">{</span><span class="n">trim_limit_max</span><span class="si">}</span><span class="s2">), but NOT TRIMMING because only </span><span class="si">{</span><span class="n">n_to_trim_max</span><span class="si">}</span><span class="s2">  need trimming against a passed limit of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_n</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                        <span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="n">btrim_max</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="k">if</span> <span class="n">min_weight</span> <span class="o">&lt;</span> <span class="n">trim_limit_min</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                    <span class="n">n_to_trim_max</span> <span class="o">=</span> <span class="n">safe_height</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                            <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">trim_limit_min</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                        <span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                    <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                    <span class="n">btrim_min</span> <span class="o">=</span> <span class="n">n_to_trim_min</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_n</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">btrim_min</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                            <span class="sa">f</span><span class="s2">&quot;Min weight (</span><span class="si">{</span><span class="n">min_weight</span><span class="si">}</span><span class="s2">) is greater than trim_max(</span><span class="si">{</span><span class="n">trim_limit_min</span><span class="si">}</span><span class="s2">), but NOT TRIMMING because only </span><span class="si">{</span><span class="n">n_to_trim_min</span><span class="si">}</span><span class="s2">  need trimming against a passed limit of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_n</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                        <span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                        <span class="n">btrim_min</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="k">if</span> <span class="n">btrim_max</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="n">bComplete</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="n">trim_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_val</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">iLoop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                    <span class="sa">f</span><span class="s2">&quot;Max weight (</span><span class="si">{</span><span class="n">max_weight</span><span class="si">}</span><span class="s2">) is greater than trim_max(</span><span class="si">{</span><span class="n">trim_limit_max</span><span class="si">}</span><span class="s2">), trimming to </span><span class="si">{</span><span class="n">trim_at</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="k">if</span> <span class="n">n_to_trim_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">n_to_trim_max</span><span class="si">}</span><span class="s2"> need trimming&quot;</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">c</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                        <span class="p">(</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                            <span class="n">nw</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">trim_at</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">trim_at</span><span class="p">))</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">))</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                        <span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                    <span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="k">if</span> <span class="n">btrim_min</span><span class="p">:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                <span class="n">bComplete</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                <span class="n">trim_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_val</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">iLoop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                    <span class="sa">f</span><span class="s2">&quot;Min weight (</span><span class="si">{</span><span class="n">min_weight</span><span class="si">}</span><span class="s2">) is greater than trim_max(</span><span class="si">{</span><span class="n">trim_limit_min</span><span class="si">}</span><span class="s2">), trimming to </span><span class="si">{</span><span class="n">trim_at</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="k">if</span> <span class="n">n_to_trim_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">n_to_trim_min</span><span class="si">}</span><span class="s2"> need trimming&quot;</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="n">c</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                    <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                        <span class="p">(</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                            <span class="n">nw</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">trim_at</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">trim_at</span><span class="p">))</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">))</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">final_weight</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                        <span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                    <span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                    <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="k">return</span> <span class="n">bComplete</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="sa">f</span><span class="s2">&quot;trim           = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trim</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;min_val        = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_val</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;min_val        = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_val</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;max_val        = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_val</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;step           = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;tolerance_step = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tolerance_step</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;ignore_n       = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_n</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../user-guide/statistics/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Statistics/Standard Errors">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Statistics/Standard Errors
              </div>
            </div>
          </a>
        
        
          
          <a href="../srmi/" class="md-footer__link md-footer__link--next" aria-label="Next: Imputation/SRMI">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Imputation/SRMI
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.annotate", "navigation.footer", "navigation.indexes", "navigation.top"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../javascript/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>