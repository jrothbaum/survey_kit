
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../calibration/">
      
      
        <link rel="next" href="../statistics/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Imputation/SRMI - Survey-Kit</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#imputationsrmi" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Survey-Kit" class="md-header__button md-logo" aria-label="Survey-Kit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Survey-Kit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Imputation/SRMI
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jrothbaum/survey_kit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Survey-Kit" class="md-nav__button md-logo" aria-label="Survey-Kit" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Survey-Kit
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jrothbaum/survey_kit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../calibration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Calibration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Imputation/SRMI
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Imputation/SRMI
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-it" class="md-nav__link">
    <span class="md-ellipsis">
      What Is It
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-use-it" class="md-nav__link">
    <span class="md-ellipsis">
      Why Use It
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Why Use It">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tested-at-scale" class="md-nav__link">
    <span class="md-ellipsis">
      Tested at Scale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use-this-vs-other-packages" class="md-nav__link">
    <span class="md-ellipsis">
      When to Use This vs. Other Packages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examplestutorials" class="md-nav__link">
    <span class="md-ellipsis">
      Examples/Tutorials
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../statistics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Statistics/Standard Errors
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/calibration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Calibration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/srmi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Imputation/SRMI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/basic_standard_errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Statistics/Standard Errors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/multiple_imputation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multiple Imputation Standard Errors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/miscellaneous/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Miscellaneous
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-it" class="md-nav__link">
    <span class="md-ellipsis">
      What Is It
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-use-it" class="md-nav__link">
    <span class="md-ellipsis">
      Why Use It
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Why Use It">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tested-at-scale" class="md-nav__link">
    <span class="md-ellipsis">
      Tested at Scale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use-this-vs-other-packages" class="md-nav__link">
    <span class="md-ellipsis">
      When to Use This vs. Other Packages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examplestutorials" class="md-nav__link">
    <span class="md-ellipsis">
      Examples/Tutorials
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="imputationsrmi">Imputation/SRMI<a class="headerlink" href="#imputationsrmi" title="Permanent link">&para;</a></h1>
<h2 id="what-is-it">What Is It<a class="headerlink" href="#what-is-it" title="Permanent link">&para;</a></h2>
<p>Suppose you have some variable (<span class="arithmatex">\(y\)</span>) that has missing observations (some people didn't respond to the survey or data was left blank in the administrative record, etc.).  You also have some set of characteristics that are observable, with no missing information (<span class="arithmatex">\(X\)</span>).  The basic idea of imputation is to estimate the distribution of <span class="arithmatex">\(y\)</span> conditional on <span class="arithmatex">\(X\)</span>, or <span class="arithmatex">\(f(y|X)\)</span> and then use that estimate to draw plausible values of <span class="arithmatex">\(y\)</span> for each missing observation so that you can get an estimate of some statistic of <span class="arithmatex">\(Q(y)\)</span> (the mean, the median, a regression coefficient that conditions on <span class="arithmatex">\(y\)</span>, ...).  The imputation model must be "congenial" to estimate a given statistic (or "proper"), which means the imputes should be drawn such that <span class="arithmatex">\(Q(\hat{y})\)</span> is unbiased and the estimates have valid confidence intervals (i.e. uncertainty is accounted for correctly - see <a href="https://stefvanbuuren.name/fimd">van Buren, 2018</a> for a much more accurate and thorough discussion).   </p>
<p>When actually doing the imputation you have several choices:</p>
<ol>
<li><strong>How will you estimate <span class="arithmatex">\(f(y|X)\)</span>?</strong> - What functional form will you use and how will you estimate the parameters?  A regression, a hot deck, machine learning?  Embedded in this is what do you include in <span class="arithmatex">\(X\)</span>.</li>
<li><strong>How will you draw values of <span class="arithmatex">\(y\)</span> given your estimate of <span class="arithmatex">\(f(y|X)\)</span>?</strong> - draw from the error distribution from your regression (<span class="arithmatex">\(\hat{e}\)</span>), use the emprirical distribution of observed values with the same/similar expected values (<span class="arithmatex">\(\hat{y}\)</span>) as in predicted mean matching or a hot deck, etc.</li>
<li><strong>How will you account for the relationship between imputed variables in your model?</strong> Suppose you have several variables with missing values, such that you want to estimate <span class="arithmatex">\(f(y_1|X, y_2)\)</span> and <span class="arithmatex">\(f(y_2|X,y_1)\)</span>, how will you account for the relationship between <span class="arithmatex">\(y_1\)</span> and <span class="arithmatex">\(y_2\)</span>?  This is what <a href="https://www150.statcan.gc.ca/n1/en/pub/12-001-x/2001001/article/5857-eng.pdf?st=TzHpqnV2">Sequential Regression Multivariate Imputation (SRMI)</a> is for.  You iteratively run the estimation, where in the first iteration <span class="arithmatex">\(^{(1)}\)</span>, you estimate <span class="arithmatex">\(f(y_1^{(1)}|X)\)</span> (ignoring the relationship between <span class="arithmatex">\(y_1\)</span> and <span class="arithmatex">\(y_2\)</span>), then impute <span class="arithmatex">\(f(y_2^{(1)}|X,y_1^{(1)})\)</span> (not ignoring the relationship between <span class="arithmatex">\(y_2\)</span> and <span class="arithmatex">\(y_1\)</span>).  Then, in the second iteration <span class="arithmatex">\(^{(2)}\)</span>, you estimate <span class="arithmatex">\(f(y_1^{(2)}|X,y_2^{(1)})\)</span>, with the imputed <span class="arithmatex">\(y_2\)</span> from the prior iteration to incorporate the relationship between the two <span class="arithmatex">\(y\)</span> variables.  You then re-impute <span class="arithmatex">\(y_2^{(2)}\)</span> with the newly imputed values for <span class="arithmatex">\(y_1^{(2)}\)</span>.  You continue with additional iterations (up to <span class="arithmatex">\(k\)</span>, for example) until you have converged to the covariate distributions of <span class="arithmatex">\(f(y_1^{(k)}|X,y_2^{(k-1)})\)</span>=<span class="arithmatex">\(f(y_1|X,y_2)\)</span> and <span class="arithmatex">\(f(y_2^{(k)}|X,y_1^{(k)})\)</span>=<span class="arithmatex">\(f(y_2|X,y_1)\)</span>.  Many imputations (such as most done at the U.S. Census Bureau) do not do this and stop after the first iteration, where <span class="arithmatex">\(f(y_1^{(1)}|X)\)</span> was estimated without conditioning on <span class="arithmatex">\(y_2\)</span> (or other variables with missing information). </li>
<li><strong>How do account for uncertainty?</strong>  You should use multiple imputation (<a href="https://onlinelibrary.wiley.com/doi/book/10.1002/9780470316696">Rubin, 1987</a>), which means that you take some number of independent draws of <span class="arithmatex">\(y\)</span> for each missing observation.  This allows you to account for uncertainty in <span class="arithmatex">\(f(y|X)\)</span>.  However, most estimation methods involve estimating <span class="arithmatex">\(f(y|X,\theta)\)</span>, where <span class="arithmatex">\(\theta\)</span> could be the regression coefficients from an OLS regression.  Since you are estimating <span class="arithmatex">\(\hat{\theta}\)</span>, the estimates have uncertainty as well, which should be incorporated into the imputation.  This package handles this through taking a <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC3703677/">Bayes Bootstrap</a> of the sample at each step of the estimation.</li>
</ol>
<h2 id="why-use-it">Why Use It<a class="headerlink" href="#why-use-it" title="Permanent link">&para;</a></h2>
<p>This package was built to handle production-scale multiple imputation for complex survey data. It provides capabilities that go beyond typical imputation packages:</p>
<ul>
<li>
<p><strong>Speed and Scale</strong> - Built on <a href="https://pola.rs">polars</a> to handle large datasets efficiently. Impute datasets with hundreds of thousands or millions of observations on a standard laptop in minutes rather than hours.  You can pass data in any form supported by <a href="https://narwhals-dev.github.io/narwhals/">Narwhals</a> and you'll get your data back in that form (Pandas, Polars, DuckDB, PyArrow, etc.).  We just use polars under the hood for speed.</p>
</li>
<li>
<p><strong>Production-Grade Reliability</strong> - Designed for long-running imputation pipelines with managed state and checkpointing. If your imputation is interrupted (power outage, server maintenance, hitting time limits,  you want to use your laptop to play a game), you can resume exactly where you left off without losing work.</p>
</li>
<li>
<p><strong>Flexible Method Mixing</strong> - Different variables need different approaches. Impute demographic variables via hot deck, income with gradient boosting, and binary indicators with PMM—all in one coherent framework with proper iteration.</p>
</li>
<li>
<p><strong>Complex Dependency Handling</strong> - Real survey data has intricate relationships. For example, you may want to:</p>
<ul>
<li>Impute an earnings flag first, then earnings source conditional on that flag (primary earnings from wage and salary, self-employment, or farm self-employment)</li>
<li>Impute by subgroups (wage earners, self-employed, farm self-employed) based on previously imputed variables</li>
<li>Impute spouse 1's income using spouse 2's, then vice versa, then recalculate household totals to use to impute other variables (like interest income, pensions, etc.)</li>
</ul>
<p>This package handles this naturally without requiring you to reshape your data or run totally separate imputation models (which would make it impossible to use SRMI properly).</p>
</li>
<li>
<p><strong>Arbitrary Pre/Post Processing</strong> - Execute custom functions at any point in the imputation sequence. Recalculate derived variables, apply business rules, update relationships—- whatever your data requires. Keep your data in its natural structure (person-level, household-level) and use the flexibility of the package make that complexity easy to manage (it's easy to write a function that updates spousal earnings and just call that when you need it).</p>
</li>
<li>
<p><strong>Modern Methods</strong> - Native support for gradient boosting (<a href="https://lightgbm.readthedocs.io/en/stable/">LightGBM</a>) with hyperparameter tuning, quantile regression for continuous variables, etc. Methods typically unavailable in other imputation packages.  </p>
</li>
</ul>
<p>Other tools can be integrated into this package, but the default is LightGBM for its speed and accuracy (some other tools include <a href="https://xgboost.readthedocs.io/en/stable/python/python_intro.html">XGBoost</a>, <a href="https://catboost.ai/docs/en/">Catboost</a>, <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">random forest</a>).</p>
<h3 id="tested-at-scale">Tested at Scale<a class="headerlink" href="#tested-at-scale" title="Permanent link">&para;</a></h3>
<p>This package integrates knowledge gained from years of research at the U.S. Census Bureau:</p>
<ul>
<li><a href="https://academic.oup.com/jssam/article-abstract/10/1/81/5943180">Income imputation in the Current Population Survey's Annual Social and Economic Supplement</a></li>
<li><a href="https://www.aeaweb.org/articles?id=10.1257/pandp.20221040">Analysis of administrative data from the Supplemental Nutrition Assistance Program</a>  </li>
<li><a href="https://www.census.gov/data/experimental-data-products/national-experimental-wellbeing-statistics.html">Development of the National Experimental Well-being Statistics Project</a></li>
</ul>
<p>It was designed to handle imputing hundreds of variables across multiple iterations (SRMI) with samples ranging from hundreds of thousands to hundreds of millions of records, with complex dependency structures between variables.</p>
<h3 id="when-to-use-this-vs-other-packages">When to Use This vs. Other Packages<a class="headerlink" href="#when-to-use-this-vs-other-packages" title="Permanent link">&para;</a></h3>
<p><strong>Use this package when you:</strong></p>
<ul>
<li>Work with large datasets (&gt;100K rows) where performance matters</li>
<li>Need production reliability with checkpoint/resume capability</li>
<li>Want to mix different imputation methods intelligently</li>
<li>Have complex variable dependencies that require custom logic</li>
<li>Need modern ML approaches (gradient boosting, quantile regression)</li>
<li>Require hot deck or statistical matching methods</li>
</ul>
<p><strong>Use mice or similar packages when you:</strong></p>
<ul>
<li>Work with smaller datasets (&lt;100K rows)</li>
<li>Want extensive built-in convergence diagnostics</li>
<li>Just want something that works and you can cite</li>
<li>Want a simpler API with simpler defaults</li>
</ul>
<p><strong>Note:</strong> This package assumes familiarity with imputation methodology. It provides powerful, flexible tools for implementing complex imputation strategies correctly at scale. If you need a point-and-click solution with extensive guardrails, traditional packages may be more appropriate.</p>
<h2 id="api">API<a class="headerlink" href="#api" title="Permanent link">&para;</a></h2>
<p>See the full <a href="../../api/srmi/">Imputation/SRMI API documentation</a> </p>
<h2 id="examplestutorials">Examples/Tutorials<a class="headerlink" href="#examplestutorials" title="Permanent link">&para;</a></h2>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Hot Deck/Statistical Match</label><label for="__tabbed_1_2">Regression</label><label for="__tabbed_1_3">Machine Learning</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Stat match uses a join and hot deck fill forward from an array across the file, but there is no real difference between them theoretically </p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Code</label><label for="__tabbed_2_2">Log</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">narwhals</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nw</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">polars.selectors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cs</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomData</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.dataframe</span><span class="w"> </span><span class="kn">import</span> <span class="n">summary</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.variable</span><span class="w"> </span><span class="kn">import</span> <span class="n">Variable</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameters</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.srmi</span><span class="w"> </span><span class="kn">import</span> <span class="n">SRMI</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.orchestration.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">config</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.dataframe</span><span class="w"> </span><span class="kn">import</span> <span class="n">summary</span><span class="p">,</span> <span class="n">columns_from_list</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="c1"># %%</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="c1"># Draw some random data</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="n">n_rows</span> <span class="o">=</span> <span class="mi">10_000</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="n">impute_share</span> <span class="o">=</span> <span class="mf">0.25</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="n">RandomData</span><span class="p">(</span><span class="n">n_rows</span><span class="o">=</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">32565437</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="mi">2016</span><span class="p">,</span> <span class="mi">2020</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;var3&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;var4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;var5&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="o">.</span><span class="n">np_distribution</span><span class="p">(</span><span class="s2">&quot;epsilon_hd1&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="o">.</span><span class="n">np_distribution</span><span class="p">(</span><span class="s2">&quot;epsilon_hd2&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;missing_hd1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;missing_hd2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="c1">#   Convenience references to them for creating dependent variables</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="n">c_var2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="n">c_var3</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var3&quot;</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="n">c_var4</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var4&quot;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="n">c_var5</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var5&quot;</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="n">c_e_hd1</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;epsilon_hd1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="n">c_e_hd2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;epsilon_hd2&quot;</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;var_hd1 is binary and conditional on other variables&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="n">c_hd1</span> <span class="o">=</span> <span class="p">((</span><span class="n">c_var2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c_var3</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">c_var5</span> <span class="o">+</span> <span class="n">c_e_hd1</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_hd1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;var_hd2 is != 0 only if var_hd1 == True&quot;</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="n">c_hd2</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>    <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_hd1&quot;</span><span class="p">))</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>      <span class="o">.</span><span class="n">then</span><span class="p">(((</span><span class="n">c_var2</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="n">c_var3</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">c_var4</span> <span class="o">+</span> <span class="n">c_e_hd2</span><span class="p">)))</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>      <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>      <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_hd2&quot;</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a><span class="c1">#   Create a bunch of variables that are functions of the variables created above</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>    <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">c_hd1</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">c_hd2</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns_from_list</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;epsilon*&quot;</span><span class="p">))</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>    <span class="o">.</span><span class="n">with_row_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_row_index_&quot;</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a><span class="n">df_original</span> <span class="o">=</span> <span class="n">df</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a><span class="c1">#   Set variables to missing according to the uniform random variables missing_</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a><span class="n">clear_missing</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a><span class="k">for</span> <span class="n">prefixi</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hd&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="n">vari</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="n">prefixi</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>        <span class="n">missingi</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;missing_</span><span class="si">{</span><span class="n">prefixi</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>        <span class="n">clear_missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">missingi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">impute_share</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">vari</span><span class="p">))</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">vari</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">clear_missing</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s2">&quot;missing_&quot;</span><span class="p">))</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a><span class="n">summary</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a><span class="c1">#   Actually do the imputation</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a><span class="c1">#       The list of variables to impute (eventually)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a><span class="n">vars_impute</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a><span class="c1">#   1) Impute some variables to impute using stat match/hot deck</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a><span class="n">modeltype</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">StatMatch</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a><span class="n">modeltype_binary</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">HotDeck</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a><span class="c1">#       Hot deck a continuous variable</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a><span class="c1">#           Each model has a set of possible parameters</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a><span class="c1">#           that determine what happens in the model</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a><span class="n">parameters_hd1</span> <span class="o">=</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">HotDeck</span><span class="p">(</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>    <span class="c1">#   model_list - a list of variables to match</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>    <span class="c1">#       donors and recipients</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>    <span class="n">model_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;var2&quot;</span><span class="p">,</span> <span class="s2">&quot;var3&quot;</span><span class="p">,</span> <span class="s2">&quot;var5&quot;</span><span class="p">],</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>    <span class="c1">#   Donate anything other than the variable</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>    <span class="c1">#       (i.e. donate together)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>    <span class="c1">#       In this case, it&#39;s redundant and does nothing...</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>    <span class="n">donate_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;var_hd1&quot;</span><span class="p">],</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a><span class="c1"># %%</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a><span class="c1"># Set up the variable to be imputed</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Impute the boolean variable (var_hd1)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   by setting the model type (a stat match)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   and the list of match variables&quot;</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a><span class="n">v_hd1</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>    <span class="n">impute_var</span><span class="o">=</span><span class="s2">&quot;var_hd1&quot;</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>    <span class="n">modeltype</span><span class="o">=</span><span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">StatMatch</span><span class="p">,</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>    <span class="n">parameters</span><span class="o">=</span><span class="n">Parameters</span><span class="o">.</span><span class="n">HotDeck</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>        <span class="n">model_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;var2&quot;</span><span class="p">,</span> <span class="s2">&quot;var3&quot;</span><span class="p">,</span> <span class="s2">&quot;var5&quot;</span><span class="p">]</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>    <span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Add the variable to the list to be imputed&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a><span class="n">vars_impute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_hd1</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Impute the continuous variable (var_hd2) &quot;</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   conditional on var_hd1, using narwhals (nw.col(&#39;var_hd1&#39;))&quot;</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   by setting the model type (a hot deck)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   and the list of match variables&quot;</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   as well as a post-processing edit to set var_hd2=0 when var_hd1==0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a><span class="n">v_hd2</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>    <span class="n">impute_var</span><span class="o">=</span><span class="s2">&quot;var_hd2&quot;</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>    <span class="n">Where</span><span class="o">=</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_hd1&quot;</span><span class="p">),</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>    <span class="n">By</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">],</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>    <span class="n">modeltype</span><span class="o">=</span><span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">HotDeck</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>    <span class="n">parameters</span><span class="o">=</span><span class="n">Parameters</span><span class="o">.</span><span class="n">HotDeck</span><span class="p">(</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>        <span class="n">model_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;var2&quot;</span><span class="p">,</span> <span class="s2">&quot;var3&quot;</span><span class="p">,</span> <span class="s2">&quot;var5&quot;</span><span class="p">]</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>    <span class="p">),</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>    <span class="n">postFunctions</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>        <span class="n">nw</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_hd1&quot;</span><span class="p">))</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>          <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_hd2&quot;</span><span class="p">))</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>          <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>          <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_hd2&quot;</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>    <span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a><span class="n">vars_impute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_hd2</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a><span class="c1"># %%</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set up the imputation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a><span class="n">srmi</span> <span class="o">=</span> <span class="n">SRMI</span><span class="p">(</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>    <span class="n">variables</span><span class="o">=</span><span class="n">vars_impute</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>    <span class="n">n_implicates</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>    <span class="n">n_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>    <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>    <span class="n">bayesian_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>    <span class="n">parallel_testing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>    <span class="n">path_model</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">path_temp_files</span><span class="si">}</span><span class="s2">/py_srmi_test_hd&quot;</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>    <span class="n">force_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a><span class="c1"># %%</span>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Run it&quot;</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a><span class="n">srmi</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a><span class="c1"># %%</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Get the results&quot;</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span> <span class="o">=</span> <span class="n">srmi</span><span class="o">.</span><span class="n">df_implicates</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a><span class="c1"># %%</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the original&quot;</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a><span class="n">_</span> <span class="o">=</span> <span class="n">summary</span><span class="p">(</span><span class="n">df_original</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the imputes&quot;</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the imputes | var_hd1 == 0&quot;</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_hd1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the imputes | var_hd1 == 1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_hd1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="../../tutorials/srmi/hotdeck.html" target="_blank">View in separate window</a>
<iframe src="../../tutorials/srmi/hotdeck.html" 
    style="width: 100%; height: 800px; border: none;">
</iframe></p>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>Logit and/or OLS-based imputation</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Code</label><label for="__tabbed_3_2">Log</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">narwhals</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nw</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">polars.selectors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cs</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomData</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.dataframe</span><span class="w"> </span><span class="kn">import</span> <span class="n">summary</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.variable</span><span class="w"> </span><span class="kn">import</span> <span class="n">Variable</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameters</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.srmi</span><span class="w"> </span><span class="kn">import</span> <span class="n">SRMI</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">Selection</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">config</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.dataframe</span><span class="w"> </span><span class="kn">import</span> <span class="n">summary</span><span class="p">,</span> <span class="n">columns_from_list</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.formula_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">FormulaBuilder</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">code_root</span><span class="p">)</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;tests&quot;</span><span class="p">))</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scratch</span><span class="w"> </span><span class="kn">import</span> <span class="n">path_scratch</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="n">config</span><span class="o">.</span><span class="n">data_root</span> <span class="o">=</span> <span class="n">path_scratch</span><span class="p">(</span><span class="n">temp_file_suffix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="c1"># %%</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="c1"># Draw some random data</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="n">n_rows</span> <span class="o">=</span> <span class="mi">10_000</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="n">impute_share</span> <span class="o">=</span> <span class="mf">0.25</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>    <span class="n">RandomData</span><span class="p">(</span><span class="n">n_rows</span><span class="o">=</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">32565437</span><span class="p">)</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>    <span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="mi">2016</span><span class="p">,</span> <span class="mi">2020</span><span class="p">)</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;var3&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;var4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;var5&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_3&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_5&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>    <span class="o">.</span><span class="n">np_distribution</span><span class="p">(</span><span class="s2">&quot;epsilon_reg1&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>    <span class="o">.</span><span class="n">np_distribution</span><span class="p">(</span><span class="s2">&quot;epsilon_reg2&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;missing_reg1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;missing_reg2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>    <span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a><span class="p">)</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a><span class="c1">#   Convenience references to them for creating dependent variables</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a><span class="n">c_var2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">)</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a><span class="n">c_var3</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var3&quot;</span><span class="p">)</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a><span class="n">c_var4</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var4&quot;</span><span class="p">)</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a><span class="n">c_var5</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var5&quot;</span><span class="p">)</span>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a><span class="n">c_e_reg1</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;epsilon_reg1&quot;</span><span class="p">)</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a><span class="n">c_e_reg2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;epsilon_reg2&quot;</span><span class="p">)</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a><span class="c1">#   Convenience references to them for creating dependent variables</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a><span class="n">c_var2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">)</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a><span class="n">c_var3</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var3&quot;</span><span class="p">)</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a><span class="n">c_var4</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var4&quot;</span><span class="p">)</span>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a><span class="n">c_var5</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var5&quot;</span><span class="p">)</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;var_reg1 is binary and conditional on other variables&quot;</span><span class="p">)</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a><span class="n">c_reg1</span> <span class="o">=</span> <span class="p">((</span><span class="n">c_var2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c_var3</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">c_var5</span> <span class="o">+</span> <span class="n">c_e_reg1</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_reg1&quot;</span><span class="p">)</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;var_reg2 is != 0 only if var_reg1 == True&quot;</span><span class="p">)</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a><span class="n">c_reg2</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>    <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_reg1&quot;</span><span class="p">))</span>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>      <span class="o">.</span><span class="n">then</span><span class="p">(((</span><span class="n">c_var2</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="n">c_var3</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">c_var4</span> <span class="o">+</span> <span class="n">c_e_reg2</span><span class="p">)))</span>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>      <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>      <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_reg2&quot;</span><span class="p">)</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a><span class="p">)</span>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a><span class="c1">#   Create a bunch of variables that are functions of the variables created above</span>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>    <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">c_reg1</span><span class="p">)</span>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">c_reg2</span><span class="p">)</span>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns_from_list</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;epsilon*&quot;</span><span class="p">))</span>
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>    <span class="o">.</span><span class="n">with_row_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_row_index_&quot;</span><span class="p">)</span>
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a><span class="p">)</span>
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a><span class="n">df_original</span> <span class="o">=</span> <span class="n">df</span>
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a><span class="c1">#   Set variables to missing according to the uniform random variables missing_</span>
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a><span class="n">clear_missing</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a><span class="k">for</span> <span class="n">prefixi</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;reg&quot;</span><span class="p">]:</span>
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>        <span class="n">vari</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="n">prefixi</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>        <span class="n">missingi</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;missing_</span><span class="si">{</span><span class="n">prefixi</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>        <span class="n">clear_missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">missingi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">impute_share</span><span class="p">)</span>
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a>            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">vari</span><span class="p">))</span>
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">vari</span><span class="p">)</span>
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a>        <span class="p">)</span>
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">clear_missing</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s2">&quot;missing_&quot;</span><span class="p">))</span>
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a><span class="c1">#   Make a fully collinear var for testing</span>
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;unrelated_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;repeat_1&quot;</span><span class="p">))</span>
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>
<a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a><span class="n">summary</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a>
<a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a>
<a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a><span class="c1">#   Actually do the imputation</span>
<a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a>
<a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>
<a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a><span class="c1"># %%</span>
<a id="__codelineno-1-122" name="__codelineno-1-122" href="#__codelineno-1-122"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Define the regression model (intentionally include some extraneous variables&quot;</span><span class="p">)</span>
<a id="__codelineno-1-123" name="__codelineno-1-123" href="#__codelineno-1-123"></a>
<a id="__codelineno-1-124" name="__codelineno-1-124" href="#__codelineno-1-124"></a><span class="n">f_model</span> <span class="o">=</span> <span class="n">FormulaBuilder</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-1-125" name="__codelineno-1-125" href="#__codelineno-1-125"></a><span class="n">f_model</span><span class="o">.</span><span class="n">formula_with_varnames_in_brackets</span><span class="p">(</span>
<a id="__codelineno-1-126" name="__codelineno-1-126" href="#__codelineno-1-126"></a>    <span class="s2">&quot;~1+{var_*}+var2+var4+var4*var3*C(var5)+{unrelated_*}+{repeat_*}&quot;</span>
<a id="__codelineno-1-127" name="__codelineno-1-127" href="#__codelineno-1-127"></a><span class="p">)</span>
<a id="__codelineno-1-128" name="__codelineno-1-128" href="#__codelineno-1-128"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f_model</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
<a id="__codelineno-1-129" name="__codelineno-1-129" href="#__codelineno-1-129"></a>
<a id="__codelineno-1-130" name="__codelineno-1-130" href="#__codelineno-1-130"></a>
<a id="__codelineno-1-131" name="__codelineno-1-131" href="#__codelineno-1-131"></a><span class="c1"># %%</span>
<a id="__codelineno-1-132" name="__codelineno-1-132" href="#__codelineno-1-132"></a><span class="c1"># Set up the variable to be imputed</span>
<a id="__codelineno-1-133" name="__codelineno-1-133" href="#__codelineno-1-133"></a><span class="n">vars_impute</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-134" name="__codelineno-1-134" href="#__codelineno-1-134"></a>
<a id="__codelineno-1-135" name="__codelineno-1-135" href="#__codelineno-1-135"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Impute the boolean variable (var_reg1)&quot;</span><span class="p">)</span>
<a id="__codelineno-1-136" name="__codelineno-1-136" href="#__codelineno-1-136"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   to the default setup for predicted mean matching&quot;</span><span class="p">)</span>
<a id="__codelineno-1-137" name="__codelineno-1-137" href="#__codelineno-1-137"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   using logit regression&quot;</span><span class="p">)</span>
<a id="__codelineno-1-138" name="__codelineno-1-138" href="#__codelineno-1-138"></a><span class="n">v_reg1</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
<a id="__codelineno-1-139" name="__codelineno-1-139" href="#__codelineno-1-139"></a>    <span class="n">impute_var</span><span class="o">=</span><span class="s2">&quot;var_reg1&quot;</span><span class="p">,</span>
<a id="__codelineno-1-140" name="__codelineno-1-140" href="#__codelineno-1-140"></a>    <span class="n">modeltype</span><span class="o">=</span><span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">pmm</span><span class="p">,</span>
<a id="__codelineno-1-141" name="__codelineno-1-141" href="#__codelineno-1-141"></a>    <span class="n">model</span><span class="o">=</span><span class="n">f_model</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
<a id="__codelineno-1-142" name="__codelineno-1-142" href="#__codelineno-1-142"></a>    <span class="n">parameters</span><span class="o">=</span><span class="n">Parameters</span><span class="o">.</span><span class="n">Regression</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">Parameters</span><span class="o">.</span><span class="n">RegressionModel</span><span class="o">.</span><span class="n">Logit</span><span class="p">)</span>
<a id="__codelineno-1-143" name="__codelineno-1-143" href="#__codelineno-1-143"></a><span class="p">)</span>
<a id="__codelineno-1-144" name="__codelineno-1-144" href="#__codelineno-1-144"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Add the variable to the list to be imputed&quot;</span><span class="p">)</span>
<a id="__codelineno-1-145" name="__codelineno-1-145" href="#__codelineno-1-145"></a><span class="n">vars_impute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_reg1</span><span class="p">)</span>
<a id="__codelineno-1-146" name="__codelineno-1-146" href="#__codelineno-1-146"></a>
<a id="__codelineno-1-147" name="__codelineno-1-147" href="#__codelineno-1-147"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Impute the continuous variable (var_reg2) &quot;</span><span class="p">)</span>
<a id="__codelineno-1-148" name="__codelineno-1-148" href="#__codelineno-1-148"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   conditional on var_reg1, using narwhals (nw.col(&#39;var_reg1&#39;))&quot;</span><span class="p">)</span>
<a id="__codelineno-1-149" name="__codelineno-1-149" href="#__codelineno-1-149"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   by setting the model type&quot;</span><span class="p">)</span>
<a id="__codelineno-1-150" name="__codelineno-1-150" href="#__codelineno-1-150"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   and the formula&quot;</span><span class="p">)</span>
<a id="__codelineno-1-151" name="__codelineno-1-151" href="#__codelineno-1-151"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   as well as a post-processing edit to set var_reg2=0 when var_reg1==0&quot;</span><span class="p">)</span>
<a id="__codelineno-1-152" name="__codelineno-1-152" href="#__codelineno-1-152"></a><span class="n">v_reg2</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
<a id="__codelineno-1-153" name="__codelineno-1-153" href="#__codelineno-1-153"></a>    <span class="n">impute_var</span><span class="o">=</span><span class="s2">&quot;var_reg2&quot;</span><span class="p">,</span>
<a id="__codelineno-1-154" name="__codelineno-1-154" href="#__codelineno-1-154"></a>    <span class="n">Where</span><span class="o">=</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_reg1&quot;</span><span class="p">),</span>
<a id="__codelineno-1-155" name="__codelineno-1-155" href="#__codelineno-1-155"></a>    <span class="n">modeltype</span><span class="o">=</span><span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">pmm</span><span class="p">,</span>
<a id="__codelineno-1-156" name="__codelineno-1-156" href="#__codelineno-1-156"></a>    <span class="n">model</span><span class="o">=</span><span class="n">f_model</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
<a id="__codelineno-1-157" name="__codelineno-1-157" href="#__codelineno-1-157"></a>    <span class="c1">#   Default parameters</span>
<a id="__codelineno-1-158" name="__codelineno-1-158" href="#__codelineno-1-158"></a>    <span class="n">parameters</span><span class="o">=</span><span class="n">Parameters</span><span class="o">.</span><span class="n">Regression</span><span class="p">(),</span>
<a id="__codelineno-1-159" name="__codelineno-1-159" href="#__codelineno-1-159"></a>    <span class="n">postFunctions</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-1-160" name="__codelineno-1-160" href="#__codelineno-1-160"></a>        <span class="n">nw</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_reg1&quot;</span><span class="p">))</span>
<a id="__codelineno-1-161" name="__codelineno-1-161" href="#__codelineno-1-161"></a>          <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_reg2&quot;</span><span class="p">))</span>
<a id="__codelineno-1-162" name="__codelineno-1-162" href="#__codelineno-1-162"></a>          <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-1-163" name="__codelineno-1-163" href="#__codelineno-1-163"></a>          <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_reg2&quot;</span><span class="p">)</span>
<a id="__codelineno-1-164" name="__codelineno-1-164" href="#__codelineno-1-164"></a>    <span class="p">)</span>
<a id="__codelineno-1-165" name="__codelineno-1-165" href="#__codelineno-1-165"></a><span class="p">)</span>
<a id="__codelineno-1-166" name="__codelineno-1-166" href="#__codelineno-1-166"></a>
<a id="__codelineno-1-167" name="__codelineno-1-167" href="#__codelineno-1-167"></a><span class="n">vars_impute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_reg2</span><span class="p">)</span>
<a id="__codelineno-1-168" name="__codelineno-1-168" href="#__codelineno-1-168"></a>
<a id="__codelineno-1-169" name="__codelineno-1-169" href="#__codelineno-1-169"></a>
<a id="__codelineno-1-170" name="__codelineno-1-170" href="#__codelineno-1-170"></a><span class="c1"># %%</span>
<a id="__codelineno-1-171" name="__codelineno-1-171" href="#__codelineno-1-171"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set up the imputation&quot;</span><span class="p">)</span>
<a id="__codelineno-1-172" name="__codelineno-1-172" href="#__codelineno-1-172"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Add LASSO selection before each imputation&quot;</span><span class="p">)</span>
<a id="__codelineno-1-173" name="__codelineno-1-173" href="#__codelineno-1-173"></a><span class="n">srmi</span> <span class="o">=</span> <span class="n">SRMI</span><span class="p">(</span>
<a id="__codelineno-1-174" name="__codelineno-1-174" href="#__codelineno-1-174"></a>    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
<a id="__codelineno-1-175" name="__codelineno-1-175" href="#__codelineno-1-175"></a>    <span class="n">variables</span><span class="o">=</span><span class="n">vars_impute</span><span class="p">,</span>
<a id="__codelineno-1-176" name="__codelineno-1-176" href="#__codelineno-1-176"></a>    <span class="n">n_implicates</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-1-177" name="__codelineno-1-177" href="#__codelineno-1-177"></a>    <span class="n">n_iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-1-178" name="__codelineno-1-178" href="#__codelineno-1-178"></a>    <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-1-179" name="__codelineno-1-179" href="#__codelineno-1-179"></a>    <span class="n">selection</span><span class="o">=</span><span class="n">Selection</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">Selection</span><span class="o">.</span><span class="n">Method</span><span class="o">.</span><span class="n">LASSO</span><span class="p">),</span>
<a id="__codelineno-1-180" name="__codelineno-1-180" href="#__codelineno-1-180"></a>    <span class="n">modeltype</span><span class="o">=</span><span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">pmm</span><span class="p">,</span>
<a id="__codelineno-1-181" name="__codelineno-1-181" href="#__codelineno-1-181"></a>    <span class="n">model</span><span class="o">=</span><span class="n">f_model</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
<a id="__codelineno-1-182" name="__codelineno-1-182" href="#__codelineno-1-182"></a>    <span class="n">bayesian_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-1-183" name="__codelineno-1-183" href="#__codelineno-1-183"></a>    <span class="n">path_model</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">path_temp_files</span><span class="si">}</span><span class="s2">/py_srmi_test_regression&quot;</span><span class="p">,</span>
<a id="__codelineno-1-184" name="__codelineno-1-184" href="#__codelineno-1-184"></a>    <span class="n">force_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-1-185" name="__codelineno-1-185" href="#__codelineno-1-185"></a><span class="p">)</span>
<a id="__codelineno-1-186" name="__codelineno-1-186" href="#__codelineno-1-186"></a>
<a id="__codelineno-1-187" name="__codelineno-1-187" href="#__codelineno-1-187"></a><span class="c1"># %%</span>
<a id="__codelineno-1-188" name="__codelineno-1-188" href="#__codelineno-1-188"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Run it&quot;</span><span class="p">)</span>
<a id="__codelineno-1-189" name="__codelineno-1-189" href="#__codelineno-1-189"></a><span class="n">srmi</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-1-190" name="__codelineno-1-190" href="#__codelineno-1-190"></a>
<a id="__codelineno-1-191" name="__codelineno-1-191" href="#__codelineno-1-191"></a>
<a id="__codelineno-1-192" name="__codelineno-1-192" href="#__codelineno-1-192"></a><span class="c1"># %%</span>
<a id="__codelineno-1-193" name="__codelineno-1-193" href="#__codelineno-1-193"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Get the results&quot;</span><span class="p">)</span>
<a id="__codelineno-1-194" name="__codelineno-1-194" href="#__codelineno-1-194"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span> <span class="o">=</span> <span class="n">srmi</span><span class="o">.</span><span class="n">df_implicates</span>
<a id="__codelineno-1-195" name="__codelineno-1-195" href="#__codelineno-1-195"></a>
<a id="__codelineno-1-196" name="__codelineno-1-196" href="#__codelineno-1-196"></a><span class="c1"># %%</span>
<a id="__codelineno-1-197" name="__codelineno-1-197" href="#__codelineno-1-197"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the original&quot;</span><span class="p">)</span>
<a id="__codelineno-1-198" name="__codelineno-1-198" href="#__codelineno-1-198"></a><span class="n">_</span> <span class="o">=</span> <span class="n">summary</span><span class="p">(</span><span class="n">df_original</span><span class="p">)</span>
<a id="__codelineno-1-199" name="__codelineno-1-199" href="#__codelineno-1-199"></a>
<a id="__codelineno-1-200" name="__codelineno-1-200" href="#__codelineno-1-200"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the imputes&quot;</span><span class="p">)</span>
<a id="__codelineno-1-201" name="__codelineno-1-201" href="#__codelineno-1-201"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
<a id="__codelineno-1-202" name="__codelineno-1-202" href="#__codelineno-1-202"></a>
<a id="__codelineno-1-203" name="__codelineno-1-203" href="#__codelineno-1-203"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the imputes | var_reg1 == 0&quot;</span><span class="p">)</span>
<a id="__codelineno-1-204" name="__codelineno-1-204" href="#__codelineno-1-204"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_reg1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
<a id="__codelineno-1-205" name="__codelineno-1-205" href="#__codelineno-1-205"></a>
<a id="__codelineno-1-206" name="__codelineno-1-206" href="#__codelineno-1-206"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the imputes | var_reg1 == 1&quot;</span><span class="p">)</span>
<a id="__codelineno-1-207" name="__codelineno-1-207" href="#__codelineno-1-207"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_reg1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="../../tutorials/srmi/regression.html" target="_blank">View in separate window</a>
<iframe src="../../tutorials/srmi/regression.html" 
    style="width: 100%; height: 800px; border: none;">
</iframe></p>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>Imputation with LightGBM, see the <a href="https://lightgbm.readthedocs.io/en/stable/">LightGBM documentation</a> for additional information on some of the options.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Code</label><label for="__tabbed_4_2">Log</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">narwhals</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nw</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">polars.selectors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cs</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomData</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.dataframe</span><span class="w"> </span><span class="kn">import</span> <span class="n">summary</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.variable</span><span class="w"> </span><span class="kn">import</span> <span class="n">Variable</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameters</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.srmi</span><span class="w"> </span><span class="kn">import</span> <span class="n">SRMI</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">Selection</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">survey_kit.imputation.utilities.lightgbm_wrapper</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rep_lgbm</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.imputation.utilities.lightgbm_wrapper</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuner_optuna</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">config</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">survey_kit.utilities.dataframe</span><span class="w"> </span><span class="kn">import</span> <span class="n">summary</span><span class="p">,</span> <span class="n">columns_from_list</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="c1"># %%</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="c1"># Draw some random data</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="n">n_rows</span> <span class="o">=</span> <span class="mi">10_000</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="n">impute_share</span> <span class="o">=</span> <span class="mf">0.25</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>    <span class="n">RandomData</span><span class="p">(</span><span class="n">n_rows</span><span class="o">=</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">32565437</span><span class="p">)</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>    <span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="mi">2016</span><span class="p">,</span> <span class="mi">2020</span><span class="p">)</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;var3&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;var4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>    <span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s2">&quot;var5&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_3&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;unrelated_5&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>    <span class="o">.</span><span class="n">np_distribution</span><span class="p">(</span><span class="s2">&quot;epsilon_gbm1&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>    <span class="o">.</span><span class="n">np_distribution</span><span class="p">(</span><span class="s2">&quot;epsilon_gbm2&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>    <span class="o">.</span><span class="n">np_distribution</span><span class="p">(</span><span class="s2">&quot;epsilon_gbm3&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;missing_gbm1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;missing_gbm2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>    <span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s2">&quot;missing_gbm3&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>    <span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a><span class="p">)</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a><span class="c1">#   Convenience references to them for creating dependent variables</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a><span class="n">c_var2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">)</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a><span class="n">c_var3</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var3&quot;</span><span class="p">)</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a><span class="n">c_var4</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var4&quot;</span><span class="p">)</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a><span class="n">c_var5</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var5&quot;</span><span class="p">)</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a><span class="n">c_e_gbm1</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;epsilon_gbm1&quot;</span><span class="p">)</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a><span class="n">c_e_gbm2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;epsilon_gbm2&quot;</span><span class="p">)</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a><span class="c1">#   Convenience references to them for creating dependent variables</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a><span class="n">c_var2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var2&quot;</span><span class="p">)</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a><span class="n">c_var3</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var3&quot;</span><span class="p">)</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a><span class="n">c_var4</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var4&quot;</span><span class="p">)</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a><span class="n">c_var5</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var5&quot;</span><span class="p">)</span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;var_gbm1 is binary and conditional on other variables&quot;</span><span class="p">)</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a><span class="n">c_gbm1</span> <span class="o">=</span> <span class="p">((</span><span class="n">c_var2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">c_var3</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">c_var5</span> <span class="o">+</span> <span class="n">c_e_gbm1</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">)</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;var_gbm2 is != 0 only if var_gbm1 == True&quot;</span><span class="p">)</span>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a><span class="n">c_gbm2</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a>    <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">))</span>
<a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a>      <span class="o">.</span><span class="n">then</span><span class="p">(((</span><span class="n">c_var2</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="n">c_var3</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">c_var4</span> <span class="o">+</span> <span class="n">c_e_gbm2</span><span class="p">)))</span>
<a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a>      <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a>      <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_gbm2&quot;</span><span class="p">)</span>
<a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a><span class="p">)</span>
<a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a>
<a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a><span class="n">c_gbm3</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a>    <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">))</span>
<a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a>      <span class="o">.</span><span class="n">then</span><span class="p">(((</span><span class="n">c_var2</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="n">c_var3</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">c_var4</span> <span class="o">+</span> <span class="n">c_e_gbm2</span><span class="p">)))</span>
<a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a>      <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a>      <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_gbm3&quot;</span><span class="p">)</span>
<a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a><span class="p">)</span>
<a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a><span class="c1">#   Create a bunch of variables that are functions of the variables created above</span>
<a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a>    <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">c_gbm1</span><span class="p">)</span>
<a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a>    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">c_gbm2</span><span class="p">,</span> <span class="n">c_gbm3</span><span class="p">)</span>
<a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a>    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns_from_list</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;epsilon*&quot;</span><span class="p">))</span>
<a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a>    <span class="o">.</span><span class="n">with_row_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_row_index_&quot;</span><span class="p">)</span>
<a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a><span class="p">)</span>
<a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a><span class="n">df_original</span> <span class="o">=</span> <span class="n">df</span>
<a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a>
<a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a><span class="c1">#   Set variables to missing according to the uniform random variables missing_</span>
<a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a><span class="n">clear_missing</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a><span class="k">for</span> <span class="n">prefixi</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;gbm&quot;</span><span class="p">]:</span>
<a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
<a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a>        <span class="n">vari</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="n">prefixi</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>        <span class="n">missingi</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;missing_</span><span class="si">{</span><span class="n">prefixi</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a>
<a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>        <span class="n">clear_missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a>            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">missingi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">impute_share</span><span class="p">)</span>
<a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a>            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">vari</span><span class="p">))</span>
<a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">vari</span><span class="p">)</span>
<a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>        <span class="p">)</span>
<a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">clear_missing</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s2">&quot;missing_&quot;</span><span class="p">))</span>
<a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>
<a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a><span class="c1">#   Make a fully collinear var for testing</span>
<a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;unrelated_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;repeat_1&quot;</span><span class="p">))</span>
<a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a>
<a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a>
<a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a><span class="n">summary</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a>
<a id="__codelineno-2-118" name="__codelineno-2-118" href="#__codelineno-2-118"></a>
<a id="__codelineno-2-119" name="__codelineno-2-119" href="#__codelineno-2-119"></a><span class="c1"># %%</span>
<a id="__codelineno-2-120" name="__codelineno-2-120" href="#__codelineno-2-120"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Define some dummy functions to run after imputation of 2&quot;</span><span class="p">)</span>
<a id="__codelineno-2-121" name="__codelineno-2-121" href="#__codelineno-2-121"></a><span class="c1">#   Test a simple pre-post function</span>
<a id="__codelineno-2-122" name="__codelineno-2-122" href="#__codelineno-2-122"></a><span class="c1">#       These would get run gets run in each iteration (in each implicate)</span>
<a id="__codelineno-2-123" name="__codelineno-2-123" href="#__codelineno-2-123"></a><span class="c1">#           before (preFunctions) or after (postFunctions) this variable is imputed</span>
<a id="__codelineno-2-124" name="__codelineno-2-124" href="#__codelineno-2-124"></a><span class="c1">#   Notes for these functions:</span>
<a id="__codelineno-2-125" name="__codelineno-2-125" href="#__codelineno-2-125"></a><span class="c1">#       1) No type hints on imported package types (will throw an error)</span>
<a id="__codelineno-2-126" name="__codelineno-2-126" href="#__codelineno-2-126"></a><span class="c1">#           i.e. no df:pl.DataFrame or -&gt; pl.DataFrame</span>
<a id="__codelineno-2-127" name="__codelineno-2-127" href="#__codelineno-2-127"></a><span class="c1">#       2) Must be completely self-contained (i.e. all imports within the function)</span>
<a id="__codelineno-2-128" name="__codelineno-2-128" href="#__codelineno-2-128"></a><span class="c1">#           This has to do with how it gets saved and loaded in async calls</span>
<a id="__codelineno-2-129" name="__codelineno-2-129" href="#__codelineno-2-129"></a><span class="c1">#       3) Effectively, you have to assume it&#39;ll be called</span>
<a id="__codelineno-2-130" name="__codelineno-2-130" href="#__codelineno-2-130"></a><span class="c1">#           in an environment with no imports before it</span>
<a id="__codelineno-2-131" name="__codelineno-2-131" href="#__codelineno-2-131"></a><span class="k">def</span><span class="w"> </span><span class="nf">square_var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var_to_square</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-2-132" name="__codelineno-2-132" href="#__codelineno-2-132"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">narwhals</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nw</span>
<a id="__codelineno-2-133" name="__codelineno-2-133" href="#__codelineno-2-133"></a>
<a id="__codelineno-2-134" name="__codelineno-2-134" href="#__codelineno-2-134"></a>    <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-2-135" name="__codelineno-2-135" href="#__codelineno-2-135"></a>        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-2-136" name="__codelineno-2-136" href="#__codelineno-2-136"></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">var_to_square</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<a id="__codelineno-2-137" name="__codelineno-2-137" href="#__codelineno-2-137"></a>        <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-2-138" name="__codelineno-2-138" href="#__codelineno-2-138"></a>    <span class="p">)</span>
<a id="__codelineno-2-139" name="__codelineno-2-139" href="#__codelineno-2-139"></a>
<a id="__codelineno-2-140" name="__codelineno-2-140" href="#__codelineno-2-140"></a>
<a id="__codelineno-2-141" name="__codelineno-2-141" href="#__codelineno-2-141"></a><span class="k">def</span><span class="w"> </span><span class="nf">recalculate_interaction</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-2-142" name="__codelineno-2-142" href="#__codelineno-2-142"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">narwhals</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nw</span>
<a id="__codelineno-2-143" name="__codelineno-2-143" href="#__codelineno-2-143"></a>
<a id="__codelineno-2-144" name="__codelineno-2-144" href="#__codelineno-2-144"></a>    <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-2-145" name="__codelineno-2-145" href="#__codelineno-2-145"></a>        <span class="n">nw</span><span class="o">.</span><span class="n">from_native</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-2-146" name="__codelineno-2-146" href="#__codelineno-2-146"></a>        <span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">var2</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<a id="__codelineno-2-147" name="__codelineno-2-147" href="#__codelineno-2-147"></a>        <span class="o">.</span><span class="n">to_native</span><span class="p">()</span>
<a id="__codelineno-2-148" name="__codelineno-2-148" href="#__codelineno-2-148"></a>    <span class="p">)</span>
<a id="__codelineno-2-149" name="__codelineno-2-149" href="#__codelineno-2-149"></a>
<a id="__codelineno-2-150" name="__codelineno-2-150" href="#__codelineno-2-150"></a>
<a id="__codelineno-2-151" name="__codelineno-2-151" href="#__codelineno-2-151"></a><span class="c1"># %%</span>
<a id="__codelineno-2-152" name="__codelineno-2-152" href="#__codelineno-2-152"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set up hyperparameter tuning&quot;</span><span class="p">)</span>
<a id="__codelineno-2-153" name="__codelineno-2-153" href="#__codelineno-2-153"></a><span class="n">tuner</span> <span class="o">=</span> <span class="n">Tuner_optuna</span><span class="p">(</span>
<a id="__codelineno-2-154" name="__codelineno-2-154" href="#__codelineno-2-154"></a>    <span class="n">n_trials</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="n">rep_lgbm</span><span class="o">.</span><span class="n">Tuner</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">mae</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.25</span>
<a id="__codelineno-2-155" name="__codelineno-2-155" href="#__codelineno-2-155"></a><span class="p">)</span>
<a id="__codelineno-2-156" name="__codelineno-2-156" href="#__codelineno-2-156"></a>
<a id="__codelineno-2-157" name="__codelineno-2-157" href="#__codelineno-2-157"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   Set the tuner parameters to the defaults&quot;</span><span class="p">)</span>
<a id="__codelineno-2-158" name="__codelineno-2-158" href="#__codelineno-2-158"></a><span class="n">tuner</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
<a id="__codelineno-2-159" name="__codelineno-2-159" href="#__codelineno-2-159"></a>
<a id="__codelineno-2-160" name="__codelineno-2-160" href="#__codelineno-2-160"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   Then specify ranges to check between as follow&quot;</span><span class="p">)</span>
<a id="__codelineno-2-161" name="__codelineno-2-161" href="#__codelineno-2-161"></a><span class="n">tuner</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;num_leaves&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">256</span><span class="p">]</span>
<a id="__codelineno-2-162" name="__codelineno-2-162" href="#__codelineno-2-162"></a><span class="n">tuner</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;max_depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">256</span><span class="p">]</span>
<a id="__codelineno-2-163" name="__codelineno-2-163" href="#__codelineno-2-163"></a><span class="n">tuner</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;min_data_in_leaf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">250</span><span class="p">]</span>
<a id="__codelineno-2-164" name="__codelineno-2-164" href="#__codelineno-2-164"></a><span class="n">tuner</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;num_iterations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<a id="__codelineno-2-165" name="__codelineno-2-165" href="#__codelineno-2-165"></a><span class="n">tuner</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;bagging_fraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-2-166" name="__codelineno-2-166" href="#__codelineno-2-166"></a><span class="n">tuner</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">[</span><span class="s2">&quot;bagging_freq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<a id="__codelineno-2-167" name="__codelineno-2-167" href="#__codelineno-2-167"></a>
<a id="__codelineno-2-168" name="__codelineno-2-168" href="#__codelineno-2-168"></a>
<a id="__codelineno-2-169" name="__codelineno-2-169" href="#__codelineno-2-169"></a>
<a id="__codelineno-2-170" name="__codelineno-2-170" href="#__codelineno-2-170"></a>
<a id="__codelineno-2-171" name="__codelineno-2-171" href="#__codelineno-2-171"></a><span class="n">vars_impute</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-172" name="__codelineno-2-172" href="#__codelineno-2-172"></a>
<a id="__codelineno-2-173" name="__codelineno-2-173" href="#__codelineno-2-173"></a><span class="c1"># %%</span>
<a id="__codelineno-2-174" name="__codelineno-2-174" href="#__codelineno-2-174"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Impute the boolean variable (var_gbm1)&quot;</span><span class="p">)</span>
<a id="__codelineno-2-175" name="__codelineno-2-175" href="#__codelineno-2-175"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   to the default setup for predicted mean matching&quot;</span><span class="p">)</span>
<a id="__codelineno-2-176" name="__codelineno-2-176" href="#__codelineno-2-176"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   using lightgbm&quot;</span><span class="p">)</span>
<a id="__codelineno-2-177" name="__codelineno-2-177" href="#__codelineno-2-177"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   (you can pass a formula, but you don&#39;t need to)&quot;</span><span class="p">)</span>
<a id="__codelineno-2-178" name="__codelineno-2-178" href="#__codelineno-2-178"></a>
<a id="__codelineno-2-179" name="__codelineno-2-179" href="#__codelineno-2-179"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;First, set up the lightgbm parameters&quot;</span><span class="p">)</span>
<a id="__codelineno-2-180" name="__codelineno-2-180" href="#__codelineno-2-180"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   This says, do hyperparameter tuning first (tune)&quot;</span><span class="p">)</span>
<a id="__codelineno-2-181" name="__codelineno-2-181" href="#__codelineno-2-181"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   Redo it at each run (tune_overwrite)&quot;</span><span class="p">)</span>
<a id="__codelineno-2-182" name="__codelineno-2-182" href="#__codelineno-2-182"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   And sets the lightgbm parameter defaults (parameters) that the tuning can overwrite&quot;</span><span class="p">)</span>
<a id="__codelineno-2-183" name="__codelineno-2-183" href="#__codelineno-2-183"></a><span class="n">parameters_lgbm1</span> <span class="o">=</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">LightGBM</span><span class="p">(</span>
<a id="__codelineno-2-184" name="__codelineno-2-184" href="#__codelineno-2-184"></a>    <span class="n">tune</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-185" name="__codelineno-2-185" href="#__codelineno-2-185"></a>    <span class="n">tune_hyperparameter_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">data_root</span><span class="si">}</span><span class="s2">/tuner_outputs&quot;</span><span class="p">,</span>
<a id="__codelineno-2-186" name="__codelineno-2-186" href="#__codelineno-2-186"></a>    <span class="n">tuner</span><span class="o">=</span><span class="n">tuner</span><span class="p">,</span>
<a id="__codelineno-2-187" name="__codelineno-2-187" href="#__codelineno-2-187"></a>    <span class="n">tune_overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-188" name="__codelineno-2-188" href="#__codelineno-2-188"></a>    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-2-189" name="__codelineno-2-189" href="#__codelineno-2-189"></a>        <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span>
<a id="__codelineno-2-190" name="__codelineno-2-190" href="#__codelineno-2-190"></a>        <span class="s2">&quot;num_leaves&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-2-191" name="__codelineno-2-191" href="#__codelineno-2-191"></a>        <span class="s2">&quot;min_data_in_leaf&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-2-192" name="__codelineno-2-192" href="#__codelineno-2-192"></a>        <span class="s2">&quot;num_iterations&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-2-193" name="__codelineno-2-193" href="#__codelineno-2-193"></a>        <span class="s2">&quot;test_size&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-2-194" name="__codelineno-2-194" href="#__codelineno-2-194"></a>        <span class="s2">&quot;boosting&quot;</span><span class="p">:</span> <span class="s2">&quot;gbdt&quot;</span><span class="p">,</span>
<a id="__codelineno-2-195" name="__codelineno-2-195" href="#__codelineno-2-195"></a>        <span class="s2">&quot;categorical_feature&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;var5&quot;</span><span class="p">],</span>
<a id="__codelineno-2-196" name="__codelineno-2-196" href="#__codelineno-2-196"></a>        <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># ,</span>
<a id="__codelineno-2-197" name="__codelineno-2-197" href="#__codelineno-2-197"></a>    <span class="p">},</span>
<a id="__codelineno-2-198" name="__codelineno-2-198" href="#__codelineno-2-198"></a>    <span class="n">error</span><span class="o">=</span><span class="n">Parameters</span><span class="o">.</span><span class="n">ErrorDraw</span><span class="o">.</span><span class="n">pmm</span><span class="p">,</span>
<a id="__codelineno-2-199" name="__codelineno-2-199" href="#__codelineno-2-199"></a><span class="p">)</span>
<a id="__codelineno-2-200" name="__codelineno-2-200" href="#__codelineno-2-200"></a>
<a id="__codelineno-2-201" name="__codelineno-2-201" href="#__codelineno-2-201"></a>
<a id="__codelineno-2-202" name="__codelineno-2-202" href="#__codelineno-2-202"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actually define the variable and the model&quot;</span><span class="p">)</span>
<a id="__codelineno-2-203" name="__codelineno-2-203" href="#__codelineno-2-203"></a><span class="n">v_gbm1</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
<a id="__codelineno-2-204" name="__codelineno-2-204" href="#__codelineno-2-204"></a>    <span class="n">impute_var</span><span class="o">=</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">,</span>
<a id="__codelineno-2-205" name="__codelineno-2-205" href="#__codelineno-2-205"></a>    <span class="n">model</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;var_*&quot;</span><span class="p">,</span> <span class="s2">&quot;var4&quot;</span><span class="p">,</span> <span class="s2">&quot;var3&quot;</span><span class="p">,</span> <span class="s2">&quot;var5&quot;</span><span class="p">,</span> <span class="s2">&quot;unrelated_*&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat_*&quot;</span><span class="p">],</span>
<a id="__codelineno-2-206" name="__codelineno-2-206" href="#__codelineno-2-206"></a>    <span class="n">modeltype</span><span class="o">=</span><span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">LightGBM</span><span class="p">,</span>
<a id="__codelineno-2-207" name="__codelineno-2-207" href="#__codelineno-2-207"></a>    <span class="n">parameters</span><span class="o">=</span><span class="n">parameters_lgbm1</span>
<a id="__codelineno-2-208" name="__codelineno-2-208" href="#__codelineno-2-208"></a><span class="p">)</span>
<a id="__codelineno-2-209" name="__codelineno-2-209" href="#__codelineno-2-209"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Add the variable to the list to be imputed&quot;</span><span class="p">)</span>
<a id="__codelineno-2-210" name="__codelineno-2-210" href="#__codelineno-2-210"></a><span class="n">vars_impute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_gbm1</span><span class="p">)</span>
<a id="__codelineno-2-211" name="__codelineno-2-211" href="#__codelineno-2-211"></a>
<a id="__codelineno-2-212" name="__codelineno-2-212" href="#__codelineno-2-212"></a>
<a id="__codelineno-2-213" name="__codelineno-2-213" href="#__codelineno-2-213"></a>
<a id="__codelineno-2-214" name="__codelineno-2-214" href="#__codelineno-2-214"></a>
<a id="__codelineno-2-215" name="__codelineno-2-215" href="#__codelineno-2-215"></a>
<a id="__codelineno-2-216" name="__codelineno-2-216" href="#__codelineno-2-216"></a>
<a id="__codelineno-2-217" name="__codelineno-2-217" href="#__codelineno-2-217"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Impute the continuous variable (var_gbm2) &quot;</span><span class="p">)</span>
<a id="__codelineno-2-218" name="__codelineno-2-218" href="#__codelineno-2-218"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   conditional on var_gbm1, using narwhals (nw.col(&#39;var_gbm1&#39;))&quot;</span><span class="p">)</span>
<a id="__codelineno-2-219" name="__codelineno-2-219" href="#__codelineno-2-219"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   as well as a post-processing edit to set var_gbm2=0 when var_gbm1==0&quot;</span><span class="p">)</span>
<a id="__codelineno-2-220" name="__codelineno-2-220" href="#__codelineno-2-220"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   and some other random post-processing&quot;</span><span class="p">)</span>
<a id="__codelineno-2-221" name="__codelineno-2-221" href="#__codelineno-2-221"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Different parameters for the continuous variable&quot;</span><span class="p">)</span>
<a id="__codelineno-2-222" name="__codelineno-2-222" href="#__codelineno-2-222"></a><span class="n">parameters_lgbm2</span> <span class="o">=</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">LightGBM</span><span class="p">(</span>
<a id="__codelineno-2-223" name="__codelineno-2-223" href="#__codelineno-2-223"></a>    <span class="n">tune</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-224" name="__codelineno-2-224" href="#__codelineno-2-224"></a>    <span class="n">tune_hyperparameter_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">data_root</span><span class="si">}</span><span class="s2">/tuner_outputs&quot;</span><span class="p">,</span>
<a id="__codelineno-2-225" name="__codelineno-2-225" href="#__codelineno-2-225"></a>    <span class="n">tuner</span><span class="o">=</span><span class="n">tuner</span><span class="p">,</span>
<a id="__codelineno-2-226" name="__codelineno-2-226" href="#__codelineno-2-226"></a>    <span class="n">tune_overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-227" name="__codelineno-2-227" href="#__codelineno-2-227"></a>    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-2-228" name="__codelineno-2-228" href="#__codelineno-2-228"></a>        <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="s2">&quot;regression&quot;</span><span class="p">,</span>
<a id="__codelineno-2-229" name="__codelineno-2-229" href="#__codelineno-2-229"></a>        <span class="s2">&quot;num_leaves&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-2-230" name="__codelineno-2-230" href="#__codelineno-2-230"></a>        <span class="s2">&quot;min_data_in_leaf&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-2-231" name="__codelineno-2-231" href="#__codelineno-2-231"></a>        <span class="s2">&quot;num_iterations&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-2-232" name="__codelineno-2-232" href="#__codelineno-2-232"></a>        <span class="s2">&quot;test_size&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-2-233" name="__codelineno-2-233" href="#__codelineno-2-233"></a>        <span class="s2">&quot;boosting&quot;</span><span class="p">:</span> <span class="s2">&quot;gbdt&quot;</span><span class="p">,</span>
<a id="__codelineno-2-234" name="__codelineno-2-234" href="#__codelineno-2-234"></a>        <span class="s2">&quot;categorical_feature&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;var5&quot;</span><span class="p">],</span>
<a id="__codelineno-2-235" name="__codelineno-2-235" href="#__codelineno-2-235"></a>        <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># ,</span>
<a id="__codelineno-2-236" name="__codelineno-2-236" href="#__codelineno-2-236"></a>    <span class="p">},</span>
<a id="__codelineno-2-237" name="__codelineno-2-237" href="#__codelineno-2-237"></a>    <span class="n">error</span><span class="o">=</span><span class="n">Parameters</span><span class="o">.</span><span class="n">ErrorDraw</span><span class="o">.</span><span class="n">pmm</span><span class="p">,</span>
<a id="__codelineno-2-238" name="__codelineno-2-238" href="#__codelineno-2-238"></a><span class="p">)</span>
<a id="__codelineno-2-239" name="__codelineno-2-239" href="#__codelineno-2-239"></a>
<a id="__codelineno-2-240" name="__codelineno-2-240" href="#__codelineno-2-240"></a><span class="n">v_gbm2</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
<a id="__codelineno-2-241" name="__codelineno-2-241" href="#__codelineno-2-241"></a>    <span class="n">impute_var</span><span class="o">=</span><span class="s2">&quot;var_gbm2&quot;</span><span class="p">,</span>
<a id="__codelineno-2-242" name="__codelineno-2-242" href="#__codelineno-2-242"></a>    <span class="n">Where</span><span class="o">=</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">),</span>
<a id="__codelineno-2-243" name="__codelineno-2-243" href="#__codelineno-2-243"></a>    <span class="n">model</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;var_*&quot;</span><span class="p">,</span> <span class="s2">&quot;var4&quot;</span><span class="p">,</span> <span class="s2">&quot;var3&quot;</span><span class="p">,</span> <span class="s2">&quot;var5&quot;</span><span class="p">,</span> <span class="s2">&quot;unrelated_*&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat_*&quot;</span><span class="p">],</span>
<a id="__codelineno-2-244" name="__codelineno-2-244" href="#__codelineno-2-244"></a>    <span class="n">modeltype</span><span class="o">=</span><span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">LightGBM</span><span class="p">,</span>
<a id="__codelineno-2-245" name="__codelineno-2-245" href="#__codelineno-2-245"></a>    <span class="n">parameters</span><span class="o">=</span><span class="n">parameters_lgbm2</span><span class="p">,</span>
<a id="__codelineno-2-246" name="__codelineno-2-246" href="#__codelineno-2-246"></a>    <span class="n">postFunctions</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-2-247" name="__codelineno-2-247" href="#__codelineno-2-247"></a>        <span class="p">(</span>
<a id="__codelineno-2-248" name="__codelineno-2-248" href="#__codelineno-2-248"></a>            <span class="n">nw</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">))</span>
<a id="__codelineno-2-249" name="__codelineno-2-249" href="#__codelineno-2-249"></a>            <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_gbm2&quot;</span><span class="p">))</span>
<a id="__codelineno-2-250" name="__codelineno-2-250" href="#__codelineno-2-250"></a>            <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-2-251" name="__codelineno-2-251" href="#__codelineno-2-251"></a>            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;var_gbm2&quot;</span><span class="p">)</span>
<a id="__codelineno-2-252" name="__codelineno-2-252" href="#__codelineno-2-252"></a>        <span class="p">),</span>
<a id="__codelineno-2-253" name="__codelineno-2-253" href="#__codelineno-2-253"></a>        <span class="n">Variable</span><span class="o">.</span><span class="n">PrePost</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
<a id="__codelineno-2-254" name="__codelineno-2-254" href="#__codelineno-2-254"></a>            <span class="n">recalculate_interaction</span><span class="p">,</span>
<a id="__codelineno-2-255" name="__codelineno-2-255" href="#__codelineno-2-255"></a>            <span class="n">parameters</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
<a id="__codelineno-2-256" name="__codelineno-2-256" href="#__codelineno-2-256"></a>                <span class="n">var1</span><span class="o">=</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">,</span>
<a id="__codelineno-2-257" name="__codelineno-2-257" href="#__codelineno-2-257"></a>                <span class="n">var2</span><span class="o">=</span><span class="s2">&quot;var_gbm2&quot;</span><span class="p">,</span>
<a id="__codelineno-2-258" name="__codelineno-2-258" href="#__codelineno-2-258"></a>                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;var_gbm12&quot;</span>
<a id="__codelineno-2-259" name="__codelineno-2-259" href="#__codelineno-2-259"></a>            <span class="p">),</span>
<a id="__codelineno-2-260" name="__codelineno-2-260" href="#__codelineno-2-260"></a>        <span class="p">),</span>
<a id="__codelineno-2-261" name="__codelineno-2-261" href="#__codelineno-2-261"></a>        <span class="n">Variable</span><span class="o">.</span><span class="n">PrePost</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
<a id="__codelineno-2-262" name="__codelineno-2-262" href="#__codelineno-2-262"></a>            <span class="n">square_var</span><span class="p">,</span>
<a id="__codelineno-2-263" name="__codelineno-2-263" href="#__codelineno-2-263"></a>            <span class="n">parameters</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
<a id="__codelineno-2-264" name="__codelineno-2-264" href="#__codelineno-2-264"></a>                <span class="n">var_to_square</span><span class="o">=</span><span class="s2">&quot;var_gbm2&quot;</span><span class="p">,</span> 
<a id="__codelineno-2-265" name="__codelineno-2-265" href="#__codelineno-2-265"></a>                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;var_gbm2_sq&quot;</span>
<a id="__codelineno-2-266" name="__codelineno-2-266" href="#__codelineno-2-266"></a>            <span class="p">)</span>
<a id="__codelineno-2-267" name="__codelineno-2-267" href="#__codelineno-2-267"></a>        <span class="p">),</span>
<a id="__codelineno-2-268" name="__codelineno-2-268" href="#__codelineno-2-268"></a>    <span class="p">]</span>
<a id="__codelineno-2-269" name="__codelineno-2-269" href="#__codelineno-2-269"></a><span class="p">)</span>
<a id="__codelineno-2-270" name="__codelineno-2-270" href="#__codelineno-2-270"></a>
<a id="__codelineno-2-271" name="__codelineno-2-271" href="#__codelineno-2-271"></a><span class="n">vars_impute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_gbm2</span><span class="p">)</span>
<a id="__codelineno-2-272" name="__codelineno-2-272" href="#__codelineno-2-272"></a>
<a id="__codelineno-2-273" name="__codelineno-2-273" href="#__codelineno-2-273"></a>
<a id="__codelineno-2-274" name="__codelineno-2-274" href="#__codelineno-2-274"></a>
<a id="__codelineno-2-275" name="__codelineno-2-275" href="#__codelineno-2-275"></a>
<a id="__codelineno-2-276" name="__codelineno-2-276" href="#__codelineno-2-276"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now do one with the quantile-regression lightgbm&quot;</span><span class="p">)</span>
<a id="__codelineno-2-277" name="__codelineno-2-277" href="#__codelineno-2-277"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   To do this, pass quantiles and set objective=&#39;quantile&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-2-278" name="__codelineno-2-278" href="#__codelineno-2-278"></a><span class="n">parameters_lgbm3</span> <span class="o">=</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">LightGBM</span><span class="p">(</span>
<a id="__codelineno-2-279" name="__codelineno-2-279" href="#__codelineno-2-279"></a>    <span class="n">tune</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-280" name="__codelineno-2-280" href="#__codelineno-2-280"></a>    <span class="n">tune_hyperparameter_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">data_root</span><span class="si">}</span><span class="s2">/tuner_outputs&quot;</span><span class="p">,</span>
<a id="__codelineno-2-281" name="__codelineno-2-281" href="#__codelineno-2-281"></a>    <span class="n">tuner</span><span class="o">=</span><span class="n">tuner</span><span class="p">,</span>
<a id="__codelineno-2-282" name="__codelineno-2-282" href="#__codelineno-2-282"></a>    <span class="n">tune_overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-283" name="__codelineno-2-283" href="#__codelineno-2-283"></a>    <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.75</span><span class="p">],</span>
<a id="__codelineno-2-284" name="__codelineno-2-284" href="#__codelineno-2-284"></a>    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-2-285" name="__codelineno-2-285" href="#__codelineno-2-285"></a>        <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
<a id="__codelineno-2-286" name="__codelineno-2-286" href="#__codelineno-2-286"></a>        <span class="s2">&quot;num_leaves&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-2-287" name="__codelineno-2-287" href="#__codelineno-2-287"></a>        <span class="s2">&quot;min_data_in_leaf&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-2-288" name="__codelineno-2-288" href="#__codelineno-2-288"></a>        <span class="s2">&quot;num_iterations&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-2-289" name="__codelineno-2-289" href="#__codelineno-2-289"></a>        <span class="s2">&quot;test_size&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-2-290" name="__codelineno-2-290" href="#__codelineno-2-290"></a>        <span class="s2">&quot;boosting&quot;</span><span class="p">:</span> <span class="s2">&quot;gbdt&quot;</span><span class="p">,</span>
<a id="__codelineno-2-291" name="__codelineno-2-291" href="#__codelineno-2-291"></a>        <span class="s2">&quot;categorical_feature&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;var5&quot;</span><span class="p">],</span>
<a id="__codelineno-2-292" name="__codelineno-2-292" href="#__codelineno-2-292"></a>        <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># ,</span>
<a id="__codelineno-2-293" name="__codelineno-2-293" href="#__codelineno-2-293"></a>    <span class="p">},</span>
<a id="__codelineno-2-294" name="__codelineno-2-294" href="#__codelineno-2-294"></a>    <span class="n">error</span><span class="o">=</span><span class="n">Parameters</span><span class="o">.</span><span class="n">ErrorDraw</span><span class="o">.</span><span class="n">pmm</span><span class="p">,</span>
<a id="__codelineno-2-295" name="__codelineno-2-295" href="#__codelineno-2-295"></a><span class="p">)</span>
<a id="__codelineno-2-296" name="__codelineno-2-296" href="#__codelineno-2-296"></a>
<a id="__codelineno-2-297" name="__codelineno-2-297" href="#__codelineno-2-297"></a><span class="n">v_gbm3</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
<a id="__codelineno-2-298" name="__codelineno-2-298" href="#__codelineno-2-298"></a>    <span class="n">impute_var</span><span class="o">=</span><span class="s2">&quot;var_gbm3&quot;</span><span class="p">,</span>
<a id="__codelineno-2-299" name="__codelineno-2-299" href="#__codelineno-2-299"></a>    <span class="n">Where</span><span class="o">=</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">),</span>
<a id="__codelineno-2-300" name="__codelineno-2-300" href="#__codelineno-2-300"></a>    <span class="n">model</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;var_*&quot;</span><span class="p">,</span> <span class="s2">&quot;var4&quot;</span><span class="p">,</span> <span class="s2">&quot;var3&quot;</span><span class="p">,</span> <span class="s2">&quot;var5&quot;</span><span class="p">,</span> <span class="s2">&quot;unrelated_*&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat_*&quot;</span><span class="p">],</span>
<a id="__codelineno-2-301" name="__codelineno-2-301" href="#__codelineno-2-301"></a>    <span class="n">modeltype</span><span class="o">=</span><span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">LightGBM</span><span class="p">,</span>
<a id="__codelineno-2-302" name="__codelineno-2-302" href="#__codelineno-2-302"></a>    <span class="n">parameters</span><span class="o">=</span><span class="n">parameters_lgbm3</span>
<a id="__codelineno-2-303" name="__codelineno-2-303" href="#__codelineno-2-303"></a><span class="p">)</span>
<a id="__codelineno-2-304" name="__codelineno-2-304" href="#__codelineno-2-304"></a>
<a id="__codelineno-2-305" name="__codelineno-2-305" href="#__codelineno-2-305"></a><span class="n">vars_impute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_gbm3</span><span class="p">)</span>
<a id="__codelineno-2-306" name="__codelineno-2-306" href="#__codelineno-2-306"></a>
<a id="__codelineno-2-307" name="__codelineno-2-307" href="#__codelineno-2-307"></a>
<a id="__codelineno-2-308" name="__codelineno-2-308" href="#__codelineno-2-308"></a><span class="c1"># %%</span>
<a id="__codelineno-2-309" name="__codelineno-2-309" href="#__codelineno-2-309"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set up the imputation&quot;</span><span class="p">)</span>
<a id="__codelineno-2-310" name="__codelineno-2-310" href="#__codelineno-2-310"></a><span class="n">srmi</span> <span class="o">=</span> <span class="n">SRMI</span><span class="p">(</span>
<a id="__codelineno-2-311" name="__codelineno-2-311" href="#__codelineno-2-311"></a>    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
<a id="__codelineno-2-312" name="__codelineno-2-312" href="#__codelineno-2-312"></a>    <span class="n">variables</span><span class="o">=</span><span class="n">vars_impute</span><span class="p">,</span>
<a id="__codelineno-2-313" name="__codelineno-2-313" href="#__codelineno-2-313"></a>    <span class="n">n_implicates</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-2-314" name="__codelineno-2-314" href="#__codelineno-2-314"></a>    <span class="n">n_iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-2-315" name="__codelineno-2-315" href="#__codelineno-2-315"></a>    <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-2-316" name="__codelineno-2-316" href="#__codelineno-2-316"></a>    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span>
<a id="__codelineno-2-317" name="__codelineno-2-317" href="#__codelineno-2-317"></a>    <span class="n">modeltype</span><span class="o">=</span><span class="n">Variable</span><span class="o">.</span><span class="n">ModelType</span><span class="o">.</span><span class="n">pmm</span><span class="p">,</span>
<a id="__codelineno-2-318" name="__codelineno-2-318" href="#__codelineno-2-318"></a>    <span class="n">bayesian_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-319" name="__codelineno-2-319" href="#__codelineno-2-319"></a>    <span class="n">path_model</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">path_temp_files</span><span class="si">}</span><span class="s2">/py_srmi_test_gbm&quot;</span><span class="p">,</span>
<a id="__codelineno-2-320" name="__codelineno-2-320" href="#__codelineno-2-320"></a>    <span class="n">force_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-321" name="__codelineno-2-321" href="#__codelineno-2-321"></a><span class="p">)</span>
<a id="__codelineno-2-322" name="__codelineno-2-322" href="#__codelineno-2-322"></a>
<a id="__codelineno-2-323" name="__codelineno-2-323" href="#__codelineno-2-323"></a><span class="c1"># %%</span>
<a id="__codelineno-2-324" name="__codelineno-2-324" href="#__codelineno-2-324"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Run it&quot;</span><span class="p">)</span>
<a id="__codelineno-2-325" name="__codelineno-2-325" href="#__codelineno-2-325"></a><span class="n">srmi</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-2-326" name="__codelineno-2-326" href="#__codelineno-2-326"></a>
<a id="__codelineno-2-327" name="__codelineno-2-327" href="#__codelineno-2-327"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;It&#39;s automatically saved and can be loaded with (see path_model above):&quot;</span><span class="p">)</span>
<a id="__codelineno-2-328" name="__codelineno-2-328" href="#__codelineno-2-328"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;path_model = f&#39;</span><span class="si">{config.path_temp_files}</span><span class="s2">/py_srmi_test_gbm&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-2-329" name="__codelineno-2-329" href="#__codelineno-2-329"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;srmi = SRMI.load(path_model)&quot;</span><span class="p">)</span>
<a id="__codelineno-2-330" name="__codelineno-2-330" href="#__codelineno-2-330"></a>
<a id="__codelineno-2-331" name="__codelineno-2-331" href="#__codelineno-2-331"></a>
<a id="__codelineno-2-332" name="__codelineno-2-332" href="#__codelineno-2-332"></a><span class="c1"># %%</span>
<a id="__codelineno-2-333" name="__codelineno-2-333" href="#__codelineno-2-333"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Get the results&quot;</span><span class="p">)</span>
<a id="__codelineno-2-334" name="__codelineno-2-334" href="#__codelineno-2-334"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span> <span class="o">=</span> <span class="n">srmi</span><span class="o">.</span><span class="n">df_implicates</span>
<a id="__codelineno-2-335" name="__codelineno-2-335" href="#__codelineno-2-335"></a>
<a id="__codelineno-2-336" name="__codelineno-2-336" href="#__codelineno-2-336"></a><span class="c1"># %%</span>
<a id="__codelineno-2-337" name="__codelineno-2-337" href="#__codelineno-2-337"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the original&quot;</span><span class="p">)</span>
<a id="__codelineno-2-338" name="__codelineno-2-338" href="#__codelineno-2-338"></a><span class="n">_</span> <span class="o">=</span> <span class="n">summary</span><span class="p">(</span><span class="n">df_original</span><span class="p">,</span><span class="n">detailed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drb_round</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-339" name="__codelineno-2-339" href="#__codelineno-2-339"></a>
<a id="__codelineno-2-340" name="__codelineno-2-340" href="#__codelineno-2-340"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the imputes&quot;</span><span class="p">)</span>
<a id="__codelineno-2-341" name="__codelineno-2-341" href="#__codelineno-2-341"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span><span class="n">detailed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drb_round</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-342" name="__codelineno-2-342" href="#__codelineno-2-342"></a>
<a id="__codelineno-2-343" name="__codelineno-2-343" href="#__codelineno-2-343"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the imputes | var_gbm1 == 0&quot;</span><span class="p">)</span>
<a id="__codelineno-2-344" name="__codelineno-2-344" href="#__codelineno-2-344"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span><span class="n">detailed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drb_round</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-345" name="__codelineno-2-345" href="#__codelineno-2-345"></a>
<a id="__codelineno-2-346" name="__codelineno-2-346" href="#__codelineno-2-346"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Look at the imputes | var_gbm1 == 1&quot;</span><span class="p">)</span>
<a id="__codelineno-2-347" name="__codelineno-2-347" href="#__codelineno-2-347"></a><span class="n">_</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;var_gbm1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span><span class="n">detailed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drb_round</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="../../tutorials/srmi/gbm.html" target="_blank">View in separate window</a>
<iframe src="../../tutorials/srmi/gbm.html" 
    style="width: 100%; height: 800px; border: none;">
</iframe></p>
</div>
</div>
</div>
</div>
</div>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../calibration/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Calibration">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Calibration
              </div>
            </div>
          </a>
        
        
          
          <a href="../statistics/" class="md-footer__link md-footer__link--next" aria-label="Next: Statistics/Standard Errors">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Statistics/Standard Errors
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.annotate", "navigation.footer", "navigation.indexes", "navigation.top"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../javascript/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>